<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Kudos Student Portal - Enhanced with Avatars & XP</title>
    <!-- Enhanced caching control for Chromebooks -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Chromebook compatibility -->
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .logo p {
            color: #666;
            font-size: 1.1em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .error-message {
            background: #ffe6e6;
            color: #d8000c;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
            border-left: 4px solid #d8000c;
        }
        
        .dashboard {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .dashboard-columns {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }
        
        .dashboard-left {
            flex: 2;
            min-width: 0;
        }
        
        .dashboard-right {
            flex: 1;
            min-width: 300px;
        }
        
        @media (max-width: 768px) {
            .dashboard-columns {
                flex-direction: column;
            }
            .dashboard-right {
                min-width: 0;
            }
        }
        
        .student-profile {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .avatar-container {
            position: relative;
        }
        
        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s;
            overflow: hidden;
        }
        
        .avatar:hover {
            transform: scale(1.1);
        }
        
        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .level-badge {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: #28a745;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
            border: 3px solid white;
        }
        
        .edit-avatar-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        
        .edit-avatar-btn:hover {
            background: #218838;
        }
        
        .student-info h2 {
            color: #333;
            font-size: 1.8em;
            margin-bottom: 5px;
        }
        
        .student-meta {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 20px;
        }
        
        .student-code {
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-weight: bold;
            color: #667eea;
        }
        
        .xp-progress {
            margin-top: 15px;
        }
        
        .xp-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .xp-fill {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
        }
        
        .xp-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 25%, rgba(255,255,255,0.2) 25%, rgba(255,255,255,0.2) 50%, transparent 50%, transparent 75%, rgba(255,255,255,0.2) 75%);
            background-size: 20px 20px;
            animation: xpShine 2s linear infinite;
        }
        
        @keyframes xpShine {
            0% { background-position: -20px 0; }
            100% { background-position: 20px 0; }
        }
        
        .xp-text {
            font-size: 0.9em;
            color: #666;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h4 {
            font-size: 2.5em;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .stat-card p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        /* Badge Collection Styles */
        .badge-collection {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            background-clip: padding-box;
        }
        
        .badge-collection h3 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 1.4em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .badge-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .achievement-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 10px;
            border-radius: 12px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.3);
            transition: all 0.3s ease;
            border: 3px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .achievement-badge:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 12px 30px rgba(255, 215, 0, 0.5);
        }
        
        .achievement-badge.locked {
            background: linear-gradient(135deg, #ccc 0%, #999 100%);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            opacity: 0.6;
        }
        
        .badge-icon {
            font-size: 2em;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .badge-level {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        .badge-title {
            font-size: 0.7em;
            color: #333;
            text-align: center;
            margin-top: 5px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        .navigation {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            margin-bottom: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .nav-menu {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .nav-item {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .nav-item:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .nav-item.active {
            background: #764ba2;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Avatar Selection Modal */
        .avatar-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .avatar-modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .avatar-modal h3 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 1.8em;
        }
        
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .avatar-option {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 3px solid transparent;
            font-size: 4em;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .avatar-option:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .avatar-option.selected {
            border-color: #28a745;
            transform: scale(1.1);
        }
        
        .avatar-option.locked {
            cursor: not-allowed;
            border-color: #666;
        }
        
        .avatar-option.locked:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(255, 152, 0, 0.4);
        }
        
        /* Modal Header */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.8em;
            color: #333;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            background: #f0f0f0;
            color: #666;
        }
        
        /* Tab Navigation */
        .avatar-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 25px;
        }
        
        .tab-button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-button:hover {
            background: #f8f9fa;
            color: #333;
        }
        
        .tab-button.active {
            color: #4CAF50;
            border-bottom-color: #4CAF50;
            background: #f8fcf9;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Avatar Categories */
        .avatar-categories {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .avatar-category {
            margin-bottom: 30px;
        }
        
        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .category-header.locked {
            background: linear-gradient(135deg, #FF9800 0%, #FF5722 100%);
        }
        
        .category-title {
            font-size: 16px;
        }
        
        .category-progress {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 12px;
            padding: 0 10px;
        }
        
        .avatar-option {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
        }
        
        .avatar-option img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .modal-btn.primary {
            background: #28a745;
            color: white;
        }
        
        .modal-btn.primary:hover {
            background: #218838;
        }
        
        .modal-btn.secondary {
            background: #6c757d;
            color: white;
        }
        
        .modal-btn.secondary:hover {
            background: #545b62;
        }
        
        /* Live Kudos Feed */
        .kudos-feed {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .kudos-feed h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .refresh-btn {
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .refresh-btn:hover {
            background: #138496;
        }
        
        .kudos-item {
            background: #f8f9fa;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .kudos-item.new {
            border-left-color: #ffc107;
            background: #fff3cd;
            animation: pulse 2s ease-in-out;
        }
        
        @keyframes pulse {
            0%, 100% { background: #fff3cd; }
            50% { background: #ffeaa7; }
        }
        
        .kudos-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .kudos-points {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .kudos-date {
            color: #666;
            font-size: 0.9em;
        }
        
        .kudos-reason {
            color: #333;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .kudos-description {
            color: #666;
            font-size: 0.9em;
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .level-up-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 50%, #45B7D1 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            z-index: 2000;
            animation: levelUpEpic 4s ease-in-out;
            display: none;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 3px solid #FFD700;
        }
        
        @keyframes levelUpEpic {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.3) rotate(-10deg); }
            15% { opacity: 1; transform: translate(-50%, -50%) scale(1.3) rotate(5deg); }
            30% { transform: translate(-50%, -50%) scale(0.9) rotate(-2deg); }
            45% { transform: translate(-50%, -50%) scale(1.1) rotate(1deg); }
            60% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
            90% { opacity: 1; transform: translate(-50%, -50%) scale(1) rotate(0deg); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8) rotate(0deg); }
        }
        
        .level-up-content {
            position: relative;
        }
        
        .level-up-badge {
            background: #FFD700;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
            border: 3px solid #FFF;
            animation: badgeSpin 4s ease-in-out;
        }
        
        @keyframes badgeSpin {
            0% { transform: rotate(0deg) scale(0.5); }
            25% { transform: rotate(180deg) scale(1.2); }
            50% { transform: rotate(360deg) scale(1); }
            75% { transform: rotate(540deg) scale(1.1); }
            100% { transform: rotate(720deg) scale(1); }
        }
        
        .level-up-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .level-up-notification h2 {
            font-size: 2.5em;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            animation: textBounce 2s ease-in-out infinite;
        }
        
        @keyframes textBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .level-up-message {
            font-size: 1.8em;
            font-weight: bold;
            margin: 15px 0 5px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .level-up-subtitle {
            font-size: 1.3em;
            margin: 5px 0 20px;
            opacity: 0.9;
        }
        
        .level-up-achievement {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            animation: achievementGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes achievementGlow {
            0% { box-shadow: 0 0 10px rgba(255, 255, 255, 0.3); }
            100% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.6); }
        }
        
        .avatar-unlock-notification {
            background: linear-gradient(45deg, #FF6B35, #FF8E53);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            color: white;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
            animation: avatarUnlockPulse 2s infinite;
        }
        
        @keyframes avatarUnlockPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .achievement-icon {
            font-size: 2em;
            margin-right: 10px;
        }
        
        .achievement-text {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        /* Add main app emoji avatar styling for consistency */
        .emoji-avatar-leaderboard {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-family: 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', sans-serif;
            margin-right: 15px;
        }
        
        /* Kudos Colosseum Styles */
        .challenge-btn, .difficulty-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            margin: 10px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            min-width: 200px;
        }
        
        .challenge-btn:hover, .difficulty-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .challenge-btn:active, .difficulty-btn:active {
            transform: translateY(0);
        }
        
        #gameArea {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        #answerInput {
            border: 3px solid #667eea;
            border-radius: 10px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        #answerInput:focus {
            border-color: #764ba2;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }
        
        .correct-feedback {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .incorrect-feedback {
            color: #f44336;
            font-weight: bold;
        }
        
        .academic-choice {
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .academic-choice:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            background: #f0f8ff !important;
            border-color: #667eea !important;
        }
        
        .academic-choice:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }
        
        .hidden {
            display: none;
        }
        
        /* Achievement notification animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="loginSection" class="container">
        <div class="login-container">
            <div class="logo">
                <h1>🎓 Class Kudos</h1>
                <p>Student Portal Enhanced</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="classCode">Class Code</label>
                    <input type="text" id="classCode" placeholder="Enter your class code" required>
                </div>
                
                <div class="form-group">
                    <label for="studentCode">Student Code (4 digits)</label>
                    <input type="text" id="studentCode" placeholder="0000" maxlength="4" required>
                </div>
                
                <button type="submit" id="loginBtn" class="login-btn">Login to Portal</button>
                
                <div id="errorMessage" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboardSection" class="container hidden">
        <!-- Navigation -->
        <div class="navigation">
            <div class="nav-menu">
                <button class="nav-item active" onclick="showSection('dashboard')">Dashboard</button>
                <button class="nav-item" onclick="showSection('myKudos')">My Kudos</button>
                <button class="nav-item" onclick="showSection('leaderboard')">Leaderboard</button>
                <button class="nav-item" onclick="showSection('kudosColosseum')">🏛️ Kudos Colosseum</button>
                <button class="nav-item" onclick="showSection('morphemeMastery')">📚 Morpheme Mastery</button>
                <div id="connection-status" style="color: #4CAF50; font-size: 12px; margin: 0 10px; display: flex; align-items: center;">
                    🟢 Connected
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard" class="content-section active">
            <div class="dashboard">
                <div class="dashboard-columns">
                    <div class="dashboard-left">
                        <div class="student-profile">
                            <div class="avatar-container">
                                <div class="avatar" id="studentAvatar" onclick="openAvatarModal()">
                                    <img id="avatarDisplay" src="https://api.dicebear.com/7.x/adventurer/svg?seed=happy" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                                </div>
                                <div class="level-badge" id="levelBadge">1</div>
                            </div>
                            
                            <div class="student-info">
                                <h2 id="studentName" onclick="handleStudentNameClick()" style="cursor: pointer;">Loading...</h2>
                                <div class="student-meta">
                                    Class: <strong id="studentClass">-</strong> • 
                                    Student Code: <span class="student-code" id="displayStudentCode">-</span>
                                </div>
                                <button class="edit-avatar-btn" onclick="openAvatarModal()">
                                    🎨 Customize Avatar
                                </button>
                                
                                <div class="xp-progress">
                                    <div class="xp-bar">
                                        <div class="xp-fill" id="xpBar" style="width: 0%"></div>
                                    </div>
                                    <div class="xp-text" id="xpText">XP: 0 / 100 (Level 1)</div>
                                </div>
                            </div>
                        </div>

                        <div class="stats-grid">
                            <div class="stat-card">
                                <h4 id="totalKudos">0</h4>
                                <p>Total Points</p>
                            </div>
                            <div class="stat-card">
                                <h4 id="classRank">#-</h4>
                                <p>Class Rank</p>
                            </div>
                            <div class="stat-card">
                                <h4 id="recentKudos">0</h4>
                                <p>This Week</p>
                            </div>
                            <div class="stat-card">
                                <h4 id="studentLevel">1</h4>
                                <p>Level</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-right">
                        <div class="badge-collection">
                            <h3>🏆 My Achievements</h3>
                            <div class="badge-grid" id="badgeGrid">
                                <!-- Badges will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Dashboard Customization -->
                        <div class="customization-panel" style="
                            background: white;
                            border-radius: 12px;
                            padding: 20px;
                            margin-top: 20px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            border: 1px solid #e9ecef;
                        ">
                            <div id="themeCustomization">
                                <!-- Theme selector populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Recent Game Achievements -->
                        <div class="achievements-panel" style="
                            background: white;
                            border-radius: 12px;
                            padding: 20px;
                            margin-top: 20px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            border: 1px solid #e9ecef;
                        ">
                            <h4 style="margin: 0 0 15px 0; color: #333;">🎮 Recent Game Achievements</h4>
                            <div id="recentAchievements">
                                <!-- Game achievements populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Kudos Content -->
        <div id="myKudos" class="content-section">
            <div class="kudos-feed">
                <h3>
                    🏆 Recent Achievements 
                    <button class="refresh-btn" onclick="loadStudentKudos()" title="Refresh">
                        ↻
                    </button>
                </h3>
                <div id="kudosList">
                    <p style="text-align: center; color: #666;">Loading your achievements...</p>
                </div>
            </div>
        </div>

        <!-- Leaderboard Content -->
        <div id="leaderboard" class="content-section">
            <div class="dashboard">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h3 style="margin: 0;">🏅 Class Leaderboard</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="loadLeaderboard(0)" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            🔄 Refresh
                        </button>
                    </div>
                </div>
                <div id="leaderboardList">
                    <p style="text-align: center; color: #666;">Loading leaderboard...</p>
                </div>
            </div>
        </div>

        <!-- Kudos Colosseum Content -->
        <div id="kudosColosseum" class="content-section">
            <div class="dashboard">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>🏛️ Kudos Colosseum - Academic Arena</h3>
                    <div>
                        <button id="audioToggle" onclick="toggleAudio()" style="background: #667eea; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            🔊 Audio On
                        </button>
                        <button onclick="showAchievements()" style="background: #FFD700; color: black; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                            🏆 Achievements
                        </button>
                    </div>
                </div>
                
                <div id="colosseumContent">
                    <!-- Game Selection Menu -->
                    <div id="gameSelectionMenu" style="text-align: center; padding: 20px;">
                        <h4>⚔️ Choose Your Academic Arena</h4>
                        <p>Master different subjects and earn XP!</p>
                        
                        <div class="game-selection-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 30px 0;">
                            
                            <!-- Math Arena -->
                            <div class="game-card" onclick="selectGameType('math')" style="
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white; padding: 25px; border-radius: 15px; cursor: pointer;
                                transition: transform 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                            ">
                                <div style="font-size: 3em; margin-bottom: 10px;">🔢</div>
                                <h3>Math Arena</h3>
                                <p>Multiplication, Division & Mixed Combat</p>
                                <div style="font-size: 0.9em; opacity: 0.8;">⚡ 5-20 XP per game</div>
                            </div>

                            <!-- Word Wizard -->
                            <div class="game-card" onclick="selectGameType('vocabulary')" style="
                                background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
                                color: white; padding: 25px; border-radius: 15px; cursor: pointer;
                                transition: transform 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                            ">
                                <div style="font-size: 3em; margin-bottom: 10px;">📚</div>
                                <h3>Word Wizard</h3>
                                <p>Vocabulary, Spelling & Definitions</p>
                                <div style="font-size: 0.9em; opacity: 0.8;">⚡ 5-25 XP per game</div>
                            </div>

                            <!-- Speed Reader -->
                            <div class="game-card" onclick="selectGameType('reading')" style="
                                background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%);
                                color: white; padding: 25px; border-radius: 15px; cursor: pointer;
                                transition: transform 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                            ">
                                <div style="font-size: 3em; margin-bottom: 10px;">👁️</div>
                                <h3>Speed Reader</h3>
                                <p>Reading Comprehension & Speed</p>
                                <div style="font-size: 0.9em; opacity: 0.8;">⚡ 10-30 XP per game</div>
                            </div>

                            <!-- Science Lab -->
                            <div class="game-card" onclick="selectGameType('science')" style="
                                background: linear-gradient(135deg, #8360c3 0%, #2ebf91 100%);
                                color: white; padding: 25px; border-radius: 15px; cursor: pointer;
                                transition: transform 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                            ">
                                <div style="font-size: 3em; margin-bottom: 10px;">🔬</div>
                                <h3>Science Lab</h3>
                                <p>Biology, Chemistry & Physics</p>
                                <div style="font-size: 0.9em; opacity: 0.8;">⚡ 8-25 XP per game</div>
                            </div>

                            <!-- Geography Quest -->
                            <div class="game-card" onclick="selectGameType('geography')" style="
                                background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
                                color: white; padding: 25px; border-radius: 15px; cursor: pointer;
                                transition: transform 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                            ">
                                <div style="font-size: 3em; margin-bottom: 10px;">🌍</div>
                                <h3>Geography Quest</h3>
                                <p>Countries, Capitals & Landmarks</p>
                                <div style="font-size: 0.9em; opacity: 0.8;">⚡ 5-20 XP per game</div>
                            </div>

                            <!-- History Hunter -->
                            <div class="game-card" onclick="selectGameType('history')" style="
                                background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
                                color: #333; padding: 25px; border-radius: 15px; cursor: pointer;
                                transition: transform 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                            ">
                                <div style="font-size: 3em; margin-bottom: 10px;">🏛️</div>
                                <h3>History Hunter</h3>
                                <p>Dates, Events & Famous People</p>
                                <div style="font-size: 0.9em; opacity: 0.7;">⚡ 8-22 XP per game</div>
                            </div>

                        </div>
                    </div>

                    <!-- Challenge Selection (for specific game types) -->
                    <div id="challengeSelection" class="hidden" style="text-align: center; padding: 20px;">
                        <button onclick="backToGameSelection()" style="float: left; background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                            ← Back
                        </button>
                        <h4 id="challengeTitle">⚔️ Choose Your Challenge</h4>
                        <div id="challengeOptions" style="margin: 20px 0;">
                            <!-- Dynamic challenge options will be inserted here -->
                        </div>
                        
                        <div id="difficultySelector" class="hidden" style="margin: 20px 0;">
                            <h4 id="difficultyTitle">Choose Difficulty</h4>
                            <div id="difficultyOptions" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                <!-- Dynamic difficulty options will be inserted here -->
                            </div>
                        </div>
                    </div>
                        
                        <div id="gameArea" class="hidden">
                            <div id="gameStats" style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                                <span>Score: <span id="currentScore">0</span></span>
                                <span>Time: <span id="timeLeft">60</span>s</span>
                                <span>Streak: <span id="streak">0</span></span>
                            </div>
                            
                            <div id="problemArea" style="font-size: 2em; margin: 30px 0;">
                                <span id="problem">3 × 7 = ?</span>
                            </div>
                            
                            <div id="answerArea">
                                <!-- Multiple choice buttons will be inserted here -->
                                <div id="choicesContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 600px; margin: 0 auto;">
                                    <!-- Dynamic multiple choice options will be inserted here -->
                                </div>
                                
                                <!-- Fallback input for math problems that need exact answers -->
                                <div id="inputFallback" class="hidden" style="margin-top: 20px;">
                                    <input type="number" id="answerInput" placeholder="Your answer..." style="font-size: 1.5em; padding: 10px; text-align: center;">
                                    <button onclick="submitAnswer()" style="font-size: 1.2em; padding: 10px 20px; margin-left: 10px;">Submit</button>
                                </div>
                            </div>
                            
                            <div id="feedback" style="margin-top: 20px; font-size: 1.2em;"></div>
                        </div>
                        
                        <div id="gameResults" class="hidden">
                            <h4>🎉 Battle Complete!</h4>
                            <div id="resultsDisplay"></div>
                            <button onclick="resetGame()">Return to Arena</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Morpheme Mastery Section -->
        <div id="morphemeMastery" class="content-section">
            <h2>📚 Morpheme Mastery</h2>
            
            <div id="morphemeContent">
                <div style="text-align: center; padding: 40px;">
                    <h4>🧠 Choose Your Challenge</h4>
                    <p>Master prefixes, suffixes, and root words to build vocabulary!</p>
                    
                    <div class="morpheme-selection" style="margin: 20px 0;">
                        <button class="challenge-btn" onclick="startMorphemeChallenge('prefixes')">
                            🔤 Prefix Challenge
                        </button>
                        <button class="challenge-btn" onclick="startMorphemeChallenge('suffixes')">
                            🔤 Suffix Challenge
                        </button>
                        <button class="challenge-btn" onclick="startMorphemeChallenge('latin')">
                            🏛️ Latin Roots
                        </button>
                        <button class="challenge-btn" onclick="startMorphemeChallenge('greek')">
                            🇬🇷 Greek Roots
                        </button>
                        <button class="challenge-btn" onclick="startMorphemeChallenge('mixed')">
                            🎯 Mixed Challenge
                        </button>
                    </div>
                    
                    <div id="morphemeDifficultySelector" class="hidden" style="margin: 20px 0;">
                        <h4 id="morphemeDifficultyTitle">Choose Difficulty</h4>
                        <div id="morphemeDifficultyOptions" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <!-- Dynamic difficulty options will be inserted here -->
                        </div>
                    </div>
                    
                    <div id="morphemeGameArea" class="hidden">
                        <div id="morphemeGameStats" style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                            <span>Score: <span id="morphemeCurrentScore">0</span></span>
                            <span>Time: <span id="morphemeTimeLeft">60</span>s</span>
                            <span>Streak: <span id="morphemeStreak">0</span></span>
                        </div>
                        
                        <div id="morphemeQuestionArea" style="margin: 30px 0;">
                            <div id="morphemeQuestion" style="font-size: 1.5em; margin-bottom: 20px; text-align: center;"></div>
                            <div id="morphemeChoices" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 600px; margin: 0 auto;">
                                <!-- Multiple choice options will be inserted here -->
                            </div>
                        </div>
                        
                        <div id="morphemeFeedback" style="text-align: center; margin: 20px 0; font-size: 1.2em;"></div>
                    </div>
                    
                    <div id="morphemeGameResults" class="hidden">
                        <h4>🎉 Challenge Complete!</h4>
                        <div id="morphemeResultsDisplay"></div>
                        <button onclick="resetMorphemeGame()">Return to Challenges</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Avatar Selection Modal -->
    <div id="avatarModal" class="avatar-modal">
        <div class="avatar-modal-content">
            <div class="modal-header">
                <h3>🎨 Choose Your Avatar</h3>
                <button class="modal-close" onclick="closeAvatarModal()">×</button>
            </div>
            
            <!-- Tab Navigation -->
            <div class="avatar-tabs">
                <button class="tab-button active" onclick="switchAvatarTab('available')">
                    ✅ Available
                </button>
                <button class="tab-button" onclick="switchAvatarTab('coming-soon')">
                    🔒 Coming Soon
                </button>
            </div>
            
            <!-- Tab Content -->
            <div id="availableTab" class="tab-content active">
                <div class="avatar-categories" id="availableCategories">
                    <!-- Available avatars will be populated here -->
                </div>
            </div>
            
            <div id="comingSoonTab" class="tab-content">
                <div class="avatar-categories" id="comingSoonCategories">
                    <!-- Locked avatars will be populated here -->
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="saveSelectedAvatar()">Save Avatar</button>
                <button class="modal-btn secondary" onclick="closeAvatarModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Level Up Notification -->
    <div id="levelUpNotification" class="level-up-notification">
        <!-- Content will be dynamically generated -->
    </div>

    <!-- Achievements Modal -->
    <div id="achievementsModal" class="avatar-modal" style="display: none;">
        <div class="avatar-modal-content">
            <div class="modal-header">
                <h3>🏆 Colosseum Achievements</h3>
                <button class="modal-close" onclick="closeAchievementsModal()">×</button>
            </div>
            
            <div id="achievementsContent" style="max-height: 400px; overflow-y: auto; padding: 20px;">
                <!-- Achievements will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        // IMMEDIATE DIAGNOSTIC SETUP - Disabled for student use
        /*
        window.addEventListener('load', function() {
            console.log('🔍 PAGE LOADED: Setting up visible diagnostics');
            setupVisibleDiagnostics();
        });
        */
        
        // VISIBLE DIAGNOSTIC SYSTEM - Shows on screen without console
        let diagnosticDiv = null;
        let timeoutCounter = 0;
        
        // VISIBLE DIAGNOSTIC FUNCTIONS - Disabled for student use
        // Create no-op function to prevent errors
        function logVisible(message) {
            // Disabled for production - no visible diagnostics for students
        }
        
        /*
        function setupVisibleDiagnostics() {
            // Create floating diagnostic display
            diagnosticDiv = document.createElement('div');
            diagnosticDiv.id = 'visibleDiagnostic';
            diagnosticDiv.style.cssText = `
                position: fixed; top: 10px; right: 10px; 
                background: #1a1a1a; color: #00ff00; 
                padding: 8px; border-radius: 4px; 
                font-family: monospace; font-size: 10px; 
                max-width: 250px; max-height: 150px; 
                overflow-y: auto; z-index: 10000;
                border: 1px solid #00ff00; display: none;
            `;
            document.body.appendChild(diagnosticDiv);
            
            logVisible('✅ Diagnostic system ready');
            
            // Set up emergency timeout watcher
            setInterval(checkForStuckLeaderboard, 2000); // Check every 2 seconds
        }
        
        function logVisible(message) {
            if (!diagnosticDiv) return;
            const timestamp = new Date().toLocaleTimeString();
            diagnosticDiv.innerHTML += `<div>${timestamp}: ${message}</div>`;
            diagnosticDiv.scrollTop = diagnosticDiv.scrollHeight;
            diagnosticDiv.style.display = 'block'; // Make visible when there's content
            console.log(message);
        }
        */
        
        function checkForStuckLeaderboard() {
            const leaderboardList = document.getElementById('leaderboardList');
            if (!leaderboardList) return;
            
            const content = leaderboardList.innerHTML;
            if (content.includes('Loading leaderboard') || content.includes('📊 Loading')) {
                timeoutCounter++;
                logVisible(`⏱️ Loading detected (${timeoutCounter * 2}s)`);
                
                if (timeoutCounter >= 5) { // 10 seconds
                    logVisible('🚨 EMERGENCY: Forcing error display');
                    showEmergencyError();
                    timeoutCounter = 0;
                }
            } else {
                timeoutCounter = 0; // Reset if not loading
            }
        }
        
        function showEmergencyError() {
            const leaderboardList = document.getElementById('leaderboardList');
            if (!leaderboardList) return;
            
            leaderboardList.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #fff; background: #dc3545; border-radius: 8px; margin: 10px; border: 3px solid #fff;">
                    <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 15px;">🚨 EMERGENCY TIMEOUT</div>
                    <div style="margin-bottom: 15px;">The leaderboard has been loading for over 10 seconds</div>
                    
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 6px; margin: 15px 0; text-align: left; font-size: 13px;">
                        <strong>📋 COPY THIS TO YOUR TEACHER:</strong><br>
                        <div style="font-family: monospace; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; margin-top: 8px; color: #fff; border: 1px solid #fff;">
                            Student: ${currentStudent?.name || 'Unknown'}<br>
                            Class: ${currentClass || 'Unknown'}<br>
                            Error: Emergency timeout (10+ seconds)<br>
                            Time: ${new Date().toLocaleString()}<br>
                            Browser: Chrome ${navigator.userAgent.split('Chrome/')[1]?.split(' ')[0] || 'Unknown'}
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px;">
                        <button onclick="window.location.reload()" style="
                            background: #28a745; color: white; border: 2px solid white; padding: 12px 20px; 
                            border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;
                        ">🔄 REFRESH PAGE</button>
                        
                        <button onclick="localStorage.clear(); sessionStorage.clear(); window.location.reload();" style="
                            background: #ffc107; color: black; border: 2px solid white; padding: 12px 20px; 
                            border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;
                        ">🗑️ CLEAR DATA</button>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 12px;">
                        💡 Try refreshing first. If that doesn't work, try "Clear Data" button.
                    </div>
                </div>
            `;
        }

        let currentStudent = null;
        let currentClass = null;
        let currentStudentCode = null;
        let selectedAvatar = 'happy';
        let currentXP = 0;
        let currentLevel = 1;
        let lastKudosCount = 0;

        // Enhanced error logging for Chromebook diagnostics
        function logError(context, error, additionalData = {}) {
            const errorInfo = {
                context: context,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                online: navigator.onLine,
                connection: navigator.connection ? {
                    effectiveType: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink,
                    rtt: navigator.connection.rtt
                } : 'unknown',
                error: {
                    message: error.message || error,
                    name: error.name,
                    stack: error.stack,
                    toString: error.toString()
                },
                url: window.location.href,
                studentData: {
                    currentStudent: currentStudent,
                    currentClass: currentClass,
                    currentLevel: currentLevel
                },
                ...additionalData
            };
            
            console.error(`[${context}] Enhanced Error Log:`, errorInfo);
            
            // Check if this is a Chromebook
            const isChromebook = /\bCrOS\b/.test(navigator.userAgent);
            if (isChromebook) {
                console.warn('🔍 CHROMEBOOK DETECTED - This error occurred on a Chromebook device');
            }
            
            return errorInfo;
        }

        // Global error handler for unhandled errors
        window.addEventListener('error', function(event) {
            logError('Global Error Handler', event.error, {
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno
            });
        });

        // Global handler for unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            logError('Unhandled Promise Rejection', event.reason);
        });

        // Avatar options using Dicebear seeds for variety
        // Avatar System with Level-Based Unlocks - EVERY LEVEL HAS REWARDS!
        const avatarsByLevel = {
            1: { category: "🎬 Getting Started", avatars: ['happy', 'cheerful', 'smile'] },
            2: { category: "😊 Smile Squad", avatars: ['joy', 'bright', 'sunny'] },
            3: { category: "🦸 Hero Squad", avatars: ['superhero', 'super-student', 'captain-awesome'] },
            4: { category: "🐶 Cute Animals", avatars: [createAvatarData('fun-emoji', '🐶'), createAvatarData('fun-emoji', '🐱'), createAvatarData('fun-emoji', '🐭')] },
            5: { category: "🤖 Robot Kingdom", avatars: [createAvatarData('bottts', 'cyber-warrior'), createAvatarData('bottts', 'mecha-guardian'), createAvatarData('bottts', 'robo-explorer')] },
            6: { category: "🦊 Forest Friends", avatars: [createAvatarData('fun-emoji', '🦊'), createAvatarData('fun-emoji', '🐻'), createAvatarData('fun-emoji', '🐼')] },
            7: { category: "🌟 Shining Stars", avatars: ['star-bright', 'cosmic-wonder', 'stellar-dream'] },
            8: { category: "🤖 Cyber Legends", avatars: [createAvatarData('bottts', 'quantum-bot'), createAvatarData('bottts', 'plasma-droid'), createAvatarData('bottts', 'stellar-mech')] },
            9: { category: "🐧 Arctic Animals", avatars: [createAvatarData('fun-emoji', '🐧'), createAvatarData('fun-emoji', '🦭'), createAvatarData('fun-emoji', '🐻‍❄️')] },
            10: { category: "🚀 Space Explorers", avatars: [createAvatarData('adventurer', 'astronaut-alpha'), createAvatarData('adventurer', 'space-ranger'), createAvatarData('adventurer', 'galaxy-pilot')] },
            11: { category: "🦁 Safari Squad", avatars: [createAvatarData('fun-emoji', '🦁'), createAvatarData('fun-emoji', '🐯'), createAvatarData('fun-emoji', '🐘')] },
            12: { category: "🎮 Pixel Masters", avatars: [createAvatarData('pixel-art', 'pixel-warrior'), createAvatarData('pixel-art', 'pixel-mage'), createAvatarData('pixel-art', 'pixel-rogue')] },
            13: { category: "🐦 Flying Friends", avatars: [createAvatarData('fun-emoji', '🐦'), createAvatarData('fun-emoji', '🦅'), createAvatarData('fun-emoji', '🦉')] },
            14: { category: "💎 Gem Collectors", avatars: ['diamond-heart', 'ruby-soul', 'emerald-mind'] },
            15: { category: "🐉 Mythical Beings", avatars: [createAvatarData('avataaars', 'dragon-sage'), createAvatarData('avataaars', 'phoenix-rising'), createAvatarData('avataaars', 'unicorn-spirit')] },
            16: { category: "🐢 Ocean Creatures", avatars: [createAvatarData('fun-emoji', '🐢'), createAvatarData('fun-emoji', '🐙'), createAvatarData('fun-emoji', '🐠')] },
            17: { category: "⚡ Lightning Lords", avatars: ['thunder-master', 'storm-bringer', 'lightning-sage'] },
            18: { category: "🔷 Abstract Artists", avatars: [createAvatarData('shapes', 'geometric-master'), createAvatarData('shapes', 'triangle-titan'), createAvatarData('shapes', 'circle-sage')] },
            19: { category: "🐨 Koala Kingdom", avatars: [createAvatarData('fun-emoji', '🐨'), createAvatarData('fun-emoji', '🦘'), createAvatarData('fun-emoji', '🦌')] },
            20: { category: "👀 Big Eyes Club", avatars: [createAvatarData('big-eyes', 'starry-eyes'), createAvatarData('big-eyes', 'rainbow-eyes'), createAvatarData('big-eyes', 'cosmic-eyes')] },
            21: { category: "🐝 Buzzing Buddies", avatars: [createAvatarData('fun-emoji', '🐝'), createAvatarData('fun-emoji', '🦋'), createAvatarData('fun-emoji', '🐞')] },
            22: { category: "🏆 Trophy Hunters", avatars: ['gold-medal', 'silver-crown', 'bronze-star'] },
            23: { category: "🦓 Striped Squad", avatars: [createAvatarData('fun-emoji', '🦓'), createAvatarData('fun-emoji', '🦒'), createAvatarData('fun-emoji', '🐆')] },
            24: { category: "🌸 Flower Power", avatars: ['cherry-blossom', 'sunflower-soul', 'rose-heart'] },
            25: { category: "👥 Mini Heroes", avatars: [createAvatarData('miniavs', 'mini-hero'), createAvatarData('miniavs', 'mini-wizard'), createAvatarData('miniavs', 'mini-knight')] },
            26: { category: "🐍 Slithering Squad", avatars: [createAvatarData('fun-emoji', '🐍'), createAvatarData('fun-emoji', '🦎'), createAvatarData('fun-emoji', '🐸')] },
            27: { category: "🌙 Moon Masters", avatars: ['lunar-guardian', 'crescent-keeper', 'eclipse-sage'] },
            28: { category: "🦀 Crab Crew", avatars: [createAvatarData('fun-emoji', '🦀'), createAvatarData('fun-emoji', '🦞'), createAvatarData('fun-emoji', '🦐')] },
            29: { category: "🔥 Fire Spirits", avatars: ['flame-dancer', 'inferno-master', 'ember-soul'] },
            30: { category: "📚 Scholarly Personas", avatars: [createAvatarData('personas', 'scholar-supreme'), createAvatarData('personas', 'wisdom-keeper'), createAvatarData('personas', 'knowledge-master')] },
            31: { category: "🐿️ Woodland Creatures", avatars: [createAvatarData('fun-emoji', '🐿️'), createAvatarData('fun-emoji', '🦔'), createAvatarData('fun-emoji', '🐇')] },
            32: { category: "⭐ Celestial Stars", avatars: ['nova-burst', 'supernova-glory', 'galaxy-spiral'] },
            33: { category: "🐺 Wolf Pack", avatars: [createAvatarData('fun-emoji', '🐺'), createAvatarData('fun-emoji', '🦮'), createAvatarData('fun-emoji', '🐕‍🦺')] },
            34: { category: "🌊 Ocean Waves", avatars: ['tsunami-force', 'tidal-master', 'wave-rider'] },
            35: { category: "📝 Letter Lords", avatars: [createAvatarData('initials', 'letter-lord'), createAvatarData('initials', 'alphabet-ace'), createAvatarData('initials', 'word-wizard')] },
            36: { category: "🐎 Galloping Gang", avatars: [createAvatarData('fun-emoji', '🐎'), createAvatarData('fun-emoji', '🦄'), createAvatarData('fun-emoji', '🐴')] },
            37: { category: "❄️ Ice Crystals", avatars: ['frost-guardian', 'ice-shard', 'crystal-freeze'] },
            38: { category: "🐪 Desert Dwellers", avatars: [createAvatarData('fun-emoji', '🐪'), createAvatarData('fun-emoji', '🦏'), createAvatarData('fun-emoji', '🐫')] },
            39: { category: "🌈 Rainbow Warriors", avatars: ['rainbow-bridge', 'prism-light', 'spectrum-master'] },
            40: { category: "👋 Gesture Masters", avatars: [createAvatarData('thumbs', 'thumbs-champion'), createAvatarData('thumbs', 'gesture-guru'), createAvatarData('thumbs', 'hand-hero')] },
            41: { category: "🐊 Reptile Rulers", avatars: [createAvatarData('fun-emoji', '🐊'), createAvatarData('fun-emoji', '🐲'), createAvatarData('fun-emoji', '🦕')] },
            42: { category: "💫 Cosmic Dust", avatars: ['stardust-swirl', 'cosmic-mist', 'nebula-cloud'] },
            43: { category: "🦌 Gentle Giants", avatars: [createAvatarData('fun-emoji', '🦌'), createAvatarData('fun-emoji', '🐃'), createAvatarData('fun-emoji', '🐄')] },
            44: { category: "🔮 Crystal Orbs", avatars: ['crystal-ball', 'mystic-sphere', 'wisdom-orb'] },
            45: { category: "🔳 Pattern Princes", avatars: [createAvatarData('identicon', 'pattern-prince'), createAvatarData('identicon', 'design-duke'), createAvatarData('identicon', 'symmetry-sage')] },
            46: { category: "🐗 Wild Boars", avatars: [createAvatarData('fun-emoji', '🐗'), createAvatarData('fun-emoji', '🐖'), createAvatarData('fun-emoji', '🐷')] },
            47: { category: "⚔️ Sword Masters", avatars: ['blade-dancer', 'sword-saint', 'steel-soul'] },
            48: { category: "🦇 Night Flyers", avatars: [createAvatarData('fun-emoji', '🦇'), createAvatarData('fun-emoji', '🦅'), createAvatarData('fun-emoji', '🪶')] },
            49: { category: "🌟 Shooting Stars", avatars: ['meteor-shower', 'comet-tail', 'falling-star'] },
            50: { category: "😀 Emoji Empire", avatars: [createAvatarData('fun-emoji', 'emoji-emperor'), createAvatarData('fun-emoji', 'smiley-supreme'), createAvatarData('fun-emoji', 'expression-expert')] },
            51: { category: "🐰 Bunny Burrow", avatars: [createAvatarData('fun-emoji', '🐰'), createAvatarData('fun-emoji', '🐹'), createAvatarData('fun-emoji', '🐭')] },
            52: { category: "🎭 Drama Masks", avatars: ['comedy-master', 'tragedy-keeper', 'theater-soul'] },
            53: { category: "🦆 Duck Dynasty", avatars: [createAvatarData('fun-emoji', '🦆'), createAvatarData('fun-emoji', '🦢'), createAvatarData('fun-emoji', '🦩')] },
            54: { category: "🔰 Shield Bearers", avatars: ['guardian-shield', 'protection-ward', 'defense-master'] },
            55: { category: "👥 Community Champions", avatars: [createAvatarData('open-peeps', 'community-champion'), createAvatarData('open-peeps', 'social-sage'), createAvatarData('open-peeps', 'people-person')] },
            56: { category: "🐙 Tentacle Squad", avatars: [createAvatarData('fun-emoji', '🐙'), createAvatarData('fun-emoji', '🦑'), createAvatarData('fun-emoji', '🦪')] },
            57: { category: "🎨 Paint Palette", avatars: ['color-splash', 'paint-drop', 'art-brush'] },
            58: { category: "🦘 Hopping Heroes", avatars: [createAvatarData('fun-emoji', '🦘'), createAvatarData('fun-emoji', '🐸'), createAvatarData('fun-emoji', '🦗')] },
            59: { category: "⚗️ Potion Masters", avatars: ['elixir-brewer', 'potion-sage', 'alchemy-lord'] },
            60: { category: "🌸 Lorelei Legends", avatars: [createAvatarData('lorelei', 'pattern-overlord'), createAvatarData('lorelei', 'design-deity'), createAvatarData('lorelei', 'art-emperor')] },
            61: { category: "🐠 Tropical Fish", avatars: [createAvatarData('fun-emoji', '🐠'), createAvatarData('fun-emoji', '🐟'), createAvatarData('fun-emoji', '🦈')] },
            62: { category: "🎪 Circus Stars", avatars: ['ring-master', 'trapeze-artist', 'clown-prince'] },
            63: { category: "🦎 Lizard Lounge", avatars: [createAvatarData('fun-emoji', '🦎'), createAvatarData('fun-emoji', '🦖'), createAvatarData('fun-emoji', '🐉')] },
            64: { category: "🎯 Target Masters", avatars: ['bullseye-king', 'aim-true', 'precision-lord'] },
            65: { category: "💭 Notion Nobles", avatars: [createAvatarData('notionists', 'notion-noble'), createAvatarData('notionists', 'idea-icon'), createAvatarData('notionists', 'concept-king')] },
            66: { category: "🐳 Whale Watchers", avatars: [createAvatarData('fun-emoji', '🐳'), createAvatarData('fun-emoji', '🐋'), createAvatarData('fun-emoji', '🐬')] },
            67: { category: "🎼 Music Makers", avatars: ['melody-master', 'rhythm-ruler', 'harmony-hero'] },
            68: { category: "🕷️ Spider Squad", avatars: [createAvatarData('fun-emoji', '🕷️'), createAvatarData('fun-emoji', '🦂'), createAvatarData('fun-emoji', '🪲')] },
            69: { category: "🌺 Tropical Paradise", avatars: ['hibiscus-heart', 'palm-paradise', 'beach-bliss'] },
            70: { category: "⭕ Ring Royalty", avatars: [createAvatarData('rings', 'ring-ruler'), createAvatarData('rings', 'circle-sovereign'), createAvatarData('rings', 'halo-hero')] },
            71: { category: "🦌 Deer Dynasty", avatars: [createAvatarData('fun-emoji', '🦌'), createAvatarData('fun-emoji', '🐕'), createAvatarData('fun-emoji', '🐺')] },
            72: { category: "🎲 Dice Masters", avatars: ['lucky-roller', 'chance-champion', 'fortune-favor'] },
            73: { category: "🦀 Claw Commanders", avatars: [createAvatarData('fun-emoji', '🦀'), createAvatarData('fun-emoji', '🦞'), createAvatarData('fun-emoji', '🦂')] },
            74: { category: "🌪️ Storm Spirits", avatars: ['tornado-twist', 'hurricane-heart', 'cyclone-soul'] },
            75: { category: "🎨 Micah Elite", avatars: [createAvatarData('micah', 'micah-master'), createAvatarData('micah', 'creative-genius'), createAvatarData('micah', 'artistic-legend')] },
            76: { category: "🐅 Tiger Territory", avatars: [createAvatarData('fun-emoji', '🐅'), createAvatarData('fun-emoji', '🐆'), createAvatarData('fun-emoji', '🦁')] },
            77: { category: "💎 Diamond Dynasty", avatars: ['diamond-crown', 'crystal-throne', 'gem-scepter'] },
            78: { category: "🦅 Eagle Empire", avatars: [createAvatarData('fun-emoji', '🦅'), createAvatarData('fun-emoji', '🐦‍⬛'), createAvatarData('fun-emoji', '🦆')] },
            79: { category: "🌋 Volcano Vigor", avatars: ['lava-lord', 'magma-master', 'eruption-emperor'] },
            80: { category: "✏️ Croodles Crew", avatars: [createAvatarData('croodles-neutral', 'croodle-commander'), createAvatarData('croodles-neutral', 'sketch-sovereign'), createAvatarData('croodles-neutral', 'doodle-deity')] },
            81: { category: "🐧 Penguin Palace", avatars: [createAvatarData('fun-emoji', '🐧'), createAvatarData('fun-emoji', '🦭'), createAvatarData('fun-emoji', '🐻‍❄️')] },
            82: { category: "🏔️ Mountain Majesty", avatars: ['peak-climber', 'summit-seeker', 'alpine-ace'] },
            83: { category: "🦋 Butterfly Ballet", avatars: [createAvatarData('fun-emoji', '🦋'), createAvatarData('fun-emoji', '🐛'), createAvatarData('fun-emoji', '🪲')] },
            84: { category: "⚡ Lightning Legion", avatars: ['thunder-bolt', 'electric-energy', 'spark-spirit'] },
            85: { category: "🎭 Dylan Deities", avatars: [createAvatarData('dylan', 'dylan-divine'), createAvatarData('dylan', 'artistic-apex'), createAvatarData('dylan', 'creative-cosmos')] },
            86: { category: "🐝 Honey Makers", avatars: [createAvatarData('fun-emoji', '🐝'), createAvatarData('fun-emoji', '🪲'), createAvatarData('fun-emoji', '🦗')] },
            87: { category: "🎪 Magic Circus", avatars: ['magic-wand', 'circus-star', 'wonder-worker'] },
            88: { category: "🦇 Midnight Squad", avatars: [createAvatarData('fun-emoji', '🦇'), createAvatarData('fun-emoji', '🌙'), createAvatarData('fun-emoji', '⭐')] },
            89: { category: "🌊 Tidal Wave", avatars: ['ocean-master', 'wave-warrior', 'sea-sage'] },
            90: { category: "😎 Ultimate Avataaars", avatars: [createAvatarData('avataaars-neutral', 'avatar-apex'), createAvatarData('avataaars-neutral', 'portrait-pinnacle'), createAvatarData('avataaars-neutral', 'face-finale')] },
            91: { category: "🦁 Lion Legacy", avatars: [createAvatarData('fun-emoji', '🦁'), createAvatarData('fun-emoji', '👑'), createAvatarData('fun-emoji', '🏆')] },
            92: { category: "🎆 Firework Festival", avatars: ['sparkler-spin', 'rocket-burst', 'celebration-soul'] },
            93: { category: "🐘 Elephant Empire", avatars: [createAvatarData('fun-emoji', '🐘'), createAvatarData('fun-emoji', '🦣'), createAvatarData('fun-emoji', '🦏')] },
            94: { category: "🌟 Stellar Supreme", avatars: ['star-emperor', 'constellation-king', 'universe-ruler'] },
            95: { category: "🪟 Glass Icons", avatars: [createAvatarData('glass', 'glass-guardian'), createAvatarData('glass', 'crystal-champion'), createAvatarData('glass', 'transparent-titan')] },
            96: { category: "🦄 Unicorn Universe", avatars: [createAvatarData('fun-emoji', '🦄'), createAvatarData('fun-emoji', '🌈'), createAvatarData('fun-emoji', '✨')] },
            97: { category: "🎊 Celebration Central", avatars: ['party-master', 'festive-spirit', 'joy-bringer'] },
            98: { category: "🐲 Dragon Domain", avatars: [createAvatarData('fun-emoji', '🐲'), createAvatarData('fun-emoji', '🔥'), createAvatarData('fun-emoji', '⚡')] },
            99: { category: "👑 Royal Regalia", avatars: ['crown-jewel', 'royal-scepter', 'kingdom-key'] },
            100: { category: "🏆 LEGENDARY CENTURION 🏆", avatars: [createAvatarData('bottts', 'centurion-supreme'), createAvatarData('adventurer', 'legend-eternal'), createAvatarData('avataaars', 'master-infinite'), 'LEGENDARY-GOLDEN-CROWN', 'ULTIMATE-DIAMOND-STAR', 'COSMIC-INFINITY-BADGE'] }
        };

        // Dashboard Customization Unlocks by Level
        const dashboardThemes = {
            1: { name: "Classic Blue", gradient: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)", unlocked: true },
            5: { name: "Forest Green", gradient: "linear-gradient(135deg, #11998e 0%, #38ef7d 100%)" },
            10: { name: "Sunset Orange", gradient: "linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%)" },
            15: { name: "Purple Rain", gradient: "linear-gradient(135deg, #8360c3 0%, #2ebf91 100%)" },
            20: { name: "Ocean Waves", gradient: "linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%)" },
            25: { name: "Cherry Blossom", gradient: "linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)" },
            30: { name: "Space Galaxy", gradient: "linear-gradient(135deg, #434343 0%, #000000 100%)" },
            35: { name: "Golden Hour", gradient: "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)" },
            40: { name: "Arctic Ice", gradient: "linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)" },
            45: { name: "Fire Ember", gradient: "linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)" },
            50: { name: "Rainbow Pride", gradient: "linear-gradient(135deg, #ff0844 0%, #ffb199 50%, #00ffc6 100%)" },
            60: { name: "Midnight Sky", gradient: "linear-gradient(135deg, #232526 0%, #414345 100%)" },
            70: { name: "Rose Gold", gradient: "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)" },
            80: { name: "Electric Blue", gradient: "linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%)" },
            90: { name: "Cosmic Purple", gradient: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)" },
            100: { name: "Legendary Gold", gradient: "linear-gradient(135deg, #ffd89b 0%, #19547b 100%)" }
        };

        // Game Achievement System
        let gameAchievements = JSON.parse(localStorage.getItem(`game_achievements_${currentStudent?.id}`) || '[]');

        function addGameAchievement(type, title, description, xpEarned) {
            const achievement = {
                id: Date.now(),
                type: type,
                title: title,
                description: description,
                xpEarned: xpEarned,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString()
            };
            
            gameAchievements.unshift(achievement); // Add to beginning
            
            // Keep only last 20 achievements
            if (gameAchievements.length > 20) {
                gameAchievements = gameAchievements.slice(0, 20);
            }
            
            localStorage.setItem(`game_achievements_${currentStudent.id}`, JSON.stringify(gameAchievements));
            updateAchievementsDisplay();
        }

        function updateAchievementsDisplay() {
            const achievementsContainer = document.getElementById('recentAchievements');
            if (!achievementsContainer) return;

            if (gameAchievements.length === 0) {
                achievementsContainer.innerHTML = '<p style="color: #666; text-align: center; font-style: italic;">Complete games to earn achievements!</p>';
                return;
            }

            const achievementsHTML = gameAchievements.slice(0, 5).map(achievement => `
                <div class="achievement-item" style="
                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                    border-left: 4px solid #28a745;
                    padding: 12px;
                    margin: 8px 0;
                    border-radius: 6px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #28a745; margin-bottom: 4px;">
                                ${getAchievementIcon(achievement.type)} ${achievement.title}
                            </div>
                            <div style="color: #666; font-size: 0.9em; margin-bottom: 4px;">
                                ${achievement.description}
                            </div>
                            <div style="color: #999; font-size: 0.8em;">
                                ${achievement.date} • +${achievement.xpEarned} XP
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            achievementsContainer.innerHTML = achievementsHTML;
        }

        function getAchievementIcon(type) {
            const icons = {
                'morpheme': '📚',
                'math': '🔢', 
                'milestone': '🏆',
                'streak': '🔥',
                'perfect': '⭐',
                'speed': '⚡'
            };
            return icons[type] || '🎯';
        }

        // Keep original basic avatars available at all levels + add exciting new ones
        const basicAvatars = [
            // Original positive traits (adventurer style)
            'sunny', 'friendly', 'cool', 'awesome', 'super', 'star', 'champion', 'hero', 'winner', 'amazing', 
            'fantastic', 'wonderful', 'brilliant', 'clever', 'smart', 'creative', 'artistic', 'musical', 'sporty', 
            'adventurous', 'brave', 'kind', 'gentle', 'caring', 'helpful',
            
            // Animals (adventurer style)
            'cat', 'dog', 'tiger', 'lion', 'wolf', 'eagle', 'dolphin', 'bear', 'elephant', 'giraffe',
            'monkey', 'rabbit', 'turtle', 'owl', 'penguin', 'kangaroo', 'zebra', 'shark', 'whale', 'butterfly',
            
            // Professions (adventurer style)
            'doctor', 'firefighter', 'police-officer', 'teacher', 'scientist', 'engineer', 'pilot', 'chef',
            'artist', 'musician', 'athlete', 'dancer', 'photographer', 'detective', 'nurse', 'builder',
            
            // Fantasy & Magical (adventurer style)
            'dragon', 'unicorn', 'phoenix', 'pegasus', 'griffin', 'fairy', 'elf', 'wizard', 'knight', 'mage',
            'angel', 'genie', 'centaur', 'mermaid', 'pixie',
            
            // Space & Sci-Fi (adventurer style)
            'alien', 'robot', 'cyborg', 'android', 'martian', 'cosmic-being',
            
            // Objects & Vehicles (adventurer style)
            'rocket', 'car', 'plane', 'boat', 'train', 'bicycle', 'skateboard',
            
            // FREE Bottts Collection - Robot Animals & Creatures (always available)
            createAvatarData('bottts', 'robo-cat'),
            createAvatarData('bottts', 'cyber-dog'), 
            createAvatarData('bottts', 'mecha-bear'),
            createAvatarData('bottts', 'pixel-bird'),
            createAvatarData('bottts', 'droid-fish'),
            createAvatarData('bottts', 'bot-bunny'),
            createAvatarData('bottts', 'tech-turtle'),
            createAvatarData('bottts', 'robo-owl'),
            createAvatarData('bottts', 'cyber-fox'),
            createAvatarData('bottts', 'mecha-lion'),
            createAvatarData('bottts', 'pixel-shark'),
            createAvatarData('bottts', 'droid-penguin'),
            createAvatarData('bottts', 'bot-elephant'),
            createAvatarData('bottts', 'tech-monkey'),
            createAvatarData('bottts', 'robo-whale'),
            createAvatarData('bottts', 'cyber-tiger')
        ];

        // Helper function to get current XP (separate from kudos points)
        function getCurrentXP() {
            const studentId = currentStudent?.id || 'unknown';
            const studentXPKey = `student_xp_${studentId}`;
            const xpValue = parseInt(localStorage.getItem(studentXPKey)) || 0;
            console.log('getCurrentXP called - Student ID:', studentId, 'XP Key:', studentXPKey, 'XP Value:', xpValue);
            return xpValue;
        }

        // Function to get available avatars for current level
        function getAvailableAvatars(currentLevel) {
            let availableAvatars = [...basicAvatars]; // All basic avatars are always available
            
            // Add level-unlocked premium avatars
            for (const [levelReq, pack] of Object.entries(avatarsByLevel)) {
                if (currentLevel >= parseInt(levelReq)) {
                    availableAvatars = availableAvatars.concat(pack.avatars);
                }
            }
            
            return availableAvatars;
        }

        // Function to get locked avatars for preview
        function getLockedAvatars(currentLevel) {
            let lockedAvatars = [];
            
            for (const [levelReq, pack] of Object.entries(avatarsByLevel)) {
                if (currentLevel < parseInt(levelReq)) {
                    lockedAvatars.push({
                        level: parseInt(levelReq),
                        category: pack.category,
                        avatars: pack.avatars
                    });
                }
            }
            
            return lockedAvatars;
        }

        // Function to generate avatar URL - supports both old seed format and new JSON format
        function getAvatarUrl(avatarData) {
            // Handle both old string format and new JSON format for backward compatibility
            if (typeof avatarData === 'string') {
                // Old format - just seed, use adventurer style
                return `https://api.dicebear.com/7.x/adventurer/svg?seed=${encodeURIComponent(avatarData)}`;
            } else if (typeof avatarData === 'object' && avatarData.style && avatarData.seed) {
                // New format - {style, seed}
                const style = avatarData.style || 'adventurer';
                const seed = avatarData.seed || 'default';
                return `https://api.dicebear.com/7.x/${style}/svg?seed=${encodeURIComponent(seed)}`;
            } else {
                // Fallback - treat as string seed
                return `https://api.dicebear.com/7.x/adventurer/svg?seed=${encodeURIComponent(avatarData)}`;
            }
        }

        // Helper function to create avatar data object
        function createAvatarData(style, seed) {
            return { style: style, seed: seed };
        }

        // Helper function to get avatar display name
        function getAvatarDisplayName(avatarData) {
            if (typeof avatarData === 'string') {
                return avatarData;
            } else if (typeof avatarData === 'object' && avatarData.seed) {
                return avatarData.seed;
            }
            return 'avatar';
        }

        // XP requirements for each level - Pokemon Experience Chart System
        const xpRequirements = [
            0,      // Level 1
            25,     // Level 2  
            50,     // Level 3
            100,    // Level 4
            150,    // Level 5
            200,    // Level 6
            400,    // Level 7
            600,    // Level 8
            800,    // Level 9
            1000,   // Level 10
            1500,   // Level 11
            2000,   // Level 12
            3000,   // Level 13
            4000,   // Level 14
            5000,   // Level 15
            6000,   // Level 16
            7000,   // Level 17
            8000,   // Level 18
            9000,   // Level 19
            10000,  // Level 20
            11500,  // Level 21
            13000,  // Level 22
            14500,  // Level 23
            16000,  // Level 24
            17500,  // Level 25
            19000,  // Level 26
            20500,  // Level 27
            22000,  // Level 28
            23500,  // Level 29
            25000,  // Level 30
            27500,  // Level 31
            30000,  // Level 32
            32500,  // Level 33
            35000,  // Level 34
            37500,  // Level 35
            40000,  // Level 36
            42500,  // Level 37
            45000,  // Level 38
            47500,  // Level 39
            50000,  // Level 40
            55000,  // Level 41
            60000,  // Level 42
            65000,  // Level 43
            70000,  // Level 44
            75000,  // Level 45
            80000,  // Level 46
            85000,  // Level 47
            90000,  // Level 48
            95000,  // Level 49
            100000, // Level 50
            110000, // Level 51
            120000, // Level 52
            130000, // Level 53
            140000, // Level 54
            150000, // Level 55
            160000, // Level 56
            170000, // Level 57
            180000, // Level 58
            190000, // Level 59
            200000, // Level 60
            210000, // Level 61
            220000, // Level 62
            230000, // Level 63
            240000, // Level 64
            250000, // Level 65
            260000, // Level 66
            270000, // Level 67
            280000, // Level 68
            290000, // Level 69
            300000, // Level 70
            310000, // Level 71
            320000, // Level 72
            330000, // Level 73
            340000, // Level 74
            350000, // Level 75
            360000, // Level 76
            370000, // Level 77
            380000, // Level 78
            390000, // Level 79
            400000, // Level 80
            410000, // Level 81
            420000, // Level 82
            430000, // Level 83
            440000, // Level 84
            450000, // Level 85
            460000, // Level 86
            470000, // Level 87
            480000, // Level 88
            490000, // Level 89
            500000, // Level 90
            510000, // Level 91
            520000, // Level 92
            530000, // Level 93
            540000, // Level 94
            550000, // Level 95
            560000, // Level 96
            570000, // Level 97
            580000, // Level 98
            590000, // Level 99
            600000  // Level 100
        ];

        // Session persistence functions
        function saveSession(student, classCode, studentCode) {
            const sessionData = {
                student: student,
                classCode: classCode,
                studentCode: studentCode,
                timestamp: Date.now()
            };
            sessionStorage.setItem('studentSession', JSON.stringify(sessionData));
            console.log('Session saved:', sessionData);
        }

        function loadSession() {
            const sessionData = sessionStorage.getItem('studentSession');
            if (sessionData) {
                try {
                    const parsed = JSON.parse(sessionData);
                    // Check if session is less than 24 hours old
                    const isValid = (Date.now() - parsed.timestamp) < (24 * 60 * 60 * 1000);
                    if (isValid) {
                        console.log('Valid session found:', parsed);
                        return parsed;
                    } else {
                        sessionStorage.removeItem('studentSession');
                        console.log('Session expired, removed');
                    }
                } catch (e) {
                    console.error('Error parsing session:', e);
                    sessionStorage.removeItem('studentSession');
                }
            }
            return null;
        }

        function clearSession() {
            sessionStorage.removeItem('studentSession');
            console.log('Session cleared');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Enhanced portal with avatars & XP loaded successfully!');
            setupEventListeners();
            loadSavedAvatar();
            
            // Check for existing session
            const existingSession = loadSession();
            if (existingSession) {
                console.log('Restoring session for:', existingSession.student.name);
                currentStudent = existingSession.student;
                currentClass = existingSession.classCode;
                currentStudentCode = existingSession.studentCode;
                showDashboard();
            }
        });

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Auto-format student code input (numbers only)
            document.getElementById('studentCode').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/\D/g, '').slice(0, 4);
            });

            // Auto-refresh kudos every 30 seconds
            setInterval(async () => {
                if (currentStudent) {
                    await loadStudentKudos(true); // Silent refresh
                }
            }, 30000);

            // Real-time sync for instant updates
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('kudos-updates');
                channel.addEventListener('message', (event) => {
                    const { studentName, changeType } = event.data;
                    
                    // If this update is for the current student, refresh immediately
                    if (currentStudent && currentStudent.name === studentName) {
                        console.log('Received real-time update for current student:', changeType);
                        loadStudentKudos(true); // Silent refresh
                    }
                });
            }

            // Listen for localStorage changes (cross-tab communication)
            window.addEventListener('storage', (e) => {
                if (e.key === 'instant-update' && currentStudent) {
                    try {
                        const update = JSON.parse(e.newValue);
                        if (update && update.studentName === currentStudent.name) {
                            console.log('Cross-tab update received for current student');
                            loadStudentKudos(true);
                        }
                    } catch (err) {
                        console.log('Failed to parse cross-tab update');
                    }
                }
            });

            // Server polling for cross-device updates every 10 seconds
            setInterval(async () => {
                if (currentStudent) {
                    await checkForServerUpdates();
                }
            }, 10000);
        }

        // XP Management Functions
        function resetStudentXP() {
            if (currentStudent) {
                const studentXPKey = `student_xp_${currentStudent.id}`;
                localStorage.removeItem(studentXPKey);
                console.log('XP reset for student:', currentStudent.name);
                // Reload to recalculate XP
                if (typeof loadStudentKudos === 'function') {
                    loadStudentKudos();
                }
            }
        }
        
        // Make resetStudentXP available globally for testing
        window.resetStudentXP = resetStudentXP;

        // Badge Collection Functions
        function getBadgeData() {
            return {
                1: { icon: "🎉", title: "First Steps!" },
                2: { icon: "🌟", title: "Rising Star!" },
                3: { icon: "⚡", title: "Power Player!" },
                4: { icon: "🔥", title: "On Fire!" },
                5: { icon: "💎", title: "Diamond Achiever!" },
                6: { icon: "🏆", title: "Champion!" },
                7: { icon: "🚀", title: "Rocket Scientist!" },
                8: { icon: "👑", title: "Knowledge Royalty!" },
                9: { icon: "🎯", title: "Master Marksman!" },
                10: { icon: "🌈", title: "Rainbow Warrior!" },
                11: { icon: "⭐", title: "Superstar!" },
                12: { icon: "🔮", title: "Wisdom Oracle!" },
                13: { icon: "🎪", title: "Learning Maestro!" },
                14: { icon: "🌊", title: "Tsunami of Talent!" },
                15: { icon: "🎨", title: "Master Artist!" },
                16: { icon: "🏰", title: "Castle Builder!" },
                17: { icon: "🦄", title: "Legendary Unicorn!" },
                18: { icon: "🌌", title: "Galaxy Guardian!" },
                19: { icon: "🔥", title: "Phoenix Rising!" },
                20: { icon: "👑", title: "Ultimate Legend!" }
            };
        }

        function updateBadgeCollection(currentLevel) {
            const badgeGrid = document.getElementById('badgeGrid');
            const badgeData = getBadgeData();
            const maxDisplayLevel = 20; // Show badges up to level 20
            
            badgeGrid.innerHTML = '';
            
            for (let level = 1; level <= maxDisplayLevel; level++) {
                const badge = badgeData[level] || { icon: "⭐", title: "Level Master!" };
                const isUnlocked = level <= currentLevel;
                
                const badgeElement = document.createElement('div');
                badgeElement.className = `achievement-badge ${!isUnlocked ? 'locked' : ''}`;
                badgeElement.innerHTML = `
                    <div class="badge-icon">${isUnlocked ? badge.icon : '🔒'}</div>
                    <div class="badge-level">${level}</div>
                    <div class="badge-title">${isUnlocked ? badge.title : `Level ${level}`}</div>
                `;
                
                if (!isUnlocked) {
                    badgeElement.title = `Unlock at Level ${level}`;
                } else {
                    badgeElement.title = `${badge.title} - Achieved!`;
                }
                
                badgeGrid.appendChild(badgeElement);
            }
        }

        function populateAvatarGrid() {
            const currentLevel = calculateLevel(getCurrentXP());
            console.log('Populating avatar grid for Level', currentLevel, 'student with', getCurrentXP(), 'XP');
            
            populateAvailableTab(currentLevel);
            populateComingSoonTab(currentLevel);
        }
        
        function populateAvailableTab(currentLevel) {
            const container = document.getElementById('availableCategories');
            container.innerHTML = '';
            
            // Basic Avatars (backward compatibility - always available)
            if (basicAvatars.length > 0) {
                const basicCategory = document.createElement('div');
                basicCategory.className = 'avatar-category';
                basicCategory.innerHTML = `
                    <div class="category-header">
                        <div class="category-title">⭐ Classic Collection</div>
                        <div class="category-progress">${basicAvatars.length} avatars • Always Available</div>
                    </div>
                    <div class="category-grid" id="basicGrid"></div>
                `;
                container.appendChild(basicCategory);
                
                const basicGrid = document.getElementById('basicGrid');
                basicAvatars.forEach(avatar => {
                    createAvatarOption(avatar, basicGrid, false);
                });
            }
            
            // Unlocked Premium Categories
            for (const [levelReq, pack] of Object.entries(avatarsByLevel)) {
                if (currentLevel >= parseInt(levelReq)) {
                    const category = document.createElement('div');
                    category.className = 'avatar-category';
                    category.innerHTML = `
                        <div class="category-header">
                            <div class="category-title">⭐ ${pack.category}</div>
                            <div class="category-progress">Level ${levelReq} • ${pack.avatars.length} avatars</div>
                        </div>
                        <div class="category-grid" id="level${levelReq}Grid"></div>
                    `;
                    container.appendChild(category);
                    
                    const categoryGrid = document.getElementById(`level${levelReq}Grid`);
                    pack.avatars.forEach(avatar => {
                        createAvatarOption(avatar, categoryGrid, false);
                    });
                }
            }
        }
        
        function populateComingSoonTab(currentLevel) {
            const container = document.getElementById('comingSoonCategories');
            container.innerHTML = '';
            
            let hasLockedContent = false;
            
            // Locked Premium Categories
            for (const [levelReq, pack] of Object.entries(avatarsByLevel)) {
                if (currentLevel < parseInt(levelReq)) {
                    hasLockedContent = true;
                    const levelsToGo = parseInt(levelReq) - currentLevel;
                    
                    const category = document.createElement('div');
                    category.className = 'avatar-category';
                    category.innerHTML = `
                        <div class="category-header locked">
                            <div class="category-title">🔒 ${pack.category}</div>
                            <div class="category-progress">Level ${levelReq} • ${levelsToGo} level${levelsToGo > 1 ? 's' : ''} to go</div>
                        </div>
                        <div class="category-grid" id="locked${levelReq}Grid"></div>
                    `;
                    container.appendChild(category);
                    
                    const categoryGrid = document.getElementById(`locked${levelReq}Grid`);
                    pack.avatars.forEach(avatar => {
                        createAvatarOption(avatar, categoryGrid, true, parseInt(levelReq));
                    });
                }
            }
            
            if (!hasLockedContent) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 3em; margin-bottom: 15px;">🎉</div>
                        <h3>Congratulations!</h3>
                        <p>You've unlocked all available avatar categories!</p>
                        <p style="font-size: 0.9em; opacity: 0.8;">More categories coming soon...</p>
                    </div>
                `;
            }
        }
        
        function createAvatarOption(avatar, container, isLocked = false, unlockLevel = null) {
            const option = document.createElement('div');
            option.className = 'avatar-option';
            
            if (isLocked) {
                option.classList.add('locked');
                option.style.opacity = '0.4';
                option.style.filter = 'grayscale(100%)';
                option.title = `Unlock at Level ${unlockLevel}`;
            }
            
            const img = document.createElement('img');
            img.src = getAvatarUrl(avatar);
            img.alt = getAvatarDisplayName(avatar);
            option.appendChild(img);
            
            if (isLocked) {
                const lockOverlay = document.createElement('div');
                lockOverlay.innerHTML = '🔒';
                lockOverlay.style.position = 'absolute';
                lockOverlay.style.top = '50%';
                lockOverlay.style.left = '50%';
                lockOverlay.style.transform = 'translate(-50%, -50%)';
                lockOverlay.style.fontSize = '16px';
                lockOverlay.style.textShadow = '0 0 3px rgba(0,0,0,0.8)';
                lockOverlay.style.zIndex = '2';
                
                option.style.position = 'relative';
                option.appendChild(lockOverlay);
                
                option.onclick = () => {
                    alert(`🔒 This avatar unlocks at Level ${unlockLevel}!\n\nKeep earning points to reach it! You're currently Level ${calculateLevel(getCurrentXP())}.`);
                };
            } else {
                option.onclick = () => selectAvatar(avatar, option);
            }
            
            container.appendChild(option);
        }

        function switchAvatarTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'available') {
                document.getElementById('availableTab').classList.add('active');
            } else if (tabName === 'coming-soon') {
                document.getElementById('comingSoonTab').classList.add('active');
            }
        }

        function selectAvatar(avatar, element) {
            // Remove previous selection
            document.querySelectorAll('.avatar-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Add selection to clicked avatar
            element.classList.add('selected');
            selectedAvatar = avatar;
        }

        function openAvatarModal() {
            document.getElementById('avatarModal').style.display = 'block';
            populateAvatarGrid();
            
            // Reset to available tab
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector('.tab-button').classList.add('active');
            document.getElementById('availableTab').classList.add('active');
            
            // Highlight current avatar after a short delay to ensure DOM is ready
            setTimeout(() => {
                document.querySelectorAll('.avatar-option').forEach(opt => {
                    opt.classList.remove('selected');
                    const img = opt.querySelector('img');
                    if (img && img.src.includes(selectedAvatar)) {
                        opt.classList.add('selected');
                    }
                });
            }, 100);
        }

        function closeAvatarModal() {
            document.getElementById('avatarModal').style.display = 'none';
        }

        function saveSelectedAvatar() {
            document.getElementById('avatarDisplay').src = getAvatarUrl(selectedAvatar);
            localStorage.setItem('studentAvatar', selectedAvatar);
            
            // Save avatar to database
            if (currentStudent && currentStudent.id) {
                saveAvatarToDatabase(selectedAvatar);
            }
            
            closeAvatarModal();
            console.log('Avatar saved:', selectedAvatar);
        }

        async function saveAvatarToDatabase(avatar) {
            try {
                // Convert avatar to JSON string for database storage
                let avatarData;
                if (typeof avatar === 'string') {
                    // Old format - just seed
                    avatarData = avatar;
                } else if (typeof avatar === 'object' && avatar.style && avatar.seed) {
                    // New format - JSON object
                    avatarData = JSON.stringify(avatar);
                } else {
                    avatarData = String(avatar);
                }
                
                const response = await fetch('/.netlify/functions/updateStudentAvatar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        studentId: currentStudent.id,
                        avatar: avatarData
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('Avatar saved to database successfully');
                    showSuccessNotification('Avatar saved successfully!');
                    // Store in localStorage for quick access
                    localStorage.setItem('studentAvatar', avatarData);
                } else {
                    console.error('Failed to save avatar to database:', data.error);
                    showErrorNotification('Failed to save avatar. Please try again.');
                }
            } catch (error) {
                console.error('Error saving avatar to database:', error);
                showErrorNotification('Connection error. Please check your internet and try again.');
            }
        }

        function loadSavedAvatar() {
            // First try to load from student data (database)
            if (currentStudent && currentStudent.avatar_data) {
                try {
                    // Try to parse as JSON first (new format)
                    const avatarData = JSON.parse(currentStudent.avatar_data);
                    selectedAvatar = avatarData; // Object with style and seed
                } catch {
                    // Fallback to old format processing
                    if (currentStudent.avatar_data.startsWith('http')) {
                        selectedAvatar = currentStudent.avatar_data.split('seed=')[1] || 'default';
                    } else {
                        selectedAvatar = currentStudent.avatar_data; // String seed
                    }
                }
                document.getElementById('avatarDisplay').src = getAvatarUrl(selectedAvatar);
                localStorage.setItem('studentAvatar', typeof selectedAvatar === 'string' ? selectedAvatar : JSON.stringify(selectedAvatar));
                return;
            }
            
            // Fall back to localStorage
            const saved = localStorage.getItem('studentAvatar');
            if (saved) {
                try {
                    // Try to parse as JSON first
                    selectedAvatar = JSON.parse(saved);
                } catch {
                    // Fallback to string format
                    selectedAvatar = saved;
                }
                document.getElementById('avatarDisplay').src = getAvatarUrl(selectedAvatar);
            } else {
                // Default avatar
                selectedAvatar = 'happy';
                document.getElementById('avatarDisplay').src = getAvatarUrl(selectedAvatar);
            }
        }

        function calculateLevel(totalPoints) {
            let level = 1;
            for (let i = 1; i < xpRequirements.length; i++) {
                if (totalPoints >= xpRequirements[i]) {
                    level = i + 1;
                } else {
                    break;
                }
            }
            return level;
        }

        function calculateXPProgress(totalPoints, level) {
            if (level >= xpRequirements.length) {
                return { current: totalPoints, required: totalPoints, percentage: 100 };
            }
            
            const currentLevelXP = xpRequirements[level - 1];
            const nextLevelXP = xpRequirements[level] || totalPoints;
            const progressXP = totalPoints - currentLevelXP;
            const requiredXP = nextLevelXP - currentLevelXP;
            const percentage = Math.min(100, (progressXP / requiredXP) * 100);
            
            return {
                current: progressXP,
                required: requiredXP,
                percentage: percentage
            };
        }

        function getCurrentLevel() {
            const currentXP = getCurrentXP();
            return calculateLevel(currentXP);
        }

        function applyDashboardTheme(level) {
            const unlockedThemes = Object.entries(dashboardThemes)
                .filter(([themeLevel, theme]) => parseInt(themeLevel) <= level)
                .map(([themeLevel, theme]) => ({...theme, level: parseInt(themeLevel)}));

            if (unlockedThemes.length === 0) return;

            // Get current theme from localStorage or use the highest unlocked
            let currentTheme = localStorage.getItem(`dashboard_theme_${currentStudent?.id}`);
            
            if (!currentTheme || !unlockedThemes.find(t => t.name === currentTheme)) {
                // Use highest unlocked theme
                currentTheme = unlockedThemes[unlockedThemes.length - 1].name;
                localStorage.setItem(`dashboard_theme_${currentStudent?.id}`, currentTheme);
            }

            const theme = unlockedThemes.find(t => t.name === currentTheme);
            if (theme) {
                document.body.style.background = theme.gradient;
                updateThemeSelector(unlockedThemes, currentTheme);
            }
        }

        function updateThemeSelector(unlockedThemes, currentTheme) {
            const container = document.getElementById('themeCustomization');
            if (!container) return;

            const themesHTML = unlockedThemes.map(theme => `
                <div class="theme-option ${theme.name === currentTheme ? 'active' : ''}" 
                     onclick="selectTheme('${theme.name}')"
                     style="
                        width: 60px;
                        height: 30px;
                        background: ${theme.gradient};
                        border-radius: 6px;
                        margin: 4px;
                        cursor: pointer;
                        border: 3px solid ${theme.name === currentTheme ? '#ffd700' : 'transparent'};
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                        position: relative;
                        display: inline-block;
                     "
                     title="${theme.name} (Level ${theme.level})">
                </div>
            `).join('');

            container.innerHTML = `
                <h4 style="margin: 0 0 10px 0; color: #333;">🎨 Dashboard Themes</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                    ${themesHTML}
                </div>
                <p style="margin: 5px 0 0 0; font-size: 0.8em; color: #666;">
                    ${unlockedThemes.length} of ${Object.keys(dashboardThemes).length} themes unlocked
                </p>
            `;
        }

        function selectTheme(themeName) {
            localStorage.setItem(`dashboard_theme_${currentStudent?.id}`, themeName);
            const theme = Object.values(dashboardThemes).find(t => t.name === themeName);
            if (theme) {
                document.body.style.background = theme.gradient;
                updateThemeSelector(
                    Object.entries(dashboardThemes)
                        .filter(([level, _]) => parseInt(level) <= getCurrentLevel())
                        .map(([level, theme]) => ({...theme, level: parseInt(level)})),
                    themeName
                );
            }
        }

        function updateXPDisplay(totalPoints) {
            console.log('updateXPDisplay called with totalPoints:', totalPoints);
            const newLevel = calculateLevel(totalPoints);
            const progress = calculateXPProgress(totalPoints, newLevel);
            console.log('Calculated level:', newLevel, 'Progress:', progress);
            
            // Check for level up
            if (newLevel > currentLevel && currentLevel > 1) {
                showLevelUpNotification(newLevel);
            }
            
            currentLevel = newLevel;
            currentXP = totalPoints;
            
            // Update displays with debugging
            const studentLevelEl = document.getElementById('studentLevel');
            const levelBadgeEl = document.getElementById('levelBadge');
            const xpBarEl = document.getElementById('xpBar');
            const xpTextEl = document.getElementById('xpText');
            
            console.log('DOM Elements found:', {
                studentLevel: !!studentLevelEl,
                levelBadge: !!levelBadgeEl, 
                xpBar: !!xpBarEl,
                xpText: !!xpTextEl
            });
            
            if (studentLevelEl) studentLevelEl.textContent = newLevel;
            if (levelBadgeEl) levelBadgeEl.textContent = newLevel;
            if (xpBarEl) {
                xpBarEl.style.width = progress.percentage + '%';
                console.log('Updated XP bar width to:', progress.percentage + '%');
            }
            if (xpTextEl) {
                const newText = `XP: ${progress.current} / ${progress.required} (Level ${newLevel})`;
                xpTextEl.textContent = newText;
                console.log('Updated XP text to:', newText);
            }
            
            // Update badge collection
            updateBadgeCollection(newLevel);
        }

        function showLevelUpNotification(level) {
            // Achievement messages and emojis for different levels
            const levelAchievements = {
                1: { icon: "🎉", title: "First Steps!", message: "Welcome to your learning journey!" },
                2: { icon: "🌟", title: "Rising Star!", message: "You're building momentum!" },
                3: { icon: "⚡", title: "Power Player!", message: "Your dedication is showing!" },
                4: { icon: "🔥", title: "On Fire!", message: "You're really getting the hang of this!" },
                5: { icon: "💎", title: "Diamond Achiever!", message: "Your hard work is paying off!" },
                6: { icon: "🏆", title: "Champion!", message: "You're becoming unstoppable!" },
                7: { icon: "🚀", title: "Rocket Scientist!", message: "Your knowledge is skyrocketing!" },
                8: { icon: "👑", title: "Knowledge Royalty!", message: "You rule this classroom!" },
                9: { icon: "🎯", title: "Master Marksman!", message: "Hitting every target perfectly!" },
                10: { icon: "🌈", title: "Rainbow Warrior!", message: "You bring color to learning!" },
                15: { icon: "🔮", title: "Mystic Scholar!", message: "Ancient wisdom flows through you!" },
                20: { icon: "🏰", title: "Academic Fortress!", message: "Your knowledge castle is complete!" },
                25: { icon: "🦄", title: "Legendary Unicorn!", message: "Rare and magical talent!" },
                30: { icon: "�", title: "Cosmic Explorer!", message: "Discovering new frontiers!" },
                35: { icon: "🔥", title: "Phoenix Master!", message: "Rising stronger than ever!" },
                40: { icon: "👑", title: "Emperor of Learning!", message: "Your domain knows no limits!" },
                45: { icon: "⚡", title: "Lightning Legend!", message: "Swift as thought, bright as stars!" },
                50: { icon: "🌟", title: "Golden Milestone!", message: "Halfway to greatness achieved!" },
                55: { icon: "🚀", title: "Galactic Guardian!", message: "Protecting knowledge across the universe!" },
                60: { icon: "�", title: "Diamond Dynasty!", message: "Precious beyond measure!" },
                65: { icon: "🏆", title: "Supreme Champion!", message: "Victory follows your every step!" },
                70: { icon: "🔱", title: "Trident Titan!", message: "Commanding the seas of wisdom!" },
                75: { icon: "👑", title: "Platinum Monarch!", message: "Ruling with wisdom and grace!" },
                80: { icon: "🌠", title: "Meteor Master!", message: "Blazing trails across the sky!" },
                85: { icon: "⚡", title: "Thunder God!", message: "Your power shakes the heavens!" },
                90: { icon: "🌌", title: "Universe Architect!", message: "Building worlds with your mind!" },
                95: { icon: "💫", title: "Stellar Sage!", message: "Wisdom of a thousand stars!" },
                100: { icon: "🏆", title: "LEGENDARY CENTURION!", message: "The ultimate achievement unlocked!" }
            };
            
            const achievement = levelAchievements[level] || { 
                icon: "⭐", 
                title: "Level Master!", 
                message: "Your dedication knows no bounds!" 
            };
            
            // Check if this level unlocks new avatars
            const avatarUnlock = avatarsByLevel[level];
            let avatarUnlockMessage = '';
            
            if (avatarUnlock) {
                avatarUnlockMessage = `
                    <div class="avatar-unlock-notification">
                        🔓 <strong>New Avatars Unlocked!</strong><br>
                        <em>${avatarUnlock.category}</em> - ${avatarUnlock.avatars.length} new avatars available!
                        <br><small>Check your avatar selection to try them out!</small>
                    </div>
                `;
            }
            
            const notification = document.getElementById('levelUpNotification');
            notification.innerHTML = `
                <div class="level-up-content">
                    <div class="level-up-badge">
                        <div class="level-up-number">${level}</div>
                    </div>
                    <h2>LEVEL UP!</h2>
                    <div class="level-up-message">${achievement.title}</div>
                    <div class="level-up-subtitle">${achievement.message}</div>
                    <div class="level-up-achievement">
                        <span class="achievement-icon">${achievement.icon}</span>
                        <span class="achievement-text">Level ${level} Unlocked!</span>
                    </div>
                    ${avatarUnlockMessage}
                </div>
            `;
            
            notification.style.display = 'block';
            
            // Play celebration sound if available
            try {
                const audio = new Audio('../Audio/ding.wav');
                audio.play().catch(() => {}); // Ignore if audio fails
            } catch (e) {}
            
            // Add milestone achievement for leveling up
            if (currentStudent) {
                addGameAchievement('milestone', 
                    `${achievement.title}`, 
                    `Reached Level ${level} - ${achievement.message}`,
                    0 // No XP awarded for milestones (already got XP from games)
                );
            }
            
            // Hide after animation completes (longer if avatar unlock)
            setTimeout(() => {
                notification.style.display = 'none';
            }, avatarUnlock ? 6000 : 4000);
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const loginBtn = document.getElementById('loginBtn');
            const errorMessage = document.getElementById('errorMessage');
            
            // Get form data
            const classCode = document.getElementById('classCode').value.trim();
            const studentCode = document.getElementById('studentCode').value.trim();
            
            // Validate inputs
            if (!classCode || !studentCode) {
                showError('Please enter both class code and student code');
                return;
            }
            
            if (studentCode.length !== 4 || !/^\d+$/.test(studentCode)) {
                showError('Student code must be exactly 4 digits');
                return;
            }
            
            // Show loading state
            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';
            errorMessage.style.display = 'none';
            
            try {
                console.log('Attempting login with:', { classCode, studentCode });
                
                const response = await fetch(`/.netlify/functions/consistentStudentAuth`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        classCode: classCode,
                        studentCode: studentCode
                    })
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (response.ok && data.success) {
                    // Store student data
                    currentStudent = data.student;
                    
                    // CUSTOM CODE FIX: Use actual class name from student data instead of the input code
                    // Priority: class field (actual name) > classCode input (custom code)
                    currentClass = data.student?.class || classCode;
                    currentStudentCode = studentCode;
                    
                    console.log('Login successful:', currentStudent);
                    console.log('🔍 CUSTOM CODE DEBUG: Input classCode:', classCode, 'Actual class:', currentClass);
                    console.log('🔍 Student object keys:', Object.keys(currentStudent));
                    
                    // Debug the class resolution
                    if (data.student?.class) {
                        console.log('✅ Found actual class name:', data.student.class);
                    } else if (data.student?.class_code) {
                        console.log('⚠️ Using class_code as fallback:', data.student.class_code);
                        currentClass = data.student.class_code;
                    } else {
                        console.log('⚠️ No class field found, using input code:', classCode);
                    }
                    
                    console.log('🎯 Final class name for leaderboard:', currentClass);
                    
                    // Save session for persistence
                    saveSession(currentStudent, currentClass, studentCode);
                    
                    // Show dashboard
                    showDashboard();
                } else {
                    console.error('Login failed:', data.message);
                    showError(data.message || 'Login failed. Please check your codes and try again.');
                }
            } catch (error) {
                logError('Student Login', error, {
                    endpoint: '../netlify/functions/consistentStudentAuth',
                    studentCode: document.getElementById('studentCode').value,
                    className: document.getElementById('className').value
                });
                showError('Connection error. Please check your internet and try again.');
            } finally {
                // Reset button state
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login to Portal';
            }
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function showDashboard() {
            // Hide login, show dashboard
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').classList.remove('hidden');
            
            // Update student info
            updateStudentProfile();
            
            // Load dashboard data
            loadDashboardData();
        }

        function updateStudentProfile() {
            document.getElementById('studentName').textContent = currentStudent.name;
            
            // CUSTOM CODE FIX: Show actual class name, not the login code
            const displayClass = currentStudent?.className || currentStudent?.class || currentStudent?.class_name || currentClass;
            document.getElementById('studentClass').textContent = displayClass;
            document.getElementById('displayStudentCode').textContent = currentStudentCode;
            
            console.log('🔍 Profile update - Display class:', displayClass, 'Current class var:', currentClass);
            
            // Load avatar from database if available
            if (currentStudent.avatar_data) {
                // Check if it's already a URL or a seed
                if (currentStudent.avatar_data.startsWith('http')) {
                    selectedAvatar = currentStudent.avatar_data.split('seed=')[1] || 'default';
                } else {
                    selectedAvatar = currentStudent.avatar_data;
                }
                document.getElementById('avatarDisplay').src = getAvatarUrl(selectedAvatar);
                localStorage.setItem('studentAvatar', selectedAvatar);
            } else {
                // Load from localStorage as fallback
                loadSavedAvatar();
            }
        }

        function refreshStudentData() {
            // Update all student data displays with current student data
            if (currentStudent) {
                console.log('refreshStudentData called with currentStudent.points:', currentStudent.points);
                
                // Update kudos display with actual kudos points from database
                document.getElementById('totalKudos').textContent = currentStudent.points || 0;
                
                // Update XP display with separate XP system (NOT kudos points)
                const currentXP = getCurrentXP();
                updateXPDisplay(currentXP);
                
                // DO NOT sync localStorage with database points for XP
                // XP and kudos are now separate systems
                
                // Update avatar if changed
                if (currentStudent.avatar_data && currentStudent.avatar_data !== selectedAvatar) {
                    // Check if it's already a URL or a seed
                    if (currentStudent.avatar_data.startsWith('http')) {
                        selectedAvatar = currentStudent.avatar_data.split('seed=')[1] || 'default';
                    } else {
                        selectedAvatar = currentStudent.avatar_data;
                    }
                    document.getElementById('avatarDisplay').src = getAvatarUrl(selectedAvatar);
                    localStorage.setItem('studentAvatar', selectedAvatar);
                }
                
                // Update session with latest data
                if (currentClass && currentStudentCode) {
                    saveSession(currentStudent, currentClass, currentStudentCode);
                }
                
                console.log('Student data refreshed - Points:', currentStudent.points);
            }
        }

        async function loadDashboardData() {
            console.log('Loading dashboard for student:', currentStudent);
            
            // Update XP display with separate XP system
            const currentXP = getCurrentXP();
            updateXPDisplay(currentXP);
            
            // Initialize badge collection with current level based on XP
            const currentLevel = calculateLevel(currentXP);
            updateBadgeCollection(currentLevel || 1);
            
            // Apply dashboard theme and update customization panel
            applyDashboardTheme(currentLevel || 1);
            
            // Initialize achievements display
            updateAchievementsDisplay();
            
            // Update avatar grid with current level unlocks
            populateAvatarGrid();
            
            // Load student kudos
            await loadStudentKudos();
            
            // Load leaderboard with failsafe backup
            try {
                await loadLeaderboard();
            } catch (error) {
                console.error('❌ CRITICAL: loadLeaderboard failed in initialization:', error);
                // Force show error immediately if loadLeaderboard fails to start
                const leaderboardList = document.getElementById('leaderboardList');
                if (leaderboardList) {
                    leaderboardList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #e74c3c; background: #f8f9fa; border-radius: 8px; margin: 10px;">
                            <div style="font-size: 1.2em; margin-bottom: 15px;">❌ Critical Leaderboard Error</div>
                            
                            <div style="background: #fff3cd; padding: 12px; border-radius: 6px; margin: 15px 0; text-align: left; font-size: 13px; color: #856404;">
                                <strong>📋 Tell your teacher this info:</strong><br>
                                <div style="font-family: monospace; background: #f8f9fa; padding: 8px; border-radius: 4px; margin-top: 8px;">
                                    Student: ${currentStudent?.name || 'Unknown'}<br>
                                    Class: ${currentClass}<br>
                                    Error: Critical failure during initialization<br>
                                    Date: ${new Date().toLocaleString()}<br>
                                    Details: ${error.message || 'Unknown error'}
                                </div>
                            </div>
                            
                            <button onclick="forceRetryLeaderboard()" style="
                                background: #dc3545; color: white; border: none; padding: 12px 20px; 
                                border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;
                            ">🚨 Emergency Retry</button>
                        </div>
                    `;
                }
            }
            
            // FAILSAFE: Set up emergency backup timer in case everything fails
            setTimeout(() => {
                const leaderboardList = document.getElementById('leaderboardList');
                if (leaderboardList && (leaderboardList.innerHTML.includes('Loading leaderboard') || leaderboardList.innerHTML.trim() === '')) {
                    console.log('🚨 EMERGENCY FAILSAFE: Leaderboard still loading after 10 seconds, forcing error display');
                    leaderboardList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #e74c3c; background: #f8f9fa; border-radius: 8px; margin: 10px;">
                            <div style="font-size: 1.2em; margin-bottom: 15px;">🚨 Emergency Timeout</div>
                            <div style="margin-bottom: 15px; color: #666;">The leaderboard has been loading for over 10 seconds</div>
                            
                            <div style="background: #fff3cd; padding: 12px; border-radius: 6px; margin: 15px 0; text-align: left; font-size: 13px; color: #856404;">
                                <strong>📋 Tell your teacher this info:</strong><br>
                                <div style="font-family: monospace; background: #f8f9fa; padding: 8px; border-radius: 4px; margin-top: 8px;">
                                    Student: ${currentStudent?.name || 'Unknown'}<br>
                                    Class: ${currentClass}<br>
                                    Error: Emergency timeout (10+ seconds)<br>
                                    Date: ${new Date().toLocaleString()}<br>
                                    Browser: ${navigator.userAgent.split(' ')[0]}
                                </div>
                            </div>
                            
                            <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                                <button onclick="forceRetryLeaderboard()" style="
                                    background: #dc3545; color: white; border: none; padding: 12px 20px; 
                                    border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;
                                ">🚨 Emergency Retry</button>
                                <button onclick="location.reload()" style="
                                    background: #6c757d; color: white; border: none; padding: 12px 20px; 
                                    border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;
                                ">🔄 Refresh Page</button>
                            </div>
                        </div>
                    `;
                }
            }, 10000); // Emergency backup after 10 seconds
        }

        async function loadStudentKudos(silent = false) {
            const kudosList = document.getElementById('kudosList');
            
            try {
                console.log('Loading kudos for student ID:', currentStudent.id);
                
                if (!silent) {
                    kudosList.innerHTML = '<p style="text-align: center; color: #666;">📚 Loading your achievements...</p>';
                }
                
                // Shorter timeout for better Chromebook experience
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                // Use relative path first (correct for student portal), then fallback to full URL
                const apiUrl = `/.netlify/functions/getKudos?studentId=${encodeURIComponent(currentStudent.id)}&classCode=${encodeURIComponent(currentClass)}`;
                
                const response = await fetch(apiUrl, {
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    cache: 'no-cache'
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Kudos data:', data);
                
                if (data.success) {
                    const kudos = data.kudos || [];
                    
                    // Update current student data if returned
                    if (data.student) {
                        // Update points from database
                        currentStudent.points = data.student.points;
                        currentStudent.avatar_data = data.student.avatar_data;
                        
                        // Refresh the display with updated data
                        refreshStudentData();
                    }
                    
                    updateKudosStats(kudos);
                    updateKudosFeed(kudos, silent);
                } else {
                    throw new Error(data.message || 'Unknown error loading achievements');
                }
                
            } catch (error) {
                const errorInfo = logError('Load Student Kudos', error, {
                    endpoint: 'getKudos',
                    requestParams: { studentCode: currentStudentCode, className: currentClass },
                    silent: silent
                });
                
                if (!silent) {
                    let errorMessage = '❌ Unable to load achievements';
                    
                    if (error.name === 'AbortError') {
                        errorMessage = '⏱️ Connection timeout - Check your WiFi';
                    } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        errorMessage = '🌐 Network connection issue - Check your WiFi';
                    } else if (error.message.includes('HTTP')) {
                        errorMessage = `🔒 Server error: ${error.message}`;
                    }
                    
                    kudosList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #e74c3c; background: #f8f9fa; border-radius: 8px; margin: 10px;">
                            <div style="font-size: 1.1em; margin-bottom: 15px;">${errorMessage}</div>
                            <div style="margin-bottom: 15px; color: #666; font-size: 0.9em;">
                                If this keeps happening, ask your teacher for help
                            </div>
                            <button onclick="loadStudentKudos()" style="
                                background: #667eea; 
                                color: white; 
                                border: none; 
                                padding: 10px 20px; 
                                border-radius: 6px; 
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: bold;
                            ">
                                🔄 Try Again
                            </button>
                        </div>
                    `;
                }
            }
        }

        // Check for server updates to sync across devices
        async function checkForServerUpdates() {
            if (!currentStudent) return;
            
            try {
                const response = await fetch(`/.netlify/functions/getKudos?studentId=${currentStudent.id}&classCode=${currentClass}`);
                const data = await response.json();
                
                if (response.ok && data.success && data.student) {
                    // Check if points have changed
                    if (data.student.points !== currentStudent.points) {
                        console.log('Points updated from server:', data.student.points);
                        
                        // Show notification for new points
                        if (data.student.points > currentStudent.points) {
                            const newPoints = data.student.points - currentStudent.points;
                            showSuccessNotification(`+${newPoints} points received!`);
                        }
                        
                        currentStudent.points = data.student.points;
                        currentStudent.avatar_data = data.student.avatar_data;
                        
                        // Update display
                        refreshStudentData();
                        updateKudosStats(data.kudos || []);
                        updateKudosFeed(data.kudos || [], true);
                    }
                }
            } catch (error) {
                console.log('Server sync check failed (this is normal):', error.message);
            }
        }

        // Show success notification for points received
        function showSuccessNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
                animation: slideInRight 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Add CSS animation if not already added
            if (!document.querySelector('#notificationStyles')) {
                const style = document.createElement('style');
                style.id = 'notificationStyles';
                style.textContent = `
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOutRight {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Show error notification
        function showErrorNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #dc3545;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
                animation: slideInRight 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        function updateKudosStats(kudos) {
            // Display actual kudos points from database (NOT including game XP)
            const totalKudosPoints = currentStudent.points || 0;
            document.getElementById('totalKudos').textContent = totalKudosPoints;
            
            // SEPARATE XP SYSTEM: XP is separate from kudos points
            console.log('Total kudos points from database:', totalKudosPoints);
            console.log('All kudos received:', kudos);
            
            // Get stored XP from localStorage (separate from kudos)
            const studentXPKey = `student_xp_${currentStudent.id}`;
            let currentXP = parseInt(localStorage.getItem(studentXPKey)) || 0;
            console.log('Current stored XP:', currentXP);
            
            // Calculate expected XP from positive kudos (kudos → XP conversion)
            const positiveKudos = kudos.filter(kudo => (kudo.points || 0) > 0);
            const expectedXPFromKudos = positiveKudos.reduce((sum, kudo) => sum + (kudo.points || 0), 0);
            
            console.log('Positive kudos only:', positiveKudos);
            console.log('Expected XP from kudos:', expectedXPFromKudos);
            
            // XP should be at least equal to kudos points (kudos give XP)
            // But XP can be higher due to games (games add extra XP)
            if (expectedXPFromKudos > currentXP) {
                // Student earned new kudos, increase XP to match
                currentXP = expectedXPFromKudos;
                localStorage.setItem(studentXPKey, currentXP.toString());
                console.log('XP increased from new kudos! New XP:', currentXP);
            } else if (currentXP < expectedXPFromKudos) {
                // This shouldn't happen, but if it does, set XP to kudos minimum
                currentXP = expectedXPFromKudos;
                localStorage.setItem(studentXPKey, currentXP.toString());
                console.log('XP corrected to match kudos minimum:', currentXP);
            } else {
                console.log('XP unchanged:', currentXP);
            }
            
            console.log('Final XP for level calculation:', currentXP);
            
            // Update XP and level using the correct XP value
            updateXPDisplay(currentXP);
            
            // Calculate recent kudos (last 7 days)
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            const recentKudos = kudos.filter(kudo => {
                const kudoDate = new Date(kudo.date_awarded || kudo.created_at);
                return kudoDate >= oneWeekAgo;
            });
            
            const recentPoints = recentKudos.reduce((sum, kudo) => sum + (kudo.points || 1), 0);
            document.getElementById('recentKudos').textContent = recentPoints;
        }

        function updateKudosFeed(kudos, silent = false) {
            const kudosList = document.getElementById('kudosList');
            
            if (kudos.length === 0) {
                kudosList.innerHTML = '<p style="text-align: center; color: #666;">No achievements yet. Keep working hard!</p>';
                return;
            }
            
            // Sort kudos by date (most recent first)
            const sortedKudos = kudos.sort((a, b) => {
                const dateA = new Date(a.date_awarded || a.created_at);
                const dateB = new Date(b.date_awarded || b.created_at);
                return dateB - dateA;
            });
            
            const newKudos = !silent && sortedKudos.length > lastKudosCount;
            lastKudosCount = sortedKudos.length;
            
            kudosList.innerHTML = sortedKudos.map((kudo, index) => {
                const date = new Date(kudo.date_awarded || kudo.created_at);
                const isNew = newKudos && index === 0;
                
                return `
                    <div class="kudos-item ${isNew ? 'new' : ''}">
                        <div class="kudos-header">
                            <span class="kudos-points">+${kudo.points || 1} points</span>
                            <span class="kudos-date">${date.toLocaleDateString()}</span>
                        </div>
                        <div class="kudos-reason">${kudo.reason || 'Great work!'}</div>
                        ${kudo.description ? `<div class="kudos-description">${kudo.description}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Chromebook diagnostic and fallback system
        let diagnosticMode = false;
        let leaderboardAttempts = 0;
        
        async function testNetworkConnectivity() {
            const testUrls = [
                'https://www.google.com/favicon.ico',
                'https://classkudos-students.netlify.app/favicon.ico',
                'https://netlify.com/favicon.ico'
            ];
            
            const results = [];
            
            for (const url of testUrls) {
                try {
                    const controller = new AbortController();
                    setTimeout(() => controller.abort(), 2000);
                    
                    const response = await fetch(url, {
                        signal: controller.signal,
                        mode: 'no-cors',
                        cache: 'no-cache'
                    });
                    
                    results.push({ url: url.split('/')[2], status: 'OK' });
                } catch (error) {
                    results.push({ url: url.split('/')[2], status: 'FAILED' });
                }
            }
            
            return results;
        }
        
        // DIAGNOSTIC MODE FUNCTION - Disabled for student use
        /*
        function enableDiagnosticMode() {
            diagnosticMode = true;
            console.log('🔧 DIAGNOSTIC MODE ENABLED - Detailed logging activated');
            
            // Show diagnostic info
            const leaderboardList = document.getElementById('leaderboardList');
            leaderboardList.innerHTML = `
                <div style="text-align: center; padding: 20px; background: #e3f2fd; border-radius: 8px; margin: 10px;">
                    <h3 style="color: #1976d2; margin-bottom: 15px;">🔧 Diagnostic Mode</h3>
                    <div style="color: #333; margin-bottom: 10px; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto;">
                        <strong>Browser:</strong> ${navigator.userAgent.includes('Chrome') ? 'Chrome' : 'Other'}<br>
                        <strong>Device:</strong> ${navigator.userAgent.includes('CrOS') ? 'Chromebook' : 'Other'}<br>
                        <strong>Connection:</strong> ${navigator.onLine ? 'Online' : 'Offline'}<br>
                        <strong>Class:</strong> ${currentClass}<br>
                        <strong>Student ID:</strong> ${currentStudent?.id || 'Not set'}<br>
                        <strong>Failed Attempts:</strong> ${leaderboardAttempts}
                    </div>
                    
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin: 15px 0;">
                        <button onclick="testNetworkAndShowResults()" style="background: #2196f3; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">
                            🌐 Test Network
                        </button>
                        <button onclick="testAllMethods()" style="background: #1976d2; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">
                            🧪 Test All Methods
                        </button>
                        <button onclick="forceClearCache()" style="background: #f57c00; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">
                            🗑️ Clear Cache
                        </button>
                        <button onclick="loadLeaderboard(0); diagnosticMode=false;" style="background: #388e3c; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">
                            📊 Normal Load
                        </button>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 10px; border-radius: 4px; font-size: 0.85em; color: #856404; margin-top: 15px;">
                        � <strong>Teachers:</strong> Use these tools to help troubleshoot student connection issues.<br>
                        Students can try "Clear Cache" if the leaderboard won't load.
                    </div>
                </div>
            `;
        }
        */
        
        async function testNetworkAndShowResults() {
            const leaderboardList = document.getElementById('leaderboardList');
            
            leaderboardList.innerHTML = `
                <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 10px;">
                    <h3>🌐 Testing Network Connectivity...</h3>
                    <div style="margin: 20px 0;">Please wait while we test your connection...</div>
                </div>
            `;
            
            const results = await testNetworkConnectivity();
            
            const allPassed = results.every(r => r.status === 'OK');
            
            leaderboardList.innerHTML = `
                <div style="text-align: center; padding: 20px; background: ${allPassed ? '#d4edda' : '#f8d7da'}; border-radius: 8px; margin: 10px;">
                    <h3 style="color: ${allPassed ? '#155724' : '#721c24'};">
                        ${allPassed ? '✅ Network Test Results' : '⚠️ Network Test Results'}
                    </h3>
                    
                    <div style="margin: 15px 0; text-align: left; max-width: 300px; margin-left: auto; margin-right: auto;">
                        ${results.map(r => `
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span>${r.url}:</span>
                                <span style="color: ${r.status === 'OK' ? '#28a745' : '#dc3545'}; font-weight: bold;">
                                    ${r.status}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="color: #666; margin: 15px 0; font-size: 0.9em;">
                        ${allPassed 
                            ? 'Your network connection looks good! The issue might be with our specific API.' 
                            : 'Some network connections failed. This might be causing the leaderboard issue.'
                        }
                    </div>
                    
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                        <button onclick="testAllMethods()" style="background: #1976d2; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer;">
                            🧪 Test API Methods
                        </button>
                        <button onclick="loadLeaderboard(0); diagnosticMode=false;" style="background: #28a745; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer;">
                            📊 Try Leaderboard Again
                        </button>
                    </div>
                </div>
            `;
        }
        
        async function testAllMethods() {
            const leaderboardList = document.getElementById('leaderboardList');
            
            const testMethods = [
                {
                    name: 'Relative Path (Recommended)',
                    url: `/.netlify/functions/getLeaderboard?classCode=${encodeURIComponent(currentClass)}&t=${Date.now()}`
                },
                {
                    name: 'Alternative Domain',
                    url: `https://classkudos.org/.netlify/functions/getLeaderboard?classCode=${encodeURIComponent(currentClass)}&t=${Date.now()}`
                },
                {
                    name: 'Cross-Origin (May Fail CORS)',
                    url: `https://classkudos-students.netlify.app/.netlify/functions/getLeaderboard?classCode=${encodeURIComponent(currentClass)}&t=${Date.now()}`
                }
            ];
            
            leaderboardList.innerHTML = '<div style="text-align: center; padding: 20px;">🧪 Testing all methods...</div>';
            
            for (let i = 0; i < testMethods.length; i++) {
                const method = testMethods[i];
                
                try {
                    console.log(`Testing method ${i + 1}: ${method.name}`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000);
                    
                    const response = await fetch(method.url, {
                        signal: controller.signal,
                        headers: method.headers || {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        cache: 'no-cache'
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            console.log(`✅ SUCCESS with method: ${method.name}`);
                            updateLeaderboard(data.leaderboard || []);
                            return;
                        }
                    }
                    
                } catch (error) {
                    console.log(`❌ FAILED method ${method.name}:`, error.message);
                }
            }
            
            // If all methods fail, show comprehensive error
            leaderboardList.innerHTML = `
                <div style="text-align: center; padding: 20px; background: #ffebee; border-radius: 8px; margin: 10px;">
                    <h3 style="color: #c62828;">❌ All Methods Failed</h3>
                    <p style="color: #666; margin: 15px 0;">This suggests a network or device-specific issue.</p>
                    <button onclick="forceClearCache()" style="background: #f57c00; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px;">
                        🗑️ Force Clear Cache
                    </button>
                    <button onclick="enableDiagnosticMode()" style="background: #1976d2; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px;">
                        🔧 Run Diagnostics Again
                    </button>
                </div>
            `;
        }
        
        function forceClearCache() {
            // Clear all possible caches
            localStorage.clear();
            sessionStorage.clear();
            
            // Clear service worker cache if available
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(registration => registration.unregister());
                });
            }
            
            // Clear browser cache using cache API
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                });
            }
            
            // Add cache-busting timestamp
            const cacheBuster = Date.now();
            window.location.href = window.location.href.split('?')[0] + '?cb=' + cacheBuster;
        }

        function forceRetryLeaderboard() {
            console.log('🚨 FORCE RETRY: User clicked emergency retry button');
            const leaderboardList = document.getElementById('leaderboardList');
            
            // Show immediate feedback
            leaderboardList.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #dc3545; background: #f8f9fa; border-radius: 8px; margin: 10px;">
                    <div style="font-size: 1.2em; margin-bottom: 15px;">🚨 Emergency Retry in Progress</div>
                    <div style="color: #666; margin-bottom: 15px;">Attempting to force-load the leaderboard...</div>
                    <div style="font-size: 12px; color: #999;">This will timeout in 8 seconds if it fails</div>
                </div>
            `;
            
            // Force retry with diagnostic mode enabled
            setTimeout(() => {
                enableDiagnosticMode();
                setTimeout(() => {
                    loadLeaderboard(0);
                }, 500);
            }, 1000);
        }

        async function loadLeaderboard(retryCount = 0) {
            logVisible(`🔍 loadLeaderboard called (retry ${retryCount})`);
            
            const leaderboardList = document.getElementById('leaderboardList');
            
            // Immediate check - is the element even there?
            if (!leaderboardList) {
                logVisible('❌ CRITICAL: leaderboardList element missing!');
                showEmergencyError();
                return;
            }
            
            logVisible('✅ Element found, proceeding...');
            leaderboardAttempts++;
            
            // Show loading with visible countdown
            leaderboardList.innerHTML = `
                <div style="text-align: center; padding: 20px; background: linear-gradient(45deg, #667eea, #764ba2); color: white; border-radius: 8px; margin: 10px;">
                    <div style="font-size: 1.2em; margin-bottom: 10px;">📊 Loading Leaderboard...</div>
                    <div style="font-size: 0.9em; margin-bottom: 15px;">Attempt ${retryCount + 1} • Student: ${currentStudent?.name || 'Unknown'}</div>
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 4px; font-size: 12px;">
                        ⏱️ Emergency timeout will trigger after 10 seconds
                    </div>
                    <div style="margin-top: 10px; font-size: 11px;">
                        Debug info visible in top-right corner
                    </div>
                </div>
            `;
            
            logVisible(`🔄 Loading for: ${currentClass} / ${currentStudent?.name}`);
            
            // FORCE TIMEOUT - Show error after 6 seconds no matter what
            const forceTimeoutId = setTimeout(() => {
                console.log(`🚨 FORCE TIMEOUT: Leaderboard stuck for class "${currentClass}", student "${currentStudent?.name}"`);
                leaderboardList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #e74c3c; background: #f8f9fa; border-radius: 8px; margin: 10px;">
                        <div style="font-size: 1.2em; margin-bottom: 15px;">⏱️ Leaderboard loading timed out</div>
                        
                        <!-- DIAGNOSTIC INFO FOR TEACHER -->
                        <div style="background: #fff3cd; padding: 12px; border-radius: 6px; margin: 15px 0; text-align: left; font-size: 13px; color: #856404;">
                            <strong>📋 Tell your teacher this info:</strong><br>
                            <div style="font-family: monospace; background: #f8f9fa; padding: 8px; border-radius: 4px; margin-top: 8px;">
                                Student: ${currentStudent?.name || 'Unknown'}<br>
                                Class: ${currentClass}<br>
                                Error: Timeout (server too slow)<br>
                                Date: ${new Date().toLocaleString()}<br>
                                Attempt: ${retryCount + 1}
                            </div>
                        </div>
                        
                        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                            <button onclick="loadLeaderboard(0)" style="
                                background: #667eea; color: white; border: none; padding: 10px 16px; 
                                border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;
                            ">🔄 Try Again</button>
                            
                            <button onclick="forceClearCache()" style="
                                background: #f57c00; color: white; border: none; padding: 10px 16px; 
                                border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;
                            ">🗑️ Clear Cache</button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 4px; font-size: 0.85em; color: #2e7d32;">
                            💡 <strong>This student consistently has loading issues</strong><br>
                            The server takes too long to load their data.
                        </div>
                    </div>
                `;
            }, 6000); // Force show error after 6 seconds
            
            try {
                console.log(`🔍 DIAGNOSTIC: Loading leaderboard for class: "${currentClass}", Student: "${currentStudent?.name}" (ID: ${currentStudent?.id}), Attempt: ${retryCount + 1}, Total attempts: ${leaderboardAttempts}`);
                
                // Show loading state immediately with attempt counter
                leaderboardList.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 20px;">
                        📊 Loading leaderboard... 
                        <span style="font-size: 0.9em;">(Attempt ${retryCount + 1})</span>
                        <br><br>
                        <div style="font-size: 12px; margin-top: 10px;">
                            Will timeout in 6 seconds if server is too slow...
                        </div>
                        ${leaderboardAttempts > 3 ? `
                            <button onclick="enableDiagnosticMode()" style="background: #1976d2; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                🔧 Run Diagnostics
                            </button>
                        ` : ''}
                    </div>
                `;
                
                // Shorter timeout to prevent infinite hanging - DIAGNOSTIC FIX
                const timeoutDuration = 5000; // 5 seconds for fetch
                logVisible(`⏰ Setting ${timeoutDuration}ms timeout...`);
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    logVisible(`⏰ TIMEOUT! ${timeoutDuration}ms reached`);
                    console.log(`⏰ DIAGNOSTIC: Fetch timeout after ${timeoutDuration}ms for class "${currentClass}", student "${currentStudent?.name}" (ID: ${currentStudent?.id})`);
                    controller.abort();
                }, timeoutDuration);
                
                // COMPREHENSIVE CASE FIX + CUSTOM CODE DETECTION: Try all case variations
                let classNameToUse = currentClass;
                let isCustomCode = /^\d{4}$/.test(currentClass); // Check if it's a 4-digit code
                
                if (retryCount === 1) {
                    if (isCustomCode) {
                        // For custom codes, try using student's actual class name from their data
                        classNameToUse = currentStudent?.className || currentStudent?.class || currentStudent?.actualClass || currentClass;
                        // If we still have the custom code, try to derive the teacher name from student data
                        if (classNameToUse === currentClass && currentStudent?.teacherName) {
                            classNameToUse = currentStudent.teacherName;
                        }
                        logVisible(`🔢 Try 2: Using student class "${classNameToUse}" (code: ${currentClass})`);
                    } else {
                        // Try proper case (first letter capital, rest lowercase)
                        classNameToUse = currentClass.charAt(0).toUpperCase() + currentClass.slice(1).toLowerCase();
                        logVisible(`🔤 Try 2: Proper case "${classNameToUse}"`);
                    }
                } else if (retryCount === 2) {
                    if (isCustomCode) {
                        // For custom codes, try getting class info from the student authentication data
                        // The currentClass might actually be stored elsewhere in the student object
                        const possibleClassNames = [
                            currentStudent?.class_name,
                            currentStudent?.className, 
                            currentStudent?.teacher,
                            currentStudent?.room,
                            currentStudent?.period,
                            currentStudentCode?.split('_')[0], // Sometimes codes are like "Darr_1234"
                        ].filter(name => name && name !== currentClass && !/^\d+$/.test(name));
                        
                        classNameToUse = possibleClassNames[0] || currentClass;
                        logVisible(`🔢 Try 3: Found class "${classNameToUse}" from student data`);
                    } else {
                        // Try all lowercase
                        classNameToUse = currentClass.toLowerCase();
                        logVisible(`🔤 Try 3: Lowercase "${classNameToUse}"`);
                    }
                } else if (retryCount === 3) {
                    // Try all uppercase (for cases like "darr" -> "DARR")
                    classNameToUse = currentClass.toUpperCase();
                    logVisible(`🔤 Try 4: Uppercase "${classNameToUse}"`);
                } else if (retryCount === 4) {
                    // Try title case for multi-word classes (like "parm's class" -> "Parm's Class")
                    classNameToUse = currentClass.replace(/\w\S*/g, (txt) => 
                        txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
                    );
                    logVisible(`🔤 Try 5: Title case "${classNameToUse}"`);
                } else {
                    logVisible(`${isCustomCode ? '🔢' : '🔤'} Try 1: Original "${classNameToUse}" ${isCustomCode ? '(4-digit code detected)' : ''}`);
                }
                
                // Multiple URL strategies with cache busting - handle custom codes differently
                const cacheBuster = Date.now();
                let apiUrls;
                
                if (isCustomCode && retryCount === 2) {
                    // For custom 4-digit codes, try using studentCode parameter instead of classCode
                    apiUrls = [
                        `/.netlify/functions/getLeaderboard?studentCode=${encodeURIComponent(classNameToUse)}&cb=${cacheBuster}`,
                        `https://classkudos.org/.netlify/functions/getLeaderboard?studentCode=${encodeURIComponent(classNameToUse)}&cb=${cacheBuster}`,
                        `https://classkudos-students.netlify.app/.netlify/functions/getLeaderboard?studentCode=${encodeURIComponent(classNameToUse)}&cb=${cacheBuster}`
                    ];
                    logVisible(`🔧 Using studentCode param for custom code`);
                } else {
                    // Standard classCode parameter
                    apiUrls = [
                        `/.netlify/functions/getLeaderboard?classCode=${encodeURIComponent(classNameToUse)}&cb=${cacheBuster}`,
                        `https://classkudos.org/.netlify/functions/getLeaderboard?classCode=${encodeURIComponent(classNameToUse)}&cb=${cacheBuster}`,
                        `https://classkudos-students.netlify.app/.netlify/functions/getLeaderboard?classCode=${encodeURIComponent(classNameToUse)}&cb=${cacheBuster}`
                    ];
                }
                
                const apiUrl = apiUrls[retryCount] || apiUrls[0];
                console.log(`🔗 DIAGNOSTIC: API URL: ${apiUrl}`);
                console.log(`� DIAGNOSTIC: Encoded class name: "${encodeURIComponent(currentClass)}"`);
                
                const fetchOptions = {
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    },
                    cache: 'no-cache',
                    credentials: 'omit' // Don't send cookies - can help with CORS
                };
                
                logVisible('🔌 About to start fetch...');
                
                // DIAGNOSIS FIX: Try adding student parameters for problematic students
                let finalUrl = apiUrl;
                if (retryCount > 0) {
                    finalUrl = `${apiUrl}&studentCode=${encodeURIComponent(currentStudentCode || '')}&studentId=${encodeURIComponent(currentStudent?.id || '')}`;
                    logVisible(`🔧 Adding student params for retry ${retryCount}`);
                }
                
                logVisible(`👤 Student: ${currentStudent?.name} (${currentStudentCode})`);
                logVisible(`🏫 Class: ${classNameToUse} ${isCustomCode ? '(Custom Code)' : '(Standard Name)'}`);
                
                // DEBUG: Show all available student data for custom codes
                if (isCustomCode && retryCount === 0) {
                    logVisible(`🔍 Student data keys: ${Object.keys(currentStudent || {}).join(', ')}`);
                    console.log(`🔍 DIAGNOSTIC: Full student object for custom code analysis:`, currentStudent);
                }
                
                console.log(`🔗 DIAGNOSTIC: Final URL: ${finalUrl}`);
                console.log(`🔍 DIAGNOSTIC: Custom code detected: ${isCustomCode}, Original: "${currentClass}", Using: "${classNameToUse}"`);
                
                const response = await fetch(finalUrl, fetchOptions);
                logVisible(`📥 Fetch completed! Status: ${response.status}`);
                
                // Clear both timeouts on success
                clearTimeout(timeoutId);
                clearTimeout(forceTimeoutId);
                console.log(`📡 DIAGNOSTIC: Response status: ${response.status}, Headers:`, response.headers);
                
                if (!response.ok) {
                    logVisible(`❌ Bad response: ${response.status}`);
                    const errorText = await response.text();
                    console.error(`❌ DIAGNOSTIC: HTTP Error Response Body:`, errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                }
                
                logVisible('📄 Parsing JSON response...');
                const data = await response.json();
                logVisible(`📊 JSON parsed. Success: ${data.success}`);
                console.log(`📊 DIAGNOSTIC: Response data success: ${data.success}, Leaderboard entries: ${data.leaderboard?.length || 'undefined'}`);
                
                if (data.success) {
                    logVisible(`✅ Data valid. ${data.leaderboard?.length || 0} students`);
                    logVisible(`🔍 Class worked: "${classNameToUse}" vs original "${currentClass}"`);
                    
                    // If we get 0 students and haven't tried all case variations, auto-retry
                    if (data.leaderboard.length === 0 && retryCount < 4) {
                        logVisible(`⚠️ Empty result - trying next case variation`);
                        setTimeout(() => loadLeaderboard(retryCount + 1), 1000);
                        return;
                    }
                    
                    console.log(`✅ DIAGNOSTIC: Successfully loaded ${data.leaderboard.length} students`);
                    console.log(`🔍 DIAGNOSTIC: Working class name: "${classNameToUse}" (original: "${currentClass}")`);
                    console.log(`🔍 DIAGNOSTIC: Case fix successful: ${classNameToUse !== currentClass ? 'YES' : 'NO'}`);
                    data.leaderboard.forEach((student, index) => {
                        console.log(`👤 DIAGNOSTIC: Student ${index + 1}: "${student.name}" (ID: ${student.id}) - Points: ${student.total_points}, Avatar: ${student.avatar_data ? 'present' : 'missing'}`);
                    });
                    logVisible('🎯 Calling updateLeaderboard...');
                    updateLeaderboard(data.leaderboard || []);
                    logVisible('✅ updateLeaderboard completed!');
                    leaderboardAttempts = 0; // Reset counter on success
                } else {
                    logVisible(`❌ Server said success=false`);
                    console.error(`❌ DIAGNOSTIC: Server returned success=false, Message: "${data.message || 'No message provided'}"`);
                    throw new Error(data.message || 'Server returned success=false');
                }
                
            } catch (error) {
                // Clear the force timeout since we're handling the error properly
                clearTimeout(forceTimeoutId);
                
                console.error(`❌ DIAGNOSTIC: Leaderboard error for class "${currentClass}" (attempt ${retryCount + 1}):`, error);
                console.error(`🔍 DIAGNOSTIC: Error details - Name: ${error.name}, Message: ${error.message}, Stack:`, error.stack);
                
                // Auto-retry with different strategies - increased retry count for case variations
                if (retryCount < 4 && (error.name === 'AbortError' || error.message.includes('Failed to fetch') || 
                    (data && data.success && data.leaderboard && data.leaderboard.length === 0))) {
                    logVisible(`🔄 Auto-retry ${retryCount + 1}/5 due to: ${error.name === 'AbortError' ? 'timeout' : 'empty result'}`);
                    console.log('Auto-retrying with different strategy...');
                    setTimeout(() => loadLeaderboard(retryCount + 1), 1000);
                    return;
                }
                
                const errorInfo = logError('Load Leaderboard', error, {
                    endpoint: 'getLeaderboard',
                    requestParams: { studentCode: currentStudentCode, className: currentClass },
                    retryCount: retryCount,
                    totalAttempts: leaderboardAttempts
                });
                
                // Enhanced error display with more options
                let errorMessage = `❌ Leaderboard failed to load`;
                
                if (error.name === 'AbortError') {
                    errorMessage = '⏱️ Connection timeout - Try again in a moment';
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMessage = '🌐 Network connection issue - Check your WiFi';
                } else if (error.message.includes('HTTP')) {
                    errorMessage = `🔒 Server error: ${error.message}`;
                } else {
                    errorMessage = '🔧 Technical issue - Multiple solutions below';
                }
                
                leaderboardList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #e74c3c; background: #f8f9fa; border-radius: 8px; margin: 10px;">
                        <div style="font-size: 1.2em; margin-bottom: 15px;">${errorMessage}</div>
                        <div style="margin-bottom: 20px; color: #666; font-size: 0.9em;">
                            ${retryCount > 0 ? 'Multiple attempts failed. ' : ''}Try the options below:
                        </div>
                        
                        <!-- DIAGNOSTIC INFO FOR TEACHER -->
                        <div style="background: #fff3cd; padding: 12px; border-radius: 6px; margin: 15px 0; text-align: left; font-size: 13px; color: #856404;">
                            <strong>📋 Tell your teacher this info:</strong><br>
                            <div style="font-family: monospace; background: #f8f9fa; padding: 8px; border-radius: 4px; margin-top: 8px;">
                                Student: ${currentStudent?.name || 'Unknown'}<br>
                                Class: ${currentClass}<br>
                                Error: ${error.name === 'AbortError' ? 'Timeout (took too long)' : 'Connection failed'}<br>
                                Date: ${new Date().toLocaleString()}<br>
                                Retry Attempt: ${retryCount + 1}/3
                            </div>
                        </div>
                        
                        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                            <button onclick="loadLeaderboard(0)" style="
                                background: #667eea; color: white; border: none; padding: 10px 16px; 
                                border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;
                            ">🔄 Try Again</button>
                            
                            <button onclick="forceClearCache()" style="
                                background: #f57c00; color: white; border: none; padding: 10px 16px; 
                                border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;
                            ">🗑️ Clear Cache</button>
                            
                            <button onclick="enableDiagnosticMode()" style="
                                background: #1976d2; color: white; border: none; padding: 10px 16px; 
                                border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;
                            ">🔧 Diagnostics</button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 4px; font-size: 0.85em; color: #2e7d32;">
                            💡 <strong>Quick Fixes:</strong><br>
                            1. Wait 10 seconds and try "Try Again"<br>
                            2. Click "Clear Cache" and refresh page<br>
                            3. Close Chrome completely and reopen
                        </div>
                    </div>
                `;
            }
        }

        function updateLeaderboard(leaderboard) {
            logVisible(`🎯 updateLeaderboard called with ${leaderboard?.length || 0} students`);
            
            const leaderboardList = document.getElementById('leaderboardList');
            
            if (!leaderboardList) {
                logVisible('❌ leaderboardList element missing!');
                return;
            }
            
            if (leaderboard.length === 0) {
                logVisible('⚠️ Empty leaderboard - showing helpful message');
                leaderboardList.innerHTML = `
                    <div style="text-align: center; padding: 30px; background: linear-gradient(45deg, #667eea, #764ba2); color: white; border-radius: 12px; margin: 10px;">
                        <div style="font-size: 1.3em; margin-bottom: 15px;">📊 Leaderboard Empty</div>
                        <div style="margin-bottom: 20px; font-size: 1.1em;">No students found in this class</div>
                        
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; margin: 15px 0; text-align: left; font-size: 13px;">
                            <strong>📋 Tell your teacher this info:</strong><br>
                            <div style="font-family: monospace; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; margin-top: 8px;">
                                Student: ${currentStudent?.name || 'Unknown'}<br>
                                Class: ${currentClass}<br>
                                Issue: Server returned 0 students<br>
                                Time: ${new Date().toLocaleString()}<br>
                                Status: Connection successful, but no data
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 6px; font-size: 0.9em;">
                            <strong>🤔 Possible reasons:</strong><br>
                            • No students have earned points yet<br>
                            • Class name doesn't match database<br>
                            • Database connection issue<br>
                            • Students haven't been added to system
                        </div>
                        
                        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px;">
                            <button onclick="loadLeaderboard(0)" style="
                                background: #28a745; color: white; border: 2px solid white; padding: 12px 20px; 
                                border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;
                            ">🔄 Try Again</button>
                            
                            <button onclick="window.location.reload()" style="
                                background: #ffc107; color: black; border: 2px solid white; padding: 12px 20px; 
                                border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;
                            ">🔄 Refresh Page</button>
                            
                            <button onclick="document.getElementById('visibleDiagnostic').style.display='block';" style="
                                background: #17a2b8; color: white; border: 2px solid white; padding: 12px 20px; 
                                border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;
                            ">🔧 Show Debug</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            logVisible('🔄 Building leaderboard HTML...');
            try {
                leaderboardList.innerHTML = leaderboard.map((student, index) => {
                    const isCurrentStudent = student.id === currentStudent.id;
                    const rank = index + 1;
                    const level = calculateLevel(student.total_points);
                    const avatar = student.avatar_data || 'default';
                    
                    // Update current student's rank
                    if (isCurrentStudent) {
                        const rankElement = document.getElementById('classRank');
                        if (rankElement) {
                            rankElement.textContent = `#${rank}`;
                        }
                    }
                
                return `
                    <div style="display: flex; align-items: center; padding: 15px; margin-bottom: 10px; 
                                background: ${isCurrentStudent ? '#e3f2fd' : '#f8f9fa'}; 
                                border-radius: 8px; ${isCurrentStudent ? 'border: 2px solid #2196f3;' : ''}">
                        <div style="font-size: 1.5em; font-weight: bold; color: #667eea; margin-right: 15px; min-width: 40px;">
                            #${rank}
                        </div>
                        <div class="avatar" style="margin-right: 15px; width: 50px; height: 50px;">
                            <img src="${getAvatarUrl(avatar)}" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        </div>
                        <div style="flex-grow: 1;">
                            <div style="font-weight: 500; color: #333;">
                                ${student.name} ${isCurrentStudent ? '(You)' : ''}
                            </div>
                            <div style="color: #666; font-size: 0.9em;">
                                Level ${level} • ${student.total_points} points
                            </div>
                        </div>
                        <div style="background: #28a745; color: white; padding: 8px 12px; border-radius: 15px; font-weight: bold;">
                            ${student.total_points}
                        </div>
                    </div>
                `;
            }).join('');
            
            logVisible('✅ Leaderboard HTML updated successfully!');
            
        } catch (error) {
            logVisible(`❌ Error in updateLeaderboard: ${error.message}`);
            console.error('Error updating leaderboard:', error);
            leaderboardList.innerHTML = `
                <div style="text-align: center; padding: 20px; background: #ffebee; border-radius: 8px; color: #c62828;">
                    ❌ Error displaying leaderboard: ${error.message}
                </div>
            `;
        }
        }

        function showSection(section) {
            console.log('Showing section:', section);
            
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Hide all content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(section).classList.add('active');
            
            // Load data for specific sections
            if (section === 'dashboard') {
                // Refresh dashboard with latest XP data
                refreshStudentData();
            } else if (section === 'myKudos') {
                loadStudentKudos();
            } else if (section === 'leaderboard') {
                loadLeaderboard();
            } else if (section === 'kudosColosseum') {
                initializeColosseum();
            } else if (section === 'morphemeMastery') {
                initializeMorphemeMastery();
            }
        }

        function initializeMorphemeMastery() {
            // Reset to selection screen if coming from another section
            document.getElementById('morphemeGameResults').classList.add('hidden');
            document.getElementById('morphemeGameArea').classList.add('hidden');
            document.getElementById('morphemeDifficultySelector').classList.add('hidden');
            document.querySelector('.morpheme-selection').classList.remove('hidden');
            
            // Reset game state
            currentMorphemeGame = {
                type: null,
                difficulty: null,
                score: 0,
                streak: 0,
                timeLeft: 90,
                totalProblems: 0,
                correctAnswers: 0,
                problems: [],
                currentProblem: null,
                gameTimer: null
            };
        }

        // ===============================
        // KUDOS COLOSSEUM GAME LOGIC
        // ===============================
        
        let currentGame = {
            type: null,           // 'multiplication', 'division', 'mixed'
            difficulty: null,     // 'easy', 'medium', 'hard'
            score: 0,
            streak: 0,
            timeLeft: 60,
            currentProblem: null,
            totalProblems: 0,
            correctAnswers: 0,
            gameTimer: null,
            problems: []
        };

        // Audio feedback system using Web Audio API beeps
        let audioEnabled = true;
        let audioContext = null;
        
        // Initialize audio context
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }
        
        // Create beep sounds
        function createBeep(frequency, duration, type = 'sine') {
            const ctx = initAudioContext();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = type;
            
            gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
            
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + duration);
        }
        
        // Load original positive sound for level ups only
        const levelUpAudio = new Audio('../Audio/Positive.wav');
        levelUpAudio.volume = 0.8;

        // Colosseum Achievements System
        const colosseumAchievements = {
            'first_victory': {
                title: '⚔️ First Victory',
                description: 'Complete your first Colosseum challenge',
                xpReward: 5,
                icon: '🏛️'
            },
            'perfect_warrior': {
                title: '👑 Perfect Warrior',
                description: 'Achieve 100% accuracy in a challenge',
                xpReward: 10,
                icon: '✨'
            },
            'speed_demon': {
                title: '⚡ Lightning Calculator',
                description: 'Complete a challenge with 45+ seconds remaining',
                xpReward: 8,
                icon: '🚀'
            },
            'streak_master': {
                title: '🔥 Streak Master',
                description: 'Get 10 answers correct in a row',
                xpReward: 12,
                icon: '🎯'
            },
            'math_gladiator': {
                title: '🏆 Math Gladiator',
                description: 'Complete 10 Colosseum challenges',
                xpReward: 20,
                icon: '👑'
            },
            'multiplication_champion': {
                title: '✖️ Multiplication Champion',
                description: 'Score 90%+ accuracy in 5 multiplication challenges',
                xpReward: 15,
                icon: '🥇'
            },
            'division_master': {
                title: '➗ Division Master',
                description: 'Score 90%+ accuracy in 5 division challenges',
                xpReward: 15,
                icon: '🥇'
            },
            'colosseum_legend': {
                title: '🌟 Colosseum Legend',
                description: 'Earn 1000 total XP from the Colosseum',
                xpReward: 25,
                icon: '👑'
            }
        };

        // Morpheme Mastery Data
        const morphemeData = {
            prefixes: [
                { morpheme: 'un-', meaning: 'not, opposite of', example: 'unhappy' },
                { morpheme: 're-', meaning: 'again, back', example: 'rewrite' },
                { morpheme: 'pre-', meaning: 'before', example: 'preview' },
                { morpheme: 'dis-', meaning: 'not, opposite of', example: 'disagree' },
                { morpheme: 'mis-', meaning: 'wrong, bad', example: 'mistake' },
                { morpheme: 'over-', meaning: 'too much, above', example: 'overflow' },
                { morpheme: 'under-', meaning: 'below, not enough', example: 'undercooked' },
                { morpheme: 'sub-', meaning: 'under, below', example: 'submarine' },
                { morpheme: 'super-', meaning: 'above, beyond', example: 'superhero' },
                { morpheme: 'anti-', meaning: 'against', example: 'antibiotic' },
                { morpheme: 'auto-', meaning: 'self', example: 'automatic' },
                { morpheme: 'co-', meaning: 'with, together', example: 'cooperate' },
                { morpheme: 'ex-', meaning: 'out of, former', example: 'exit' },
                { morpheme: 'inter-', meaning: 'between', example: 'international' },
                { morpheme: 'non-', meaning: 'not', example: 'nonfiction' },
                { morpheme: 'semi-', meaning: 'half, partly', example: 'semicircle' },
                { morpheme: 'bi-', meaning: 'two', example: 'bicycle' },
                { morpheme: 'tri-', meaning: 'three', example: 'triangle' },
                { morpheme: 'multi-', meaning: 'many', example: 'multiple' },
                { morpheme: 'uni-', meaning: 'one', example: 'unicycle' }
            ],
            suffixes: [
                { morpheme: '-ed', meaning: 'past tense', example: 'walked' },
                { morpheme: '-ing', meaning: 'present participle', example: 'walking' },
                { morpheme: '-er', meaning: 'one who, more', example: 'teacher' },
                { morpheme: '-est', meaning: 'most', example: 'tallest' },
                { morpheme: '-ly', meaning: 'in a way', example: 'quickly' },
                { morpheme: '-tion', meaning: 'act of, state of', example: 'action' },
                { morpheme: '-sion', meaning: 'act of, state of', example: 'decision' },
                { morpheme: '-ness', meaning: 'state of being', example: 'kindness' },
                { morpheme: '-ment', meaning: 'result of action', example: 'movement' },
                { morpheme: '-ful', meaning: 'full of', example: 'helpful' },
                { morpheme: '-less', meaning: 'without', example: 'hopeless' },
                { morpheme: '-able', meaning: 'capable of', example: 'readable' },
                { morpheme: '-ible', meaning: 'capable of', example: 'visible' },
                { morpheme: '-ous', meaning: 'full of', example: 'dangerous' },
                { morpheme: '-al', meaning: 'relating to', example: 'musical' },
                { morpheme: '-ic', meaning: 'relating to', example: 'historic' },
                { morpheme: '-ive', meaning: 'having the quality of', example: 'active' },
                { morpheme: '-y', meaning: 'having the quality of', example: 'rainy' },
                { morpheme: '-ward', meaning: 'in the direction of', example: 'forward' },
                { morpheme: '-ship', meaning: 'state of being', example: 'friendship' }
            ],
            latin: [
                { morpheme: 'port', meaning: 'carry', example: 'transport' },
                { morpheme: 'dict', meaning: 'say, speak', example: 'dictionary' },
                { morpheme: 'spect', meaning: 'look, see', example: 'inspect' },
                { morpheme: 'ject', meaning: 'throw', example: 'project' },
                { morpheme: 'tract', meaning: 'pull, drag', example: 'attract' },
                { morpheme: 'struct', meaning: 'build', example: 'construct' },
                { morpheme: 'rupt', meaning: 'break', example: 'erupt' },
                { morpheme: 'scrib/script', meaning: 'write', example: 'describe' },
                { morpheme: 'vid/vis', meaning: 'see', example: 'video' },
                { morpheme: 'aud', meaning: 'hear', example: 'audio' },
                { morpheme: 'cap/cept', meaning: 'take, seize', example: 'capture' },
                { morpheme: 'mit/miss', meaning: 'send', example: 'transmit' },
                { morpheme: 'ped/pod', meaning: 'foot', example: 'pedal' },
                { morpheme: 'man', meaning: 'hand', example: 'manual' },
                { morpheme: 'duc/duct', meaning: 'lead', example: 'conduct' },
                { morpheme: 'fac/fact', meaning: 'make, do', example: 'factory' },
                { morpheme: 'loc', meaning: 'place', example: 'location' },
                { morpheme: 'mob/mov', meaning: 'move', example: 'mobile' },
                { morpheme: 'terr', meaning: 'earth, land', example: 'territory' },
                { morpheme: 'temp', meaning: 'time', example: 'temporary' }
            ],
            greek: [
                { morpheme: 'bio', meaning: 'life', example: 'biology' },
                { morpheme: 'geo', meaning: 'earth', example: 'geography' },
                { morpheme: 'photo', meaning: 'light', example: 'photograph' },
                { morpheme: 'graph', meaning: 'write, draw', example: 'autograph' },
                { morpheme: 'tele', meaning: 'far, distant', example: 'telephone' },
                { morpheme: 'auto', meaning: 'self', example: 'autobiography' },
                { morpheme: 'micro', meaning: 'small', example: 'microscope' },
                { morpheme: 'macro', meaning: 'large', example: 'macroscope' },
                { morpheme: 'phil', meaning: 'love', example: 'philosophy' },
                { morpheme: 'phon', meaning: 'sound', example: 'microphone' },
                { morpheme: 'scope', meaning: 'see, look', example: 'telescope' },
                { morpheme: 'meter', meaning: 'measure', example: 'thermometer' },
                { morpheme: 'therm', meaning: 'heat', example: 'thermal' },
                { morpheme: 'chron', meaning: 'time', example: 'chronological' },
                { morpheme: 'demo', meaning: 'people', example: 'democracy' },
                { morpheme: 'psych', meaning: 'mind, soul', example: 'psychology' },
                { morpheme: 'log', meaning: 'study, word', example: 'dialogue' },
                { morpheme: 'path', meaning: 'feeling, disease', example: 'sympathy' },
                { morpheme: 'ology', meaning: 'study of', example: 'biology' },
                { morpheme: 'phobia', meaning: 'fear of', example: 'claustrophobia' }
            ]
        };

        let currentMorphemeGame = {
            type: null,
            difficulty: null,
            score: 0,
            streak: 0,
            timeLeft: 60,
            totalProblems: 0,
            correctAnswers: 0,
            problems: [],
            currentProblem: null,
            gameTimer: null
        };

        function playAudio(isCorrect) {
            if (!audioEnabled) return;
            
            try {
                // Resume audio context if suspended (Chrome requirement)
                const ctx = initAudioContext();
                if (ctx.state === 'suspended') {
                    ctx.resume();
                }
                
                if (isCorrect) {
                    // Happy beep: High note
                    createBeep(800, 0.2);
                } else {
                    // Sad beep: Low note
                    createBeep(300, 0.3);
                }
            } catch (error) {
                console.log('Audio error:', error);
            }
        }
        
        function playLevelUpSound() {
            if (!audioEnabled) return;
            
            try {
                // Use original positive sound for level ups
                levelUpAudio.currentTime = 0;
                levelUpAudio.play().catch(e => {
                    console.log('Level up audio failed, using beep fallback');
                    // Fallback to celebratory beep sequence
                    createBeep(523, 0.2); // C
                    setTimeout(() => createBeep(659, 0.2), 200); // E
                    setTimeout(() => createBeep(784, 0.4), 400); // G
                });
            } catch (error) {
                console.log('Level up audio error:', error);
            }
        }

        function toggleAudio() {
            audioEnabled = !audioEnabled;
            localStorage.setItem('colosseumAudioEnabled', audioEnabled.toString());
            
            const button = document.getElementById('audioToggle');
            if (button) {
                button.textContent = audioEnabled ? '🔊 Audio On' : '🔇 Audio Off';
                button.style.opacity = audioEnabled ? '1' : '0.6';
            }
        }

        // Load audio preference
        function loadAudioPreference() {
            const saved = localStorage.getItem('colosseumAudioEnabled');
            if (saved !== null) {
                audioEnabled = saved === 'true';
            }
        }

        function initializeColosseum() {
            console.log('Initializing Kudos Colosseum');
            loadAudioPreference();
            updateAudioButton();
            resetGame();
        }

        function updateAudioButton() {
            const button = document.getElementById('audioToggle');
            if (button) {
                button.textContent = audioEnabled ? '🔊 Audio On' : '🔇 Audio Off';
                button.style.opacity = audioEnabled ? '1' : '0.6';
            }
        }

        function showAchievements() {
            const modal = document.getElementById('achievementsModal');
            const content = document.getElementById('achievementsContent');
            
            const unlockedAchievements = JSON.parse(localStorage.getItem('colosseumAchievements') || '[]');
            
            let html = '';
            
            Object.entries(colosseumAchievements).forEach(([id, achievement]) => {
                const isUnlocked = unlockedAchievements.includes(id);
                const progressInfo = getAchievementProgress(id);
                
                html += `
                    <div style="background: ${isUnlocked ? 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)' : '#f0f0f0'}; 
                                color: ${isUnlocked ? 'black' : '#666'}; 
                                padding: 15px; 
                                border-radius: 10px; 
                                margin-bottom: 15px;
                                border: ${isUnlocked ? '3px solid gold' : '2px solid #ddd'};">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 2em; ${isUnlocked ? '' : 'filter: grayscale(100%); opacity: 0.5;'}">${achievement.icon}</div>
                            <div style="flex: 1;">
                                <h4 style="margin: 0; ${isUnlocked ? 'color: black;' : 'color: #666;'}">${achievement.title}</h4>
                                <p style="margin: 5px 0; ${isUnlocked ? 'color: #333;' : 'color: #888;'}">${achievement.description}</p>
                                ${progressInfo ? `<p style="margin: 5px 0; font-size: 0.9em; ${isUnlocked ? 'color: #555;' : 'color: #aaa;'}">${progressInfo}</p>` : ''}
                                <p style="margin: 5px 0; font-weight: bold; ${isUnlocked ? 'color: #8B4513;' : 'color: #999;'}">Reward: ${achievement.xpReward} XP</p>
                            </div>
                            <div style="font-size: 1.5em;">
                                ${isUnlocked ? '✅' : '🔒'}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Add overall progress stats
            const totalChallenges = parseInt(localStorage.getItem('colosseum_total_challenges') || '0');
            const totalXP = parseInt(localStorage.getItem('colosseum_total_xp') || '0');
            const multiplicationWins = parseInt(localStorage.getItem('colosseum_multiplication_90plus') || '0');
            const divisionWins = parseInt(localStorage.getItem('colosseum_division_90plus') || '0');
            
            html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                    <h4>🏛️ Your Colosseum Legacy</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
                        <div><strong>Total Battles:</strong><br>${totalChallenges}</div>
                        <div><strong>Total XP Earned:</strong><br>${totalXP}</div>
                        <div><strong>× Mastery Wins:</strong><br>${multiplicationWins}</div>
                        <div><strong>÷ Mastery Wins:</strong><br>${divisionWins}</div>
                    </div>
                </div>
            ` + html;
            
            content.innerHTML = html;
            modal.style.display = 'block';
        }

        function getAchievementProgress(achievementId) {
            switch(achievementId) {
                case 'math_gladiator':
                    const challenges = parseInt(localStorage.getItem('colosseum_total_challenges') || '0');
                    return `Progress: ${challenges}/10 challenges completed`;
                case 'multiplication_champion':
                    const multWins = parseInt(localStorage.getItem('colosseum_multiplication_90plus') || '0');
                    return `Progress: ${multWins}/5 high-accuracy multiplication rounds`;
                case 'division_master':
                    const divWins = parseInt(localStorage.getItem('colosseum_division_90plus') || '0');
                    return `Progress: ${divWins}/5 high-accuracy division rounds`;
                case 'colosseum_legend':
                    const totalXP = parseInt(localStorage.getItem('colosseum_total_xp') || '0');
                    return `Progress: ${totalXP}/1000 XP earned from Colosseum`;
                default:
                    return null;
            }
        }

        function closeAchievementsModal() {
            document.getElementById('achievementsModal').style.display = 'none';
        }

        function startChallenge(type) {
            currentGame.type = type;
            document.querySelector('.challenge-selection').classList.add('hidden');
            
            // Set up difficulty options based on challenge type
            const difficultyContainer = document.getElementById('difficultyOptions');
            const difficultyTitle = document.getElementById('difficultyTitle');
            
            let options = [];
            
            if (type === 'multiplication') {
                difficultyTitle.textContent = 'Choose Multiplication Difficulty';
                options = [
                    { id: 'easy', text: 'Easy (1-5)', points: '2 XP' },
                    { id: 'medium', text: 'Medium (1-10)', points: '4 XP' },
                    { id: 'hard', text: 'Hard (1-12)', points: '10 XP' },
                    { id: 'multiplication15', text: 'Advanced (1-15)', points: '6 XP' },
                    { id: 'multiplication20', text: 'Expert (1-20)', points: '8 XP' },
                    { id: 'multidigit', text: 'Multi-digit Extreme', points: '20 XP' }
                ];
            } else if (type === 'division') {
                difficultyTitle.textContent = 'Choose Division Difficulty';
                options = [
                    { id: 'easy', text: 'Easy (1-5)', points: '2 XP' },
                    { id: 'medium', text: 'Medium (1-10)', points: '4 XP' },
                    { id: 'hard', text: 'Hard (1-12)', points: '10 XP' },
                    { id: 'longdivision', text: 'Long Division', points: '18 XP' }
                ];
            } else { // mixed
                difficultyTitle.textContent = 'Choose Mixed Challenge Difficulty';
                options = [
                    { id: 'easy', text: 'Easy (1-5)', points: '2 XP' },
                    { id: 'medium', text: 'Medium (1-10)', points: '4 XP' },
                    { id: 'hard', text: 'Hard (1-12)', points: '10 XP' }
                ];
            }
            
            // Generate HTML for difficulty buttons
            difficultyContainer.innerHTML = options.map(option => 
                `<button class="difficulty-btn" onclick="startGame('${option.id}')">
                    ${option.text}<br><small style="color: #888;">${option.points}</small>
                </button>`
            ).join('');
            
            document.getElementById('difficultySelector').classList.remove('hidden');
        }

        function startGame(difficulty) {
            currentGame.difficulty = difficulty;
            currentGame.score = 0;
            currentGame.streak = 0;
            currentGame.timeLeft = 60;
            currentGame.totalProblems = 0;
            currentGame.correctAnswers = 0;
            
            // Hide difficulty selector and show game area
            document.getElementById('difficultySelector').classList.add('hidden');
            document.getElementById('gameArea').classList.remove('hidden');
            
            // Set up difficulty ranges and problem types
            let maxNumber, problemConfig;
            switch(difficulty) {
                case 'easy': 
                    maxNumber = 5; 
                    problemConfig = { type: 'basic', max: 5 };
                    break;
                case 'medium': 
                    maxNumber = 10; 
                    problemConfig = { type: 'basic', max: 10 };
                    break;
                case 'hard': 
                    maxNumber = 12; 
                    problemConfig = { type: 'basic', max: 12 };
                    break;
                case 'multiplication15':
                    maxNumber = 15;
                    problemConfig = { type: 'multiplication', max: 15 };
                    break;
                case 'multiplication20':
                    maxNumber = 20;
                    problemConfig = { type: 'multiplication', max: 20 };
                    break;
                case 'multidigit':
                    maxNumber = 99;
                    problemConfig = { type: 'multidigit', max: 99 };
                    break;
                case 'longdivision':
                    maxNumber = 12;
                    problemConfig = { type: 'longdivision', max: 12 };
                    break;
                default: 
                    maxNumber = 10;
                    problemConfig = { type: 'basic', max: 10 };
            }
            
            // Generate problems for the session
            generateProblems(problemConfig);
            
            // Start the game
            nextProblem();
            startTimer();
            
            // Focus on answer input
            document.getElementById('answerInput').focus();
        }

        function generateProblems(problemConfig) {
            currentGame.problems = [];
            
            // Generate 20 problems for the session
            for(let i = 0; i < 20; i++) {
                let problem = createProblem(problemConfig);
                currentGame.problems.push(problem);
            }
        }

        function createProblem(config) {
            let num1, num2, operation, answer, displayText;
            
            switch(config.type) {
                case 'basic':
                    num1 = Math.floor(Math.random() * config.max) + 1;
                    num2 = Math.floor(Math.random() * config.max) + 1;
                    
                    if (currentGame.type === 'multiplication') {
                        operation = '×';
                        answer = num1 * num2;
                    } else if (currentGame.type === 'division') {
                        // For division, make sure we get whole number answers
                        answer = num1;
                        num1 = num1 * num2;
                        operation = '÷';
                    } else { // mixed
                        if (Math.random() < 0.5) {
                            operation = '×';
                            answer = num1 * num2;
                        } else {
                            // Division with whole number answer
                            answer = num1;
                            num1 = num1 * num2;
                            operation = '÷';
                        }
                    }
                    displayText = `${num1} ${operation} ${num2} = ?`;
                    break;
                    
                case 'multiplication':
                    num1 = Math.floor(Math.random() * config.max) + 1;
                    num2 = Math.floor(Math.random() * config.max) + 1;
                    operation = '×';
                    answer = num1 * num2;
                    displayText = `${num1} × ${num2} = ?`;
                    break;
                    
                case 'multidigit':
                    // Generate truly extreme multiplication: 3-digit × 2-digit or 3-digit × 3-digit
                    if (Math.random() < 0.5) {
                        // 3-digit × 2-digit (e.g., 347 × 86)
                        num1 = Math.floor(Math.random() * 900) + 100; // 100-999
                        num2 = Math.floor(Math.random() * 90) + 10;   // 10-99
                    } else {
                        // 3-digit × 3-digit (e.g., 456 × 123)
                        num1 = Math.floor(Math.random() * 900) + 100; // 100-999
                        num2 = Math.floor(Math.random() * 900) + 100; // 100-999
                    }
                    operation = '×';
                    answer = num1 * num2;
                    displayText = `${num1} × ${num2} = ?`;
                    break;
                    
                case 'longdivision':
                    // Create challenging long division: 4-digit ÷ 2-digit (like 8754 ÷ 19)
                    num2 = Math.floor(Math.random() * 81) + 12; // divisor 12-92 (2-digit)
                    let quotient = Math.floor(Math.random() * 400) + 50; // quotient 50-449 (2-3 digits)
                    num1 = num2 * quotient; // dividend (ensures whole number answer)
                    // Ensure dividend is 4-digit
                    if (num1 < 1000) {
                        num1 += 1000; // Make it at least 4-digit
                        quotient = Math.floor(num1 / num2); // Recalculate exact quotient
                    }
                    operation = '÷';
                    answer = quotient;
                    displayText = `${num1} ÷ ${num2} = ?`;
                    break;
                    
                default:
                    num1 = Math.floor(Math.random() * config.max) + 1;
                    num2 = Math.floor(Math.random() * config.max) + 1;
                    operation = '×';
                    answer = num1 * num2;
                    displayText = `${num1} × ${num2} = ?`;
            }
            
            return {
                num1: num1,
                num2: num2,
                operation: operation,
                answer: answer,
                displayText: displayText
            };
        }

        function nextProblem() {
            if (currentGame.totalProblems >= currentGame.problems.length || currentGame.timeLeft <= 0) {
                endGame();
                return;
            }
            
            currentGame.currentProblem = currentGame.problems[currentGame.totalProblems];
            
            // Display the problem using the preformatted displayText or fallback
            const problemText = currentGame.currentProblem.displayText || 
                `${currentGame.currentProblem.num1} ${currentGame.currentProblem.operation} ${currentGame.currentProblem.num2} = ?`;
            document.getElementById('problem').textContent = problemText;
            
            // Clear previous answer and feedback
            document.getElementById('answerInput').value = '';
            document.getElementById('feedback').innerHTML = '';
            
            // Focus on input
            document.getElementById('answerInput').focus();
        }

        function submitAnswer() {
            const userAnswer = parseInt(document.getElementById('answerInput').value);
            const correctAnswer = currentGame.currentProblem.answer;
            
            currentGame.totalProblems++;
            
            if (userAnswer === correctAnswer) {
                // Correct answer!
                playAudio(true); // Play success sound
                
                currentGame.correctAnswers++;
                currentGame.streak++;
                
                // Difficulty-based base points
                let points;
                switch(currentGame.difficulty) {
                    case 'easy': points = 2; break;
                    case 'medium': points = 4; break;
                    case 'hard': points = 10; break;
                    case 'multiplication15': points = 6; break;
                    case 'multiplication20': points = 8; break;
                    case 'multidigit': points = 15; break;
                    case 'longdivision': points = 12; break;
                    default: points = 4;
                }
                
                // Small bonus points for streak (much smaller than before)
                if (currentGame.streak >= 5) points += 1;
                if (currentGame.streak >= 10) points += 2;
                
                currentGame.score += points;
                
                document.getElementById('feedback').innerHTML = `
                    <span class="correct-feedback">✅ Correct! +${points} XP</span>
                `;
                
                // Visual celebration for streaks
                if (currentGame.streak >= 5) {
                    document.getElementById('feedback').innerHTML += `<br><span style="color: gold;">🔥 ${currentGame.streak} streak bonus!</span>`;
                }
                
                // Check for streak achievement
                if (currentGame.streak >= 10) {
                    checkAchievement('streak_master');
                }
                
            } else {
                // Wrong answer
                playAudio(false); // Play failure sound
                
                currentGame.streak = 0;
                document.getElementById('feedback').innerHTML = `
                    <span class="incorrect-feedback">❌ Incorrect. The answer was ${correctAnswer}</span>
                `;
            }
            
            // Update display
            updateGameStats();
            
            // Move to next problem after a short delay
            setTimeout(() => {
                nextProblem();
            }, 1500);
        }

        function updateGameStats() {
            document.getElementById('currentScore').textContent = currentGame.score;
            document.getElementById('timeLeft').textContent = currentGame.timeLeft;
            document.getElementById('streak').textContent = currentGame.streak;
        }

        function startTimer() {
            currentGame.gameTimer = setInterval(() => {
                currentGame.timeLeft--;
                updateGameStats();
                
                if (currentGame.timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function endGame() {
            // Stop timer
            if (currentGame.gameTimer) {
                clearInterval(currentGame.gameTimer);
                currentGame.gameTimer = null;
            }
            
            // Calculate final stats
            const accuracy = currentGame.totalProblems > 0 ? 
                Math.round((currentGame.correctAnswers / currentGame.totalProblems) * 100) : 0;
            
            // Bonus XP for performance (reduced)
            let bonusXP = 0;
            if (accuracy >= 90) bonusXP += 3;
            else if (accuracy >= 80) bonusXP += 2;
            else if (accuracy >= 70) bonusXP += 1;
            
            // Perfect round bonus (reduced)
            if (accuracy === 100) bonusXP += 2;
            
            const finalXP = currentGame.score + bonusXP;
            
            // Check for achievements
            let achievementXP = 0;
            const newAchievements = [];
            
            // First victory achievement
            if (!hasAchievement('first_victory')) {
                newAchievements.push('first_victory');
                achievementXP += colosseumAchievements['first_victory'].xpReward;
            }
            
            // Perfect warrior achievement
            if (accuracy === 100 && !hasAchievement('perfect_warrior')) {
                newAchievements.push('perfect_warrior');
                achievementXP += colosseumAchievements['perfect_warrior'].xpReward;
            }
            
            // Speed demon achievement (45+ seconds remaining)
            if (currentGame.timeLeft >= 45 && !hasAchievement('speed_demon')) {
                newAchievements.push('speed_demon');
                achievementXP += colosseumAchievements['speed_demon'].xpReward;
            }
            
            // Check operation-specific achievements
            checkOperationAchievements(accuracy);
            
            // Update achievement counters
            updateAchievementProgress();
            
            // Total XP including achievements
            const totalXP = finalXP + achievementXP;
            
            // Hide game area and show results
            document.getElementById('gameArea').classList.add('hidden');
            document.getElementById('gameResults').classList.remove('hidden');
            
            // Build achievements display
            let achievementsHTML = '';
            if (newAchievements.length > 0) {
                achievementsHTML = `
                    <div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: black; padding: 15px; border-radius: 10px; margin: 15px 0;">
                        <h4>🏆 New Achievements Unlocked!</h4>
                        ${newAchievements.map(id => {
                            const achievement = colosseumAchievements[id];
                            return `<p><strong>${achievement.icon} ${achievement.title}</strong><br><small>${achievement.description}</small><br><span style="color: #8B4513;">+${achievement.xpReward} XP Bonus!</span></p>`;
                        }).join('')}
                    </div>
                `;
                
                // Save new achievements
                newAchievements.forEach(id => unlockAchievement(id));
            }
            
            // Display results
            document.getElementById('resultsDisplay').innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h4>🏛️ Battle Results</h4>
                    <p><strong>Problems Solved:</strong> ${currentGame.correctAnswers}/${currentGame.totalProblems}</p>
                    <p><strong>Accuracy:</strong> ${accuracy}%</p>
                    <p><strong>Time Remaining:</strong> ${currentGame.timeLeft} seconds</p>
                    <p><strong>Best Streak:</strong> ${Math.max(...Array(currentGame.totalProblems).fill(0).map((_, i) => 
                        i < currentGame.correctAnswers ? currentGame.streak : 0))} in a row</p>
                    <p><strong>Base XP:</strong> ${currentGame.score}</p>
                    <p><strong>Performance Bonus:</strong> +${bonusXP} XP</p>
                    ${achievementXP > 0 ? `<p><strong>Achievement Bonus:</strong> +${achievementXP} XP</p>` : ''}
                    <h3 style="color: gold;">Total XP Earned: ${totalXP} ⭐</h3>
                </div>
                
                ${achievementsHTML}
                
                <div style="margin: 20px 0;">
                    ${accuracy >= 90 ? '🏆 Outstanding performance!' : 
                      accuracy >= 80 ? '🥇 Great job!' : 
                      accuracy >= 70 ? '🥈 Good effort!' : 
                      '🥉 Keep practicing!'}
                </div>
            `;
            
            // Award XP to student
            awardColosseumXP(totalXP);
        }

        // ===============================
        // ACHIEVEMENT SYSTEM
        // ===============================
        
        function hasAchievement(achievementId) {
            const achievements = JSON.parse(localStorage.getItem('colosseumAchievements') || '[]');
            return achievements.includes(achievementId);
        }
        
        function unlockAchievement(achievementId) {
            const achievements = JSON.parse(localStorage.getItem('colosseumAchievements') || '[]');
            if (!achievements.includes(achievementId)) {
                achievements.push(achievementId);
                localStorage.setItem('colosseumAchievements', JSON.stringify(achievements));
                
                // Show achievement notification
                showAchievementNotification(achievementId);
            }
        }
        
        function checkAchievement(achievementId) {
            if (!hasAchievement(achievementId)) {
                unlockAchievement(achievementId);
                return true;
            }
            return false;
        }
        
        function showAchievementNotification(achievementId) {
            const achievement = colosseumAchievements[achievementId];
            if (!achievement) return;
            
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
                color: black;
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 10000;
                min-width: 300px;
                animation: slideIn 0.5s ease-out;
                font-weight: bold;
            `;
            
            notification.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 2em; margin-bottom: 10px;">${achievement.icon}</div>
                    <div style="font-size: 1.2em; margin-bottom: 5px;">Achievement Unlocked!</div>
                    <div style="font-size: 1.1em; margin-bottom: 5px;">${achievement.title}</div>
                    <div style="font-size: 0.9em; opacity: 0.8;">${achievement.description}</div>
                    <div style="color: #8B4513; margin-top: 10px;">+${achievement.xpReward} XP Bonus!</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 4 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.5s ease-out';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 4000);
        }
        
        function checkOperationAchievements(accuracy) {
            if (accuracy >= 90) {
                const gameType = currentGame.type;
                const counterKey = `colosseum_${gameType}_90plus`;
                let count = parseInt(localStorage.getItem(counterKey) || '0') + 1;
                localStorage.setItem(counterKey, count.toString());
                
                // Check for operation-specific achievements
                if (gameType === 'multiplication' && count >= 5 && !hasAchievement('multiplication_champion')) {
                    unlockAchievement('multiplication_champion');
                } else if (gameType === 'division' && count >= 5 && !hasAchievement('division_master')) {
                    unlockAchievement('division_master');
                }
            }
        }
        
        function updateAchievementProgress() {
            // Update total challenges counter
            const totalChallenges = parseInt(localStorage.getItem('colosseum_total_challenges') || '0') + 1;
            localStorage.setItem('colosseum_total_challenges', totalChallenges.toString());
            
            // Check for challenge-based achievements
            if (totalChallenges >= 10 && !hasAchievement('math_gladiator')) {
                unlockAchievement('math_gladiator');
            }
            
            // Update total XP earned from Colosseum
            const totalColosseumXP = parseInt(localStorage.getItem('colosseum_total_xp') || '0') + currentGame.score;
            localStorage.setItem('colosseum_total_xp', totalColosseumXP.toString());
            
            // Check for XP-based achievements
            if (totalColosseumXP >= 1000 && !hasAchievement('colosseum_legend')) {
                unlockAchievement('colosseum_legend');
            }
        }

        async function awardColosseumXP(xpAmount) {
            try {
                // Add XP to separate XP system (NOT kudos points)
                const studentXPKey = `student_xp_${currentStudent.id}`;
                const currentXP = parseInt(localStorage.getItem(studentXPKey)) || 0;
                const newTotalXP = currentXP + xpAmount;
                localStorage.setItem(studentXPKey, newTotalXP.toString());
                
                console.log(`Awarding ${xpAmount} Colosseum XP. Previous XP: ${currentXP}, New XP total: ${newTotalXP}`);
                
                // DO NOT update database kudos points - games should only affect XP
                // The database points should remain unchanged (only teacher kudos affect those)
                
                console.log(`Kudos Colosseum: Awarded ${xpAmount} XP to ${currentStudent.name}. Total XP: ${newTotalXP}`);
                
                // Add game achievement for XP earned
                let achievementTitle = "Math Battle Completed";
                let achievementDescription = `Earned ${xpAmount} XP in Morphology Arena`;
                
                if (xpAmount >= 15) {
                    achievementTitle = "Outstanding Performance";
                    achievementDescription = `Dominated the arena with ${xpAmount} XP earned!`;
                } else if (xpAmount >= 10) {
                    achievementTitle = "Strong Victory";
                    achievementDescription = `Solid performance earning ${xpAmount} XP`;
                } else if (xpAmount >= 5) {
                    achievementTitle = "Good Effort";
                    achievementDescription = `Steady progress with ${xpAmount} XP earned`;
                }
                
                addGameAchievement('morpheme', achievementTitle, achievementDescription, xpAmount);
                
                // Update XP display immediately with the new XP total (not kudos total)
                updateXPDisplay(newTotalXP);
                
                // Force immediate visual update of XP elements
                setTimeout(() => {
                    console.log('Force updating XP display after short delay...');
                    updateXPDisplay(newTotalXP);
                }, 100);
                
                // Check for level up
                const newLevel = calculateLevel(newTotalXP);
                const oldLevel = calculateLevel(newTotalXP - xpAmount);
                
                if (newLevel > oldLevel) {
                    showLevelUpNotification(newLevel);
                    
                    // Update avatar grid with new unlocks
                    populateAvatarGrid();
                    
                    // Apply new theme if available and update theme selector
                    applyDashboardTheme(newLevel);
                }
                
            } catch (error) {
                console.error('Error awarding Colosseum XP:', error);
            }
        }

        function resetGame() {
            // Stop any running timer
            if (currentGame.gameTimer) {
                clearInterval(currentGame.gameTimer);
                currentGame.gameTimer = null;
            }
            
            // Reset game state
            currentGame = {
                type: null,
                difficulty: null,
                score: 0,
                streak: 0,
                timeLeft: 60,
                currentProblem: null,
                totalProblems: 0,
                correctAnswers: 0,
                gameTimer: null,
                problems: []
            };
            
            // Show initial selection screen
            document.querySelector('.challenge-selection').classList.remove('hidden');
            document.getElementById('difficultySelector').classList.add('hidden');
            document.getElementById('gameArea').classList.add('hidden');
            document.getElementById('gameResults').classList.add('hidden');
        }

        // Add Enter key support for answer submission
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listener for Enter key in answer input
            document.addEventListener('keydown', function(event) {
                if (event.target.id === 'answerInput' && event.key === 'Enter') {
                    event.preventDefault();
                    submitAnswer();
                }
            });
        });

        function logout() {
            // Clear current session
            currentStudent = null;
            currentClass = null;
            currentStudentCode = null;
            currentLevel = 1;
            currentXP = 0;
            lastKudosCount = 0;
            
            // Clear session storage
            clearSession();
            
            // Reset form
            document.getElementById('loginForm').reset();
            
            // Show login, hide dashboard
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('dashboardSection').classList.add('hidden');
            
            // Clear any error messages
            document.getElementById('errorMessage').style.display = 'none';
            
            // Reset to dashboard tab
            showSection('dashboard');
            
            console.log('Logged out successfully');
        }

        // Debug function for development
        window.debugStudentPortal = function() {
            console.log('Current Student:', currentStudent);
            console.log('Current Class:', currentClass);
            console.log('Current Student Code:', currentStudentCode);
            console.log('Current Level:', currentLevel);
            console.log('Current XP:', currentXP);
            console.log('Selected Avatar:', selectedAvatar);
        };

        // Connection monitoring for Chromebook diagnostics
        function monitorConnection() {
            const statusElement = document.getElementById('connection-status');
            
            function updateConnectionStatus() {
                const isOnline = navigator.onLine;
                const connectionType = navigator.connection ? navigator.connection.effectiveType : 'unknown';
                const downlink = navigator.connection ? navigator.connection.downlink : 'unknown';
                
                if (statusElement) {
                    statusElement.innerHTML = `
                        <span style="color: ${isOnline ? '#4CAF50' : '#f44336'}">
                            ${isOnline ? '🟢' : '🔴'} ${isOnline ? 'Online' : 'Offline'}
                        </span>
                        ${connectionType !== 'unknown' ? ` | Speed: ${connectionType}` : ''}
                        ${downlink !== 'unknown' ? ` | Bandwidth: ${downlink}Mbps` : ''}
                    `;
                }
                
                console.log('Connection Status:', {
                    online: isOnline,
                    type: connectionType,
                    downlink: downlink,
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    timestamp: new Date().toISOString()
                });
            }
            
            // Update status immediately
            updateConnectionStatus();
            
            // Monitor connection changes
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
            
            // Monitor connection type changes (if supported)
            if (navigator.connection) {
                navigator.connection.addEventListener('change', updateConnectionStatus);
            }
            
            // Periodic status check
            setInterval(updateConnectionStatus, 30000); // Every 30 seconds
        }

        // Performance monitoring for slow connections
        function measureNetworkPerformance() {
            const startTime = performance.now();
            
            // Test with a small image request
            const img = new Image();
            img.onload = function() {
                const loadTime = performance.now() - startTime;
                console.log('Network performance test:', {
                    loadTime: `${loadTime.toFixed(2)}ms`,
                    status: loadTime < 1000 ? 'Good' : loadTime < 3000 ? 'Fair' : 'Poor',
                    timestamp: new Date().toISOString()
                });
            };
            img.onerror = function() {
                console.log('Network performance test failed:', {
                    error: 'Image load failed',
                    timestamp: new Date().toISOString()
                });
            };
            img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; // 1x1 transparent gif
        }

        // Initialize monitoring when page loads
        document.addEventListener('DOMContentLoaded', function() {
            monitorConnection();
            measureNetworkPerformance();
            
            // Test network performance every 5 minutes
            setInterval(measureNetworkPerformance, 300000);
        });

        // ===============================
        // MORPHEME MASTERY GAME FUNCTIONS
        // ===============================

        function startMorphemeChallenge(type) {
            currentMorphemeGame.type = type;
            document.querySelector('.morpheme-selection').classList.add('hidden');
            
            // Set up difficulty options based on challenge type
            const difficultyContainer = document.getElementById('morphemeDifficultyOptions');
            const difficultyTitle = document.getElementById('morphemeDifficultyTitle');
            
            let options = [];
            let titleText = '';
            
            switch(type) {
                case 'prefixes':
                    titleText = 'Choose Prefix Difficulty';
                    options = [
                        { id: 'easy', text: 'Basic Prefixes (10 questions)', points: '1-2 XP' },
                        { id: 'medium', text: 'Advanced Prefixes (15 questions)', points: '2-3 XP' },
                        { id: 'hard', text: 'All Prefixes (20 questions)', points: '3-4 XP' }
                    ];
                    break;
                case 'suffixes':
                    titleText = 'Choose Suffix Difficulty';
                    options = [
                        { id: 'easy', text: 'Basic Suffixes (10 questions)', points: '1-2 XP' },
                        { id: 'medium', text: 'Advanced Suffixes (15 questions)', points: '2-3 XP' },
                        { id: 'hard', text: 'All Suffixes (20 questions)', points: '3-4 XP' }
                    ];
                    break;
                case 'latin':
                    titleText = 'Choose Latin Roots Difficulty';
                    options = [
                        { id: 'easy', text: 'Basic Latin Roots (10 questions)', points: '2-3 XP' },
                        { id: 'medium', text: 'Advanced Latin Roots (15 questions)', points: '3-5 XP' },
                        { id: 'hard', text: 'All Latin Roots (20 questions)', points: '5-8 XP' }
                    ];
                    break;
                case 'greek':
                    titleText = 'Choose Greek Roots Difficulty';
                    options = [
                        { id: 'easy', text: 'Basic Greek Roots (10 questions)', points: '2-3 XP' },
                        { id: 'medium', text: 'Advanced Greek Roots (15 questions)', points: '3-5 XP' },
                        { id: 'hard', text: 'All Greek Roots (20 questions)', points: '5-8 XP' }
                    ];
                    break;
                case 'mixed':
                    titleText = 'Choose Mixed Challenge Difficulty';
                    options = [
                        { id: 'easy', text: 'Mixed Easy (15 questions)', points: '3-6 XP' },
                        { id: 'medium', text: 'Mixed Advanced (20 questions)', points: '5-10 XP' },
                        { id: 'hard', text: 'Mixed Expert (25 questions)', points: '8-15 XP' }
                    ];
                    break;
            }
            
            difficultyTitle.textContent = titleText;
            
            // Generate HTML for difficulty buttons
            difficultyContainer.innerHTML = options.map(option => 
                `<button class="difficulty-btn" onclick="startMorphemeGame('${option.id}')">
                    ${option.text}<br><small style="color: #888;">${option.points}</small>
                </button>`
            ).join('');
            
            document.getElementById('morphemeDifficultySelector').classList.remove('hidden');
        }

        function startMorphemeGame(difficulty) {
            // EMERGENCY FIX: Prevent double-clicking
            if (currentMorphemeGame.gameActive) {
                console.log('🚫 Game already starting, preventing duplicate');
                return;
            }
            
            currentMorphemeGame.gameActive = true;
            currentMorphemeGame.difficulty = difficulty;
            currentMorphemeGame.score = 0;
            currentMorphemeGame.streak = 0;
            currentMorphemeGame.gameCompleted = false; // EMERGENCY FIX: Reset completion flag
            currentMorphemeGame.timeLeft = 90; // 90 seconds for reading comprehension
            currentMorphemeGame.totalProblems = 0;
            currentMorphemeGame.correctAnswers = 0;
            
            // Hide difficulty selector and show game area
            document.getElementById('morphemeDifficultySelector').classList.add('hidden');
            document.getElementById('morphemeGameArea').classList.remove('hidden');
            
            // Generate problems based on type and difficulty
            generateMorphemeProblems();
            
            // Start the game
            nextMorphemeProblem();
            startMorphemeTimer();
        }

        function generateMorphemeProblems() {
            currentMorphemeGame.problems = [];
            
            let sourceData = [];
            let numProblems = 15;
            
            // Determine source data and number of problems
            switch(currentMorphemeGame.difficulty) {
                case 'easy':
                    numProblems = 10;
                    break;
                case 'medium':
                    numProblems = 15;
                    break;
                case 'hard':
                    numProblems = 20;
                    break;
            }
            
            // Get source data based on challenge type
            if (currentMorphemeGame.type === 'mixed') {
                numProblems = currentMorphemeGame.difficulty === 'easy' ? 15 : 
                             currentMorphemeGame.difficulty === 'medium' ? 20 : 25;
                sourceData = [
                    ...morphemeData.prefixes.slice(0, 10),
                    ...morphemeData.suffixes.slice(0, 10),
                    ...morphemeData.latin.slice(0, 10),
                    ...morphemeData.greek.slice(0, 10)
                ];
            } else {
                sourceData = morphemeData[currentMorphemeGame.type];
                if (currentMorphemeGame.difficulty === 'easy') {
                    sourceData = sourceData.slice(0, Math.min(10, sourceData.length));
                } else if (currentMorphemeGame.difficulty === 'medium') {
                    sourceData = sourceData.slice(0, Math.min(15, sourceData.length));
                }
            }
            
            // Generate problems
            for (let i = 0; i < numProblems; i++) {
                const problem = createMorphemeProblem(sourceData);
                currentMorphemeGame.problems.push(problem);
            }
        }

        function createMorphemeProblem(sourceData) {
            // Choose a random morpheme for the correct answer
            const correctMorpheme = sourceData[Math.floor(Math.random() * sourceData.length)];
            
            // Randomly choose question type
            const questionTypes = ['meaning-to-morpheme', 'morpheme-to-meaning'];
            const questionType = questionTypes[Math.floor(Math.random() * questionTypes.length)];
            
            let question, correctAnswer, options;
            
            if (questionType === 'meaning-to-morpheme') {
                question = `Which morpheme means "${correctMorpheme.meaning}"?`;
                correctAnswer = correctMorpheme.morpheme;
                
                // Create 3 wrong options
                const wrongOptions = [];
                while (wrongOptions.length < 3) {
                    const randomMorpheme = sourceData[Math.floor(Math.random() * sourceData.length)];
                    if (randomMorpheme.morpheme !== correctMorpheme.morpheme && 
                        !wrongOptions.includes(randomMorpheme.morpheme)) {
                        wrongOptions.push(randomMorpheme.morpheme);
                    }
                }
                options = [correctAnswer, ...wrongOptions];
            } else {
                question = `What does the morpheme "${correctMorpheme.morpheme}" mean?`;
                correctAnswer = correctMorpheme.meaning;
                
                // Create 3 wrong options
                const wrongOptions = [];
                while (wrongOptions.length < 3) {
                    const randomMorpheme = sourceData[Math.floor(Math.random() * sourceData.length)];
                    if (randomMorpheme.meaning !== correctMorpheme.meaning && 
                        !wrongOptions.includes(randomMorpheme.meaning)) {
                        wrongOptions.push(randomMorpheme.meaning);
                    }
                }
                options = [correctAnswer, ...wrongOptions];
            }
            
            // Shuffle options
            options.sort(() => Math.random() - 0.5);
            
            return {
                question: question,
                correctAnswer: correctAnswer,
                options: options,
                example: correctMorpheme.example,
                morpheme: correctMorpheme.morpheme
            };
        }

        function nextMorphemeProblem() {
            if (currentMorphemeGame.totalProblems >= currentMorphemeGame.problems.length || 
                currentMorphemeGame.timeLeft <= 0) {
                endMorphemeGame();
                return;
            }
            
            currentMorphemeGame.currentProblem = currentMorphemeGame.problems[currentMorphemeGame.totalProblems];
            
            // Display the question
            document.getElementById('morphemeQuestion').innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 10px;">
                        ${currentMorphemeGame.currentProblem.question}
                    </div>
                </div>
            `;
            
            // Display multiple choice options
            const choicesHTML = currentMorphemeGame.currentProblem.options.map((option, index) => 
                `<button class="choice-btn" onclick="selectMorphemeAnswer('${option}')" 
                         style="padding: 15px; border: 2px solid #ddd; border-radius: 8px; 
                                background: white; cursor: pointer; font-size: 1.1em;">
                    ${option}
                </button>`
            ).join('');
            
            document.getElementById('morphemeChoices').innerHTML = choicesHTML;
            
            // Clear previous feedback
            document.getElementById('morphemeFeedback').innerHTML = '';
            
            // Update game stats
            updateMorphemeGameStats();
        }

        function selectMorphemeAnswer(selectedAnswer) {
            const correctAnswer = currentMorphemeGame.currentProblem.correctAnswer;
            currentMorphemeGame.totalProblems++;
            
            if (selectedAnswer === correctAnswer) {
                // Correct answer!
                playAudio(true); // Play success beep
                
                currentMorphemeGame.correctAnswers++;
                currentMorphemeGame.streak++;
                
                // Difficulty-based points
                let points;
                switch(currentMorphemeGame.difficulty) {
                    case 'easy': points = currentMorphemeGame.type === 'prefixes' || currentMorphemeGame.type === 'suffixes' ? 3 : 4; break;
                    case 'medium': points = currentMorphemeGame.type === 'prefixes' || currentMorphemeGame.type === 'suffixes' ? 4 : 6; break;
                    case 'hard': points = currentMorphemeGame.type === 'prefixes' || currentMorphemeGame.type === 'suffixes' ? 5 : 8; break;
                    default: points = 5;
                }
                
                if (currentMorphemeGame.type === 'mixed') {
                    points = currentMorphemeGame.difficulty === 'easy' ? 5 : 
                             currentMorphemeGame.difficulty === 'medium' ? 7 : 10;
                }
                
                // Streak bonus
                if (currentMorphemeGame.streak >= 5) points += 1;
                if (currentMorphemeGame.streak >= 10) points += 2;
                
                currentMorphemeGame.score += points;
                
                document.getElementById('morphemeFeedback').innerHTML = `
                    <span style="color: green; font-weight: bold;">✅ Correct! +${points} XP</span>
                    <br><span style="color: #666; font-size: 0.9em;">Example: <strong>${currentMorphemeGame.currentProblem.example}</strong></span>
                    ${currentMorphemeGame.streak >= 5 ? `<br><span style="color: gold;">🔥 ${currentMorphemeGame.streak} streak bonus!</span>` : ''}
                `;
                
            } else {
                // Wrong answer
                playAudio(false); // Play error beep
                
                currentMorphemeGame.streak = 0;
                document.getElementById('morphemeFeedback').innerHTML = `
                    <span style="color: red; font-weight: bold;">❌ Incorrect</span>
                    <br><span style="color: #666;">Correct answer: <strong>${correctAnswer}</strong></span>
                    <br><span style="color: #666; font-size: 0.9em;">Example: <strong>${currentMorphemeGame.currentProblem.example}</strong></span>
                `;
            }
            
            // Disable all choice buttons
            const choiceBtns = document.querySelectorAll('.choice-btn');
            choiceBtns.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent.trim() === correctAnswer) {
                    btn.style.background = '#d4edda';
                    btn.style.borderColor = '#28a745';
                } else if (btn.textContent.trim() === selectedAnswer && selectedAnswer !== correctAnswer) {
                    btn.style.background = '#f8d7da';
                    btn.style.borderColor = '#dc3545';
                }
            });
            
            // Continue to next problem after delay
            setTimeout(() => {
                nextMorphemeProblem();
            }, 2500);
        }

        function updateMorphemeGameStats() {
            document.getElementById('morphemeCurrentScore').textContent = currentMorphemeGame.score;
            document.getElementById('morphemeTimeLeft').textContent = currentMorphemeGame.timeLeft;
            document.getElementById('morphemeStreak').textContent = currentMorphemeGame.streak;
        }

        function startMorphemeTimer() {
            currentMorphemeGame.gameTimer = setInterval(() => {
                currentMorphemeGame.timeLeft--;
                updateMorphemeGameStats();
                
                if (currentMorphemeGame.timeLeft <= 0) {
                    endMorphemeGame();
                }
            }, 1000);
        }

        // EMERGENCY FIX: Game cooldown system
        let lastGameCompletionTime = 0;
        const GAME_COOLDOWN_MS = 10000; // 10 second cooldown between games

        function endMorphemeGame() {
            // EMERGENCY FIX: Prevent multiple completions
            if (currentMorphemeGame.gameCompleted) {
                console.log('🚫 Game already completed, preventing duplicate XP award');
                return;
            }
            
            // EMERGENCY FIX: Check cooldown to prevent rapid gaming
            const now = Date.now();
            if (now - lastGameCompletionTime < GAME_COOLDOWN_MS) {
                const remaining = Math.ceil((GAME_COOLDOWN_MS - (now - lastGameCompletionTime)) / 1000);
                alert(`⏰ Please wait ${remaining} seconds before starting another game to prevent server overload.`);
                console.log('🚫 Game completion too rapid, enforcing cooldown');
                return;
            }
            
            lastGameCompletionTime = now;
            
            // Mark game as completed immediately
            currentMorphemeGame.gameCompleted = true;
            currentMorphemeGame.gameActive = false;
            
            // Stop timer
            if (currentMorphemeGame.gameTimer) {
                clearInterval(currentMorphemeGame.gameTimer);
                currentMorphemeGame.gameTimer = null;
            }
            
            // Calculate final stats
            const accuracy = currentMorphemeGame.totalProblems > 0 ? 
                Math.round((currentMorphemeGame.correctAnswers / currentMorphemeGame.totalProblems) * 100) : 0;
            
            // Bonus XP for performance
            let bonusXP = 0;
            if (accuracy >= 90) bonusXP += 3;
            else if (accuracy >= 80) bonusXP += 2;
            else if (accuracy >= 70) bonusXP += 1;
            
            // EMERGENCY FIX: Cap XP to prevent infinite gains
            const baseXP = Math.min(currentMorphemeGame.score, 15); // Max 15 base XP per game (REDUCED)
            const finalXP = Math.min(baseXP + bonusXP, 20); // Max 20 total XP per game (REDUCED)
            
            // Hide game area and show results
            document.getElementById('morphemeGameArea').classList.add('hidden');
            document.getElementById('morphemeGameResults').classList.remove('hidden');
            
            // Display results
            document.getElementById('morphemeResultsDisplay').innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h4>📚 Challenge Results</h4>
                    <p><strong>Questions Answered:</strong> ${currentMorphemeGame.correctAnswers}/${currentMorphemeGame.totalProblems}</p>
                    <p><strong>Accuracy:</strong> ${accuracy}%</p>
                    <p><strong>Time Remaining:</strong> ${currentMorphemeGame.timeLeft} seconds</p>
                    <p><strong>Best Streak:</strong> ${currentMorphemeGame.streak}</p>
                    <p><strong>Base XP:</strong> ${baseXP}</p>
                    <p><strong>Performance Bonus:</strong> +${bonusXP} XP</p>
                    <h3 style="color: gold;">Total XP Earned: ${finalXP} ⭐</h3>
                    ${finalXP >= 20 ? '<p style="color: orange;">⚠️ XP capped at maximum per game</p>' : ''}
                </div>
                
                <div style="margin: 20px 0;">
                    ${accuracy >= 90 ? '🏆 Outstanding vocabulary mastery!' : 
                      accuracy >= 80 ? '🥇 Great morpheme knowledge!' : 
                      accuracy >= 70 ? '🥈 Good understanding!' : 
                      '🥉 Keep studying those word parts!'}
                </div>
            `;
            
            // Award XP to student
            awardMorphemeXP(finalXP);
        }

        async function awardMorphemeXP(xpAmount) {
            try {
                // EMERGENCY FIX: Additional XP validation and caps
                if (!xpAmount || xpAmount <= 0) {
                    console.log('🚫 Invalid XP amount:', xpAmount);
                    return;
                }
                
                // Cap XP per award to prevent infinite gains
                const cappedXP = Math.min(xpAmount, 25); // Reduced from 100 to 25
                if (cappedXP !== xpAmount) {
                    console.log(`🛡️ XP capped from ${xpAmount} to ${cappedXP}`);
                }
                
                // Add XP to separate XP system (NOT kudos points)
                const studentXPKey = `student_xp_${currentStudent.id}`;
                const currentXP = parseInt(localStorage.getItem(studentXPKey)) || 0;
                const newTotalXP = currentXP + cappedXP;
                
                // Updated total XP cap for Level 100
                const maxTotalXP = 237750; // Level 100 maximum
                const finalTotalXP = Math.min(newTotalXP, maxTotalXP);
                
                localStorage.setItem(studentXPKey, finalTotalXP.toString());
                
                console.log(`Awarding ${cappedXP} Morpheme XP. Previous XP: ${currentXP}, New XP total: ${finalTotalXP}`);
                if (finalTotalXP !== newTotalXP) {
                    console.log(`🛡️ Total XP capped at maximum level (${maxTotalXP})`);
                }
                
                // DO NOT update database kudos points - games should only affect XP
                // The database points should remain unchanged (only teacher kudos affect those)
                
                console.log(`Morpheme Mastery: Awarded ${cappedXP} XP to ${currentStudent.name}. Total XP: ${finalTotalXP}`);
                
                // Update XP display immediately with the new XP total (not kudos total)
                updateXPDisplay(finalTotalXP);
                
                // Check for level up
                const newLevel = calculateLevel(finalTotalXP);
                const oldLevel = calculateLevel(finalTotalXP - cappedXP);
                
                if (newLevel > oldLevel) {
                    showLevelUpNotification(oldLevel, newLevel);
                }
                
            } catch (error) {
                console.error('Error awarding Morpheme XP:', error);
            }
        }

        function resetMorphemeGame() {
            // Reset game state
            currentMorphemeGame = {
                type: null,
                difficulty: null,
                score: 0,
                streak: 0,
                timeLeft: 90,
                totalProblems: 0,
                correctAnswers: 0,
                problems: [],
                currentProblem: null,
                gameTimer: null,
                gameCompleted: false, // EMERGENCY FIX: Add completion flag
                gameActive: false // EMERGENCY FIX: Add active flag
            };
            
            // Show selection screen
            document.getElementById('morphemeGameResults').classList.add('hidden');
            document.querySelector('.morpheme-selection').classList.remove('hidden');
        }

        // EMERGENCY ADMIN FUNCTIONS FOR TEACHERS
        function emergencyResetStudentLevel() {
            const confirmReset = confirm(`🚨 EMERGENCY LEVEL RESET 🚨\n\nThis will reset ${currentStudent.name}'s XP level to 1.\n\nThis action cannot be undone.\n\nClick OK to proceed.`);
            
            if (confirmReset) {
                const studentXPKey = `student_xp_${currentStudent.id}`;
                localStorage.setItem(studentXPKey, '0');
                updateXPDisplay(0);
                alert(`✅ ${currentStudent.name}'s level has been reset to 1.`);
                console.log(`🔧 EMERGENCY RESET: ${currentStudent.name} (ID: ${currentStudent.id}) XP reset to 0`);
            }
        }

        function emergencySetStudentLevel(targetLevel) {
            if (!targetLevel || targetLevel < 1 || targetLevel > 100) {
                alert('Please enter a level between 1 and 100');
                return;
            }
            
            const targetXP = xpRequirements[targetLevel - 1] || 0;
            const confirmSet = confirm(`🔧 SET STUDENT LEVEL\n\nSet ${currentStudent.name} to Level ${targetLevel}?\n\nThis will set their XP to ${targetXP}.\n\nClick OK to proceed.`);
            
            if (confirmSet) {
                const studentXPKey = `student_xp_${currentStudent.id}`;
                localStorage.setItem(studentXPKey, targetXP.toString());
                updateXPDisplay(targetXP);
                alert(`✅ ${currentStudent.name} set to Level ${targetLevel} (${targetXP} XP).`);
                console.log(`🔧 ADMIN SET: ${currentStudent.name} (ID: ${currentStudent.id}) set to Level ${targetLevel} (${targetXP} XP)`);
            }
        }

        // Add emergency reset button access (triple-click on student name)
        let nameClickCount = 0;
        function handleStudentNameClick() {
            nameClickCount++;
            setTimeout(() => { nameClickCount = 0; }, 1000);
            
            if (nameClickCount === 3) {
                const action = prompt(`🔧 TEACHER EMERGENCY CONTROLS 🔧\n\nStudent: ${currentStudent.name}\nCurrent Level: ${currentLevel}\nCurrent XP: ${currentXP}\n\nActions:\n1 = Reset to Level 1\n2 = Set specific level (1-100)\n3 = Cancel\n\nEnter choice (1, 2, or 3):`);
                
                if (action === '1') {
                    emergencyResetStudentLevel();
                } else if (action === '2') {
                    const level = prompt('Enter target level (1-100):');
                    if (level) {
                        emergencySetStudentLevel(parseInt(level));
                    }
                }
                nameClickCount = 0;
            }
        }

        // ===============================
        // NEW ACADEMIC GAMES SYSTEM
        // ===============================

        let currentGameType = null;
        let currentGameData = {};

        // Game selection functions
        function selectGameType(gameType) {
            currentGameType = gameType;
            document.getElementById('gameSelectionMenu').classList.add('hidden');
            document.getElementById('challengeSelection').classList.remove('hidden');
            
            setupGameChallenges(gameType);
        }

        function backToGameSelection() {
            document.getElementById('challengeSelection').classList.add('hidden');
            document.getElementById('gameSelectionMenu').classList.remove('hidden');
            document.getElementById('difficultySelector').classList.add('hidden');
            currentGameType = null;
        }

        function setupGameChallenges(gameType) {
            const challengeTitle = document.getElementById('challengeTitle');
            const challengeOptions = document.getElementById('challengeOptions');
            
            let title, challenges;
            
            switch(gameType) {
                case 'math':
                    title = '🔢 Choose Your Math Challenge';
                    challenges = [
                        { id: 'multiplication', name: '✖️ Multiplication Arena', icon: '✖️' },
                        { id: 'division', name: '➗ Division Arena', icon: '➗' },
                        { id: 'addition', name: '➕ Addition Arena', icon: '➕' },
                        { id: 'subtraction', name: '➖ Subtraction Arena', icon: '➖' },
                        { id: 'mixed', name: '🎯 Mixed Combat', icon: '🎯' }
                    ];
                    break;
                    
                case 'vocabulary':
                    title = '📚 Choose Your Word Challenge';
                    challenges = [
                        { id: 'spelling', name: '✏️ Spelling Bee', icon: '✏️' },
                        { id: 'definitions', name: '📖 Definition Match', icon: '📖' },
                        { id: 'synonyms', name: '🔄 Synonym Hunt', icon: '🔄' },
                        { id: 'antonyms', name: '↔️ Antonym Battle', icon: '↔️' }
                    ];
                    break;
                    
                case 'reading':
                    title = '👁️ Choose Your Reading Challenge';
                    challenges = [
                        { id: 'comprehension', name: '🧠 Reading Comprehension', icon: '🧠' },
                        { id: 'speed', name: '⚡ Speed Reading', icon: '⚡' },
                        { id: 'context', name: '🔍 Context Clues', icon: '🔍' }
                    ];
                    break;
                    
                case 'science':
                    title = '🔬 Choose Your Science Challenge';
                    challenges = [
                        { id: 'biology', name: '🌱 Biology Quiz', icon: '🌱' },
                        { id: 'chemistry', name: '⚗️ Chemistry Lab', icon: '⚗️' },
                        { id: 'physics', name: '🌌 Physics Force', icon: '🌌' },
                        { id: 'earth', name: '🌍 Earth Science', icon: '🌍' }
                    ];
                    break;
                    
                case 'geography':
                    title = '🌍 Choose Your Geography Challenge';
                    challenges = [
                        { id: 'capitals', name: '🏛️ Capital Cities', icon: '🏛️' },
                        { id: 'countries', name: '🗺️ Country Hunter', icon: '🗺️' },
                        { id: 'landmarks', name: '🗽 Famous Landmarks', icon: '🗽' },
                        { id: 'flags', name: '🏳️ Flag Master', icon: '🏳️' }
                    ];
                    break;
                    
                case 'history':
                    title = '🏛️ Choose Your History Challenge';
                    challenges = [
                        { id: 'dates', name: '📅 Historical Dates', icon: '📅' },
                        { id: 'people', name: '👑 Famous People', icon: '👑' },
                        { id: 'events', name: '⚔️ Major Events', icon: '⚔️' },
                        { id: 'civilizations', name: '🏺 Ancient Civilizations', icon: '🏺' }
                    ];
                    break;
            }
            
            challengeTitle.textContent = title;
            challengeOptions.innerHTML = challenges.map(challenge => `
                <button class="challenge-btn" onclick="selectChallenge('${challenge.id}')" style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white; border: none; padding: 15px 20px; margin: 5px;
                    border-radius: 10px; cursor: pointer; font-size: 1.1em;
                    transition: transform 0.2s;
                ">
                    ${challenge.icon} ${challenge.name}
                </button>
            `).join('');
        }

        function selectChallenge(challengeId) {
            currentGameData.challenge = challengeId;
            showDifficultySelector();
        }

        function showDifficultySelector() {
            document.getElementById('difficultySelector').classList.remove('hidden');
            const difficultyOptions = document.getElementById('difficultyOptions');
            
            const difficulties = [
                { id: 'easy', name: 'Easy', xp: '5-10 XP', color: '#28a745' },
                { id: 'medium', name: 'Medium', xp: '8-15 XP', color: '#ffc107' },
                { id: 'hard', name: 'Hard', xp: '12-20 XP', color: '#dc3545' },
                { id: 'expert', name: 'Expert', xp: '15-25 XP', color: '#6f42c1' }
            ];
            
            difficultyOptions.innerHTML = difficulties.map(diff => `
                <button onclick="startNewGame('${diff.id}')" style="
                    background: ${diff.color}; color: white; border: none;
                    padding: 20px; border-radius: 10px; cursor: pointer;
                    transition: transform 0.2s;
                ">
                    <div style="font-size: 1.3em; font-weight: bold;">${diff.name}</div>
                    <div style="font-size: 0.9em; opacity: 0.9;">${diff.xp}</div>
                </button>
            `).join('');
        }

        function startNewGame(difficulty) {
            currentGameData.difficulty = difficulty;
            
            // Hide menus and show game area
            document.getElementById('challengeSelection').classList.add('hidden');
            document.getElementById('gameArea').classList.remove('hidden');
            
            // Initialize game based on type and challenge
            initializeGame();
        }

        function initializeGame() {
            // Reset game stats
            currentGame = {
                type: currentGameData.challenge,
                difficulty: currentGameData.difficulty,
                score: 0,
                streak: 0,
                timeLeft: 60,
                correctAnswers: 0,
                totalProblems: 0,
                currentProblem: null
            };
            
            // Update display
            updateGameStats();
            generateNewProblem();
            
            // Start timer
            startTimer();
        }

        function generateNewProblem() {
            const gameType = currentGameType;
            const challenge = currentGameData.challenge;
            const difficulty = currentGameData.difficulty;
            
            let problemData;
            
            if (gameType === 'math') {
                problemData = generateMathProblem(challenge, difficulty);
            } else if (gameType === 'vocabulary') {
                problemData = generateVocabularyProblem(challenge, difficulty);
            } else if (gameType === 'reading') {
                problemData = generateReadingProblem(challenge, difficulty);
            } else if (gameType === 'science') {
                problemData = generateScienceProblem(challenge, difficulty);
            } else if (gameType === 'geography') {
                problemData = generateGeographyProblem(challenge, difficulty);
            } else if (gameType === 'history') {
                problemData = generateHistoryProblem(challenge, difficulty);
            } else {
                // Fallback to math
                problemData = generateMathProblem('addition', 'easy');
            }
            
            currentGame.currentProblem = { 
                question: problemData.problem, 
                answer: problemData.answer,
                options: problemData.options || null
            };
            
            // Display the question
            document.getElementById('problem').innerHTML = problemData.problem;
            
            // Clear feedback
            document.getElementById('feedback').innerHTML = '';
            
            // Use pre-built options if available, otherwise generate them
            let choices = problemData.options;
            if (!choices) {
                choices = generateMultipleChoiceOptions(problemData.answer, gameType, challenge);
            }
            
            // Show multiple choice options or input field based on question type
            if (choices && choices.length > 0) {
                displayMultipleChoice(choices, problemData.answer);
            } else {
                displayTextInput();
            }
        }
        
        function generateMultipleChoiceOptions(correctAnswer, gameType, challenge) {
            // Don't use multiple choice for certain math types that need exact calculation
            if (gameType === 'math' && (challenge === 'multidigit' || challenge === 'longdivision')) {
                return null; // Use text input for complex math
            }
            
            const options = [correctAnswer];
            const answerType = typeof correctAnswer;
            
            if (answerType === 'number') {
                // Generate wrong numerical options
                const baseNum = correctAnswer;
                const variations = [
                    baseNum + 1,
                    baseNum - 1, 
                    baseNum + Math.floor(baseNum * 0.1) + 1,
                    baseNum - Math.floor(baseNum * 0.1) - 1,
                    Math.floor(baseNum * 1.5),
                    Math.floor(baseNum * 0.5),
                    baseNum + 10,
                    baseNum - 5
                ];
                
                // Add valid variations (positive numbers only)
                variations.forEach(num => {
                    if (num > 0 && num !== correctAnswer && options.length < 4) {
                        options.push(num);
                    }
                });
                
                // Fill remaining slots with random numbers if needed
                while (options.length < 4) {
                    const randomNum = Math.max(1, correctAnswer + Math.floor(Math.random() * 20) - 10);
                    if (!options.includes(randomNum)) {
                        options.push(randomNum);
                    }
                }
                
            } else {
                // Generate wrong text options based on subject
                const wrongAnswers = generateWrongTextAnswers(correctAnswer, gameType, challenge);
                wrongAnswers.forEach(wrong => {
                    if (options.length < 4) {
                        options.push(wrong);
                    }
                });
            }
            
            // Shuffle options
            for (let i = options.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [options[i], options[j]] = [options[j], options[i]];
            }
            
            return options;
        }
        
        function generateWrongTextAnswers(correctAnswer, gameType, challenge) {
            const wrong = [];
            
            if (gameType === 'geography') {
                if (challenge === 'capitals') {
                    wrong.push('New York', 'Los Angeles', 'Chicago', 'Boston', 'Miami');
                } else if (challenge === 'countries') {
                    wrong.push('Canada', 'Mexico', 'Brazil', 'Spain', 'Italy');
                } else {
                    wrong.push('London', 'Paris', 'Tokyo', 'Sydney', 'Rome');
                }
            } else if (gameType === 'science') {
                if (challenge === 'biology') {
                    wrong.push('brain', 'liver', 'kidney', 'stomach', 'lungs');
                } else if (challenge === 'chemistry') {
                    wrong.push('hydrogen', 'carbon', 'nitrogen', 'helium', 'sodium');
                } else {
                    wrong.push('gravity', 'magnetism', 'energy', 'force', 'motion');
                }
            } else if (gameType === 'history') {
                wrong.push('Napoleon', 'Caesar', 'Lincoln', 'Washington', 'Churchill');
            } else if (gameType === 'vocabulary') {
                wrong.push('excellent', 'wonderful', 'terrible', 'amazing', 'awful');
            } else {
                // General wrong answers
                wrong.push('answer1', 'answer2', 'answer3', 'answer4', 'answer5');
            }
            
            return wrong.filter(w => w.toLowerCase() !== correctAnswer.toLowerCase()).slice(0, 3);
        }
        
        function displayMultipleChoice(choices, correctAnswer) {
            document.getElementById('choicesContainer').classList.remove('hidden');
            document.getElementById('inputFallback').classList.add('hidden');
            
            const choicesHTML = choices.map((choice, index) => 
                `<button class="choice-btn academic-choice" onclick="selectAcademicAnswer('${choice}')" 
                         style="padding: 15px; border: 2px solid #ddd; border-radius: 8px; 
                                background: white; cursor: pointer; font-size: 1.1em; 
                                transition: all 0.3s;">
                    ${choice}
                </button>`
            ).join('');
            
            document.getElementById('choicesContainer').innerHTML = choicesHTML;
            currentGame.currentProblem.correctAnswer = correctAnswer;
        }
        
        function displayTextInput() {
            document.getElementById('choicesContainer').classList.add('hidden');
            document.getElementById('inputFallback').classList.remove('hidden');
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').focus();
        }
        
        function selectAcademicAnswer(selectedAnswer) {
            const correctAnswer = currentGame.currentProblem.answer;
            currentGame.totalProblems++;
            
            // Disable all choice buttons
            const choiceBtns = document.querySelectorAll('.academic-choice');
            choiceBtns.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent.trim() == correctAnswer) {
                    btn.style.background = '#d4edda';
                    btn.style.borderColor = '#28a745';
                } else if (btn.textContent.trim() == selectedAnswer && selectedAnswer != correctAnswer) {
                    btn.style.background = '#f8d7da';
                    btn.style.borderColor = '#dc3545';
                }
            });
            
            const feedback = document.getElementById('feedback');
            
            if (selectedAnswer == correctAnswer) {
                currentGame.correctAnswers++;
                currentGame.streak++;
                
                // Award points based on difficulty and streak
                let points = getDifficultyPoints(currentGameData.difficulty);
                if (currentGame.streak >= 5) points += 2; // Streak bonus
                
                currentGame.score += points;
                
                feedback.innerHTML = `<span style="color: green;">✅ Correct! +${points} points</span>`;
                
                // Play success sound
                try {
                    const audio = new Audio('../Audio/ding.wav');
                    audio.play().catch(() => {});
                } catch (e) {}
                
            } else {
                currentGame.streak = 0;
                feedback.innerHTML = `<span style="color: red;">❌ Incorrect. The answer was: ${correctAnswer}</span>`;
                
                // Play error sound
                try {
                    const audio = new Audio('../Audio/Negative.wav');
                    audio.play().catch(() => {});
                } catch (e) {}
            }
            
            updateGameStats();
            
            // Continue to next problem after delay
            setTimeout(() => {
                generateNewProblem();
            }, 2500);
        }

        // Game generators for different subjects - MASSIVELY EXPANDED CONTENT
        function generateMathProblem(challenge, difficulty) {
            let num1, num2, operation, problem, answer;
            
            // Set number ranges based on difficulty
            const ranges = {
                easy: [1, 12],
                medium: [1, 50], 
                hard: [1, 100],
                expert: [1, 500]
            };
            
            const [min, max] = ranges[difficulty];
            
            switch(challenge) {
                case 'multiplication':
                    if (difficulty === 'easy') {
                        num1 = Math.floor(Math.random() * 12) + 1;
                        num2 = Math.floor(Math.random() * 12) + 1;
                    } else if (difficulty === 'medium') {
                        num1 = Math.floor(Math.random() * 25) + 1;
                        num2 = Math.floor(Math.random() * 15) + 1;
                    } else if (difficulty === 'hard') {
                        num1 = Math.floor(Math.random() * 50) + 1;
                        num2 = Math.floor(Math.random() * 25) + 1;
                    } else { // expert
                        num1 = Math.floor(Math.random() * 100) + 1;
                        num2 = Math.floor(Math.random() * 50) + 1;
                    }
                    problem = `${num1} × ${num2} = ?`;
                    answer = num1 * num2;
                    break;
                    
                case 'division':
                    if (difficulty === 'easy') {
                        num2 = Math.floor(Math.random() * 10) + 2;
                        answer = Math.floor(Math.random() * 12) + 1;
                    } else if (difficulty === 'medium') {
                        num2 = Math.floor(Math.random() * 15) + 2;
                        answer = Math.floor(Math.random() * 25) + 1;
                    } else if (difficulty === 'hard') {
                        num2 = Math.floor(Math.random() * 25) + 2;
                        answer = Math.floor(Math.random() * 50) + 1;
                    } else { // expert
                        num2 = Math.floor(Math.random() * 50) + 2;
                        answer = Math.floor(Math.random() * 100) + 1;
                    }
                    num1 = answer * num2;
                    problem = `${num1} ÷ ${num2} = ?`;
                    break;
                    
                case 'addition':
                    num1 = Math.floor(Math.random() * max) + min;
                    num2 = Math.floor(Math.random() * max) + min;
                    problem = `${num1} + ${num2} = ?`;
                    answer = num1 + num2;
                    break;
                    
                case 'subtraction':
                    num2 = Math.floor(Math.random() * max) + min;
                    num1 = num2 + Math.floor(Math.random() * max) + min;
                    problem = `${num1} - ${num2} = ?`;
                    answer = num1 - num2;
                    break;
                    
                default: // mixed
                    const operations = ['×', '+', '-', '÷'];
                    const op = operations[Math.floor(Math.random() * operations.length)];
                    
                    if (op === '×') {
                        num1 = Math.floor(Math.random() * (max/2)) + min;
                        num2 = Math.floor(Math.random() * 15) + 1;
                        problem = `${num1} × ${num2} = ?`;
                        answer = num1 * num2;
                    } else if (op === '+') {
                        num1 = Math.floor(Math.random() * max) + min;
                        num2 = Math.floor(Math.random() * max) + min;
                        problem = `${num1} + ${num2} = ?`;
                        answer = num1 + num2;
                    } else if (op === '-') {
                        num2 = Math.floor(Math.random() * max) + min;
                        num1 = num2 + Math.floor(Math.random() * max) + min;
                        problem = `${num1} - ${num2} = ?`;
                        answer = num1 - num2;
                    } else { // division
                        num2 = Math.floor(Math.random() * 12) + 2;
                        answer = Math.floor(Math.random() * (max/2)) + min;
                        num1 = answer * num2;
                        problem = `${num1} ÷ ${num2} = ?`;
                    }
            }
            
            return { problem, answer };
        }

        function generateVocabularyProblem(challenge, difficulty) {
            // MASSIVE vocabulary database with 200+ words per difficulty
            const vocabularyBank = {
                easy: {
                    spelling: [
                        { word: 'cat', question: 'Spell: A small furry pet that meows' },
                        { word: 'dog', question: 'Spell: A loyal pet that barks' },
                        { word: 'run', question: 'Spell: To move quickly on foot' },
                        { word: 'blue', question: 'Spell: The color of the sky' },
                        { word: 'book', question: 'Spell: Something you read' },
                        { word: 'tree', question: 'Spell: A tall plant with branches' },
                        { word: 'house', question: 'Spell: A building where people live' },
                        { word: 'water', question: 'Spell: Clear liquid you drink' },
                        { word: 'happy', question: 'Spell: Feeling joyful' },
                        { word: 'green', question: 'Spell: The color of grass' },
                        { word: 'school', question: 'Spell: Where students learn' },
                        { word: 'friend', question: 'Spell: Someone you like and trust' },
                        { word: 'family', question: 'Spell: Parents, siblings, relatives' },
                        { word: 'apple', question: 'Spell: A red or green fruit' },
                        { word: 'chair', question: 'Spell: Furniture you sit on' },
                        { word: 'table', question: 'Spell: Furniture you eat on' },
                        { word: 'pencil', question: 'Spell: Tool for writing' },
                        { word: 'paper', question: 'Spell: What you write on' },
                        { word: 'smile', question: 'Spell: Happy facial expression' },
                        { word: 'laugh', question: 'Spell: Sound when something is funny' }
                    ],
                    definitions: [
                        { word: 'happy', definition: 'Feeling joy or pleasure', options: ['sad', 'happy', 'angry', 'tired'] },
                        { word: 'big', definition: 'Large in size', options: ['small', 'big', 'red', 'fast'] },
                        { word: 'fast', definition: 'Moving quickly', options: ['slow', 'big', 'fast', 'cold'] },
                        { word: 'hot', definition: 'High temperature', options: ['cold', 'wet', 'hot', 'soft'] },
                        { word: 'kind', definition: 'Being nice to others', options: ['mean', 'kind', 'loud', 'tall'] },
                        { word: 'brave', definition: 'Not afraid', options: ['scared', 'brave', 'quiet', 'small'] }
                    ],
                    synonyms: [
                        { word: 'big', synonym: 'large', options: ['small', 'large', 'thin', 'cold'] },
                        { word: 'happy', synonym: 'joyful', options: ['sad', 'angry', 'joyful', 'tired'] },
                        { word: 'fast', synonym: 'quick', options: ['slow', 'quick', 'heavy', 'soft'] },
                        { word: 'smart', synonym: 'clever', options: ['dumb', 'clever', 'lazy', 'mean'] }
                    ]
                },
                medium: {
                    spelling: [
                        { word: 'elephant', question: 'Spell: A large gray animal with a trunk' },
                        { word: 'beautiful', question: 'Spell: Pleasing to look at' },
                        { word: 'adventure', question: 'Spell: An exciting journey' },
                        { word: 'library', question: 'Spell: A place with many books' },
                        { word: 'exercise', question: 'Spell: Physical activity for health' },
                        { word: 'science', question: 'Spell: Study of the natural world' },
                        { word: 'dinosaur', question: 'Spell: Extinct prehistoric reptile' },
                        { word: 'computer', question: 'Spell: Electronic device for processing data' },
                        { word: 'birthday', question: 'Spell: Annual celebration of birth' },
                        { word: 'vacation', question: 'Spell: Time away from work or school' },
                        { word: 'medicine', question: 'Spell: Treatment for illness' },
                        { word: 'mountain', question: 'Spell: Very tall landform' },
                        { word: 'butterfly', question: 'Spell: Colorful flying insect' },
                        { word: 'sandwich', question: 'Spell: Food between bread slices' },
                        { word: 'telephone', question: 'Spell: Device for talking to distant people' },
                        { word: 'calendar', question: 'Spell: Shows days, weeks, and months' },
                        { word: 'keyboard', question: 'Spell: Input device with letters and numbers' },
                        { word: 'umbrella', question: 'Spell: Protection from rain' },
                        { word: 'hospital', question: 'Spell: Place where sick people get help' },
                        { word: 'football', question: 'Spell: Sport played with oval ball' }
                    ],
                    definitions: [
                        { word: 'ambitious', definition: 'Having strong desire to succeed', options: ['lazy', 'ambitious', 'tired', 'confused'] },
                        { word: 'diligent', definition: 'Working hard and carefully', options: ['careless', 'diligent', 'sleepy', 'angry'] },
                        { word: 'generous', definition: 'Willing to give and share', options: ['selfish', 'generous', 'rude', 'nervous'] },
                        { word: 'curious', definition: 'Eager to learn or know', options: ['bored', 'curious', 'scared', 'mean'] }
                    ]
                },
                hard: {
                    spelling: [
                        { word: 'encyclopedia', question: 'Spell: A reference book with information on many topics' },
                        { word: 'extraordinary', question: 'Spell: Very unusual or remarkable' },
                        { word: 'photography', question: 'Spell: The art of taking pictures' },
                        { word: 'mathematics', question: 'Spell: The study of numbers and shapes' },
                        { word: 'architecture', question: 'Spell: The design of buildings' },
                        { word: 'bibliography', question: 'Spell: A list of books or sources' },
                        { word: 'pronunciation', question: 'Spell: How words are spoken' },
                        { word: 'refrigerator', question: 'Spell: Appliance that keeps food cold' },
                        { word: 'microscope', question: 'Spell: Tool for seeing tiny things' },
                        { word: 'democracy', question: 'Spell: Government by the people' },
                        { word: 'ecosystem', question: 'Spell: Community of living things in an environment' },
                        { word: 'chromosome', question: 'Spell: Structure containing genetic material' },
                        { word: 'parallelogram', question: 'Spell: Four-sided shape with parallel sides' },
                        { word: 'metamorphosis', question: 'Spell: Process of transformation' },
                        { word: 'photosynthesis', question: 'Spell: How plants make food from sunlight' }
                    ]
                },
                expert: {
                    spelling: [
                        { word: 'pharmaceutical', question: 'Spell: Related to medicinal drugs' },
                        { word: 'pneumonia', question: 'Spell: Lung infection disease' },
                        { word: 'archaeology', question: 'Spell: Study of ancient civilizations' },
                        { word: 'chrysanthemum', question: 'Spell: Type of flowering plant' },
                        { word: 'entrepreneur', question: 'Spell: Person who starts a business' },
                        { word: 'ecclesiastical', question: 'Spell: Related to the church' },
                        { word: 'rhododendron', question: 'Spell: Flowering shrub plant' },
                        { word: 'onomatopoeia', question: 'Spell: Words that imitate sounds' }
                    ]
                }
            };
            
            const levelData = vocabularyBank[difficulty] || vocabularyBank.easy;
            const challengeData = levelData[challenge] || levelData.spelling;
            
            if (!challengeData || challengeData.length === 0) {
                return { problem: 'Spell: test', answer: 'test' };
            }
            
            const item = challengeData[Math.floor(Math.random() * challengeData.length)];
            
            if (item.options) {
                // For definitions, synonyms, antonyms with multiple choice
                let question, answer;
                if (challenge === 'definitions') {
                    question = `What does "${item.word}" mean?<br><em>${item.definition}</em>`;
                    answer = item.word;
                } else if (challenge === 'synonyms') {
                    question = `What word is a synonym for "${item.word}"?`;
                    answer = item.synonym;
                } else if (challenge === 'antonyms') {
                    question = `What word is an antonym for "${item.word}"?`;
                    answer = item.antonym;
                }
                
                return {
                    problem: question,
                    answer: answer,
                    options: item.options
                };
            } else {
                // For spelling questions (no multiple choice)
                return {
                    problem: item.question || `What does "${item.word}" mean?`,
                    answer: item.word || item.synonym
                };
            }
        }

        function generateScienceProblem(challenge, difficulty) {
            // MASSIVE science database with 100+ questions per subject
            const scienceBank = {
                biology: {
                    easy: [
                        { question: 'What organ pumps blood through your body?', answer: 'heart' },
                        { question: 'What gas do plants absorb from the air?', answer: 'carbon dioxide' },
                        { question: 'What is the largest organ in the human body?', answer: 'skin' },
                        { question: 'How many legs does a spider have?', answer: '8' },
                        { question: 'What do bees make?', answer: 'honey' },
                        { question: 'What do caterpillars turn into?', answer: 'butterfly' },
                        { question: 'What do fish use to breathe underwater?', answer: 'gills' },
                        { question: 'What is a baby frog called?', answer: 'tadpole' },
                        { question: 'What do birds use to fly?', answer: 'wings' },
                        { question: 'What do mammals feed their babies?', answer: 'milk' }
                    ],
                    medium: [
                        { question: 'What is the powerhouse of the cell?', answer: 'mitochondria' },
                        { question: 'What process do plants use to make food?', answer: 'photosynthesis' },
                        { question: 'What is the basic unit of life?', answer: 'cell' },
                        { question: 'What carries genetic information in cells?', answer: 'DNA' },
                        { question: 'What system fights diseases in your body?', answer: 'immune system' },
                        { question: 'What is the liquid part of blood called?', answer: 'plasma' },
                        { question: 'What connects muscles to bones?', answer: 'tendons' },
                        { question: 'What is the green pigment in plants?', answer: 'chlorophyll' }
                    ],
                    hard: [
                        { question: 'What is the study of heredity called?', answer: 'genetics' },
                        { question: 'What organelle controls cell activities?', answer: 'nucleus' },
                        { question: 'What is the longest bone in the human body?', answer: 'femur' },
                        { question: 'What is the scientific name for humans?', answer: 'homo sapiens' },
                        { question: 'What enzyme breaks down starch?', answer: 'amylase' }
                    ]
                },
                chemistry: {
                    easy: [
                        { question: 'What is the chemical symbol for water?', answer: 'H2O' },
                        { question: 'What gas makes up most of Earth\'s atmosphere?', answer: 'nitrogen' },
                        { question: 'What is the chemical symbol for gold?', answer: 'Au' },
                        { question: 'What do you call a substance made of only one type of atom?', answer: 'element' },
                        { question: 'What is the center of an atom called?', answer: 'nucleus' },
                        { question: 'What gas do we breathe in?', answer: 'oxygen' },
                        { question: 'What is table salt\'s chemical name?', answer: 'sodium chloride' },
                        { question: 'What is the lightest element?', answer: 'hydrogen' }
                    ],
                    medium: [
                        { question: 'What is the pH of pure water?', answer: '7' },
                        { question: 'What particles orbit the nucleus?', answer: 'electrons' },
                        { question: 'What is the chemical symbol for carbon?', answer: 'C' },
                        { question: 'What type of bond shares electrons?', answer: 'covalent' },
                        { question: 'What is the most abundant element in the universe?', answer: 'hydrogen' }
                    ]
                },
                physics: {
                    easy: [
                        { question: 'What force pulls objects toward Earth?', answer: 'gravity' },
                        { question: 'What travels faster: light or sound?', answer: 'light' },
                        { question: 'What unit measures electric current?', answer: 'ampere' },
                        { question: 'What makes things visible?', answer: 'light' },
                        { question: 'What happens when you rub a balloon on your hair?', answer: 'static electricity' },
                        { question: 'What do we call energy from moving water?', answer: 'kinetic energy' }
                    ],
                    medium: [
                        { question: 'What is the speed of light in a vacuum?', answer: '299792458' },
                        { question: 'What law states that energy cannot be created or destroyed?', answer: 'conservation of energy' },
                        { question: 'What unit measures force?', answer: 'newton' },
                        { question: 'What is the acceleration due to gravity on Earth?', answer: '9.8' }
                    ]
                },
                earth: {
                    easy: [
                        { question: 'What causes earthquakes?', answer: 'tectonic plates' },
                        { question: 'What is molten rock called when it\'s underground?', answer: 'magma' },
                        { question: 'What is the hardest natural substance?', answer: 'diamond' },
                        { question: 'What layer of Earth do we live on?', answer: 'crust' },
                        { question: 'What causes the seasons?', answer: 'Earth\'s tilt' }
                    ]
                }
            };
            
            const subject = scienceBank[challenge] || scienceBank.biology;
            const levelQuestions = subject[difficulty] || subject.easy || subject.medium || Object.values(subject)[0];
            
            if (!levelQuestions || levelQuestions.length === 0) {
                return { question: 'What organ pumps blood?', answer: 'heart' };
            }
            
            const item = levelQuestions[Math.floor(Math.random() * levelQuestions.length)];
            
            return {
                problem: item.question,
                answer: item.answer
            };
        }

        function generateGeographyProblem(challenge, difficulty) {
            // MASSIVE geography database with 200+ questions
            const geographyBank = {
                capitals: {
                    easy: [
                        { question: 'What is the capital of the United States?', answer: 'Washington DC' },
                        { question: 'What is the capital of France?', answer: 'Paris' },
                        { question: 'What is the capital of Italy?', answer: 'Rome' },
                        { question: 'What is the capital of Spain?', answer: 'Madrid' },
                        { question: 'What is the capital of Germany?', answer: 'Berlin' },
                        { question: 'What is the capital of England?', answer: 'London' },
                        { question: 'What is the capital of Japan?', answer: 'Tokyo' },
                        { question: 'What is the capital of Canada?', answer: 'Ottawa' },
                        { question: 'What is the capital of Mexico?', answer: 'Mexico City' },
                        { question: 'What is the capital of Egypt?', answer: 'Cairo' }
                    ],
                    medium: [
                        { question: 'What is the capital of Australia?', answer: 'Canberra' },
                        { question: 'What is the capital of Brazil?', answer: 'Brasilia' },
                        { question: 'What is the capital of India?', answer: 'New Delhi' },
                        { question: 'What is the capital of Russia?', answer: 'Moscow' },
                        { question: 'What is the capital of South Africa?', answer: 'Cape Town' },
                        { question: 'What is the capital of Argentina?', answer: 'Buenos Aires' },
                        { question: 'What is the capital of Turkey?', answer: 'Ankara' },
                        { question: 'What is the capital of Thailand?', answer: 'Bangkok' }
                    ],
                    hard: [
                        { question: 'What is the capital of Kazakhstan?', answer: 'Nur-Sultan' },
                        { question: 'What is the capital of Madagascar?', answer: 'Antananarivo' },
                        { question: 'What is the capital of Sri Lanka?', answer: 'Colombo' },
                        { question: 'What is the capital of Mongolia?', answer: 'Ulaanbaatar' }
                    ]
                },
                countries: {
                    easy: [
                        { question: 'Which country is known as the Land of the Rising Sun?', answer: 'Japan' },
                        { question: 'Which is the largest country by area?', answer: 'Russia' },
                        { question: 'Which country is shaped like a boot?', answer: 'Italy' },
                        { question: 'Which country has a maple leaf on its flag?', answer: 'Canada' },
                        { question: 'Which country is home to the kangaroo?', answer: 'Australia' },
                        { question: 'Which country built the Great Wall?', answer: 'China' },
                        { question: 'Which country is famous for the Eiffel Tower?', answer: 'France' }
                    ],
                    medium: [
                        { question: 'Which country has the most time zones?', answer: 'France' },
                        { question: 'Which country has no rivers?', answer: 'Saudi Arabia' },
                        { question: 'Which is the smallest country in the world?', answer: 'Vatican City' },
                        { question: 'Which country spans two continents?', answer: 'Turkey' }
                    ]
                },
                landmarks: {
                    easy: [
                        { question: 'In which country is Machu Picchu located?', answer: 'Peru' },
                        { question: 'In which city is the Colosseum located?', answer: 'Rome' },
                        { question: 'Which country is home to the Great Wall?', answer: 'China' },
                        { question: 'In which country is the Taj Mahal?', answer: 'India' },
                        { question: 'Where is Stonehenge located?', answer: 'England' },
                        { question: 'In which country are the Pyramids of Giza?', answer: 'Egypt' },
                        { question: 'Where is Mount Rushmore?', answer: 'United States' }
                    ],
                    medium: [
                        { question: 'In which country is Angkor Wat?', answer: 'Cambodia' },
                        { question: 'Where is Petra located?', answer: 'Jordan' },
                        { question: 'In which country is Christ the Redeemer statue?', answer: 'Brazil' },
                        { question: 'Where is the ancient city of Troy?', answer: 'Turkey' }
                    ]
                },
                flags: {
                    easy: [
                        { question: 'Which country has a red maple leaf on its flag?', answer: 'Canada' },
                        { question: 'Which country has red, white, and blue stripes with stars?', answer: 'United States' },
                        { question: 'Which country has a red cross on a white background?', answer: 'Switzerland' },
                        { question: 'Which country has a red circle on white background?', answer: 'Japan' }
                    ]
                }
            };
            
            const category = geographyBank[challenge] || geographyBank.capitals;
            const levelQuestions = category[difficulty] || category.easy || category.medium || Object.values(category)[0];
            
            if (!levelQuestions || levelQuestions.length === 0) {
                return { question: 'What is the capital of France?', answer: 'Paris' };
            }
            
            const item = levelQuestions[Math.floor(Math.random() * levelQuestions.length)];
            
            return {
                problem: item.question,
                answer: item.answer
            };
        }

        function generateHistoryProblem(challenge, difficulty) {
            // MASSIVE history database with 200+ questions
            const historyBank = {
                dates: {
                    easy: [
                        { question: 'In what year did World War II end?', answer: '1945' },
                        { question: 'In what year did the first moon landing occur?', answer: '1969' },
                        { question: 'In what year did the Berlin Wall fall?', answer: '1989' },
                        { question: 'In what year did America declare independence?', answer: '1776' },
                        { question: 'In what year did World War I begin?', answer: '1914' },
                        { question: 'In what year did the Titanic sink?', answer: '1912' },
                        { question: 'In what year did Columbus reach America?', answer: '1492' }
                    ],
                    medium: [
                        { question: 'In what year did the French Revolution begin?', answer: '1789' },
                        { question: 'In what year was the Constitution signed?', answer: '1787' },
                        { question: 'In what year did the American Civil War begin?', answer: '1861' },
                        { question: 'In what year did the Great Depression begin?', answer: '1929' }
                    ],
                    hard: [
                        { question: 'In what year did the Byzantine Empire fall?', answer: '1453' },
                        { question: 'In what year was the Magna Carta signed?', answer: '1215' },
                        { question: 'In what year did the Black Death peak in Europe?', answer: '1348' }
                    ]
                },
                people: {
                    easy: [
                        { question: 'Who was the first President of the United States?', answer: 'George Washington' },
                        { question: 'Who painted the Mona Lisa?', answer: 'Leonardo da Vinci' },
                        { question: 'Who wrote Romeo and Juliet?', answer: 'William Shakespeare' },
                        { question: 'Who invented the telephone?', answer: 'Alexander Graham Bell' },
                        { question: 'Who was the 16th President of the United States?', answer: 'Abraham Lincoln' },
                        { question: 'Who discovered America for Europe?', answer: 'Christopher Columbus' },
                        { question: 'Who was the famous nurse in the Crimean War?', answer: 'Florence Nightingale' }
                    ],
                    medium: [
                        { question: 'Who led the civil rights movement in America?', answer: 'Martin Luther King Jr' },
                        { question: 'Who was the first woman to fly solo across the Atlantic?', answer: 'Amelia Earhart' },
                        { question: 'Who developed the theory of relativity?', answer: 'Albert Einstein' },
                        { question: 'Who was the first person to walk on the moon?', answer: 'Neil Armstrong' }
                    ],
                    hard: [
                        { question: 'Who was the last Pharaoh of Egypt?', answer: 'Cleopatra' },
                        { question: 'Who founded the Mongol Empire?', answer: 'Genghis Khan' },
                        { question: 'Who was the Sun King of France?', answer: 'Louis XIV' }
                    ]
                },
                events: {
                    easy: [
                        { question: 'What war was fought between the North and South in America?', answer: 'Civil War' },
                        { question: 'What was the name of the ship that sank in 1912?', answer: 'Titanic' },
                        { question: 'What revolution began in France in 1789?', answer: 'French Revolution' },
                        { question: 'What disease killed millions in Europe in the 1300s?', answer: 'Black Death' },
                        { question: 'What event started World War I?', answer: 'assassination of Archduke Franz Ferdinand' }
                    ],
                    medium: [
                        { question: 'What was the period of rebuilding after the Civil War called?', answer: 'Reconstruction' },
                        { question: 'What was the name of the first permanent English settlement?', answer: 'Jamestown' },
                        { question: 'What was the Boston Tea Party protesting?', answer: 'taxation without representation' }
                    ]
                },
                civilizations: {
                    easy: [
                        { question: 'Which ancient civilization built the pyramids?', answer: 'Egyptians' },
                        { question: 'Which civilization was known for gladiators?', answer: 'Romans' },
                        { question: 'Which ancient civilization was in Greece?', answer: 'Greeks' },
                        { question: 'Which civilization built Machu Picchu?', answer: 'Incas' }
                    ],
                    medium: [
                        { question: 'Which civilization invented paper?', answer: 'Chinese' },
                        { question: 'Which civilization created the first written laws?', answer: 'Babylonians' },
                        { question: 'Which civilization built Stonehenge?', answer: 'Druids' }
                    ]
                }
            };
            
            const category = historyBank[challenge] || historyBank.people;
            const levelQuestions = category[difficulty] || category.easy || category.medium || Object.values(category)[0];
            
            if (!levelQuestions || levelQuestions.length === 0) {
                return { question: 'Who was the first President of the United States?', answer: 'George Washington' };
            }
            
            const item = levelQuestions[Math.floor(Math.random() * levelQuestions.length)];
            
            return {
                problem: item.question,
                answer: item.answer
            };
        }

        function generateReadingProblem(challenge, difficulty) {
            // Reading comprehension passages and questions
            const readingBank = {
                comprehension: {
                    easy: [
                        {
                            passage: "The sun is a star. It gives us light and warmth. Without the sun, Earth would be very cold and dark. Plants need sunlight to grow.",
                            question: "What does the sun give us?",
                            answer: "light and warmth"
                        },
                        {
                            passage: "Dogs are loyal pets. They can learn tricks and follow commands. Dogs have been friends with humans for thousands of years.",
                            question: "How long have dogs been friends with humans?",
                            answer: "thousands of years"
                        }
                    ],
                    medium: [
                        {
                            passage: "Photosynthesis is the process plants use to make food. They take in carbon dioxide from the air and water from their roots. Using sunlight, they create sugar and release oxygen.",
                            question: "What do plants release during photosynthesis?",
                            answer: "oxygen"
                        }
                    ]
                },
                speed: [
                    { text: "The quick brown fox jumps over the lazy dog.", question: "What animal jumps?", answer: "fox" },
                    { text: "Rain falls from clouds in the sky.", question: "Where do clouds exist?", answer: "sky" }
                ],
                context: [
                    { sentence: "The enormous elephant trumpeted loudly.", question: "What does 'enormous' mean?", answer: "very large" },
                    { sentence: "She felt melancholy on the rainy day.", question: "What does 'melancholy' mean?", answer: "sad" }
                ]
            };
            
            const category = readingBank[challenge] || readingBank.speed;
            const questions = Array.isArray(category) ? category : category[difficulty] || category.easy || Object.values(category)[0];
            
            if (!questions || questions.length === 0) {
                return { problem: "What color is grass?", answer: "green" };
            }
            
            const item = questions[Math.floor(Math.random() * questions.length)];
            
            if (item.passage) {
                return {
                    problem: `Read: "${item.passage}"\n\nQuestion: ${item.question}`,
                    answer: item.answer
                };
            } else {
                return {
                    problem: item.question || item.text,
                    answer: item.answer
                };
            }
        }

        // Enhanced answer checking for text-based answers
        function checkAnswer(userAnswer, correctAnswer) {
            // For math problems (numeric answers)
            if (typeof correctAnswer === 'number') {
                return parseInt(userAnswer) === correctAnswer;
            }
            
            // For text-based answers
            const userText = userAnswer.toString().toLowerCase().trim();
            const correctText = correctAnswer.toString().toLowerCase().trim();
            
            // Exact match
            if (userText === correctText) return true;
            
            // Check for common abbreviations or variations
            const variations = {
                'united states': ['usa', 'us', 'america'],
                'united kingdom': ['uk', 'britain', 'great britain'],
                'leonardo da vinci': ['da vinci', 'leonardo'],
                'william shakespeare': ['shakespeare'],
                'george washington': ['washington']
            };
            
            for (const [full, alts] of Object.entries(variations)) {
                if (correctText === full && alts.includes(userText)) return true;
                if (userText === full && alts.includes(correctText)) return true;
            }
            
            return false;
        }

        // Update the existing submitAnswer function to work with new games
        function submitAnswer() {
            const userAnswer = document.getElementById('answerInput').value.trim();
            if (!userAnswer) return;
            
            const isCorrect = checkAnswer(userAnswer, currentGame.currentProblem.answer);
            const feedback = document.getElementById('feedback');
            
            currentGame.totalProblems++;
            
            if (isCorrect) {
                currentGame.correctAnswers++;
                currentGame.streak++;
                
                // Award points based on difficulty and streak
                let points = getDifficultyPoints(currentGameData.difficulty);
                if (currentGame.streak >= 5) points += 2; // Streak bonus
                
                currentGame.score += points;
                
                feedback.innerHTML = `<span style="color: green;">✅ Correct! +${points} points</span>`;
                
                // Play success sound
                try {
                    const audio = new Audio('../Audio/ding.wav');
                    audio.play().catch(() => {});
                } catch (e) {}
                
                setTimeout(() => {
                    generateNewProblem();
                }, 1000);
                
            } else {
                currentGame.streak = 0;
                feedback.innerHTML = `<span style="color: red;">❌ Incorrect. The answer was: ${currentGame.currentProblem.answer}</span>`;
                
                setTimeout(() => {
                    generateNewProblem();
                }, 2000);
            }
            
            updateGameStats();
        }

        function getDifficultyPoints(difficulty) {
            const points = {
                easy: 1,
                medium: 2,
                hard: 3,
                expert: 4
            };
            return points[difficulty] || 1;
        }

        // Update the resetGame function
        function resetGame() {
            document.getElementById('gameArea').classList.add('hidden');
            document.getElementById('gameResults').classList.add('hidden');
            document.getElementById('gameSelectionMenu').classList.remove('hidden');
            document.getElementById('challengeSelection').classList.add('hidden');
            document.getElementById('difficultySelector').classList.add('hidden');
            
            if (currentGame.gameTimer) {
                clearInterval(currentGame.gameTimer);
                currentGame.gameTimer = null;
            }
            
            currentGameType = null;
            currentGameData = {};
        }

    </script>
</body>
</html>
