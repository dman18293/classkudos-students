<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Kudos Student Portal - Enhanced with Avatars & XP</title>
    <!-- Enhanced caching control for Chromebooks -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Chromebook compatibility -->
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .logo p {
            color: #666;
            font-size: 1.1em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .error-message {
            background: #ffe6e6;
            color: #d8000c;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
            border-left: 4px solid #d8000c;
        }
        
        .dashboard {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .dashboard-columns {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }
        
        .dashboard-left {
            flex: 2;
            min-width: 0;
        }
        
        .dashboard-right {
            flex: 1;
            min-width: 300px;
        }
        
        @media (max-width: 768px) {
            .dashboard-columns {
                flex-direction: column;
            }
            .dashboard-right {
                min-width: 0;
            }
        }
        
        .student-profile {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .avatar-container {
            position: relative;
        }
        
        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s;
            overflow: hidden;
        }
        
        .avatar:hover {
            transform: scale(1.1);
        }
        
        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .level-badge {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: #28a745;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
            border: 3px solid white;
        }
        
        .edit-avatar-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        
        .edit-avatar-btn:hover {
            background: #218838;
        }
        
        .student-info h2 {
            color: #333;
            font-size: 1.8em;
            margin-bottom: 5px;
        }
        
        .student-meta {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 20px;
        }
        
        .student-code {
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-weight: bold;
            color: #667eea;
        }
        
        .xp-progress {
            margin-top: 15px;
        }
        
        .xp-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .xp-fill {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
        }
        
        .xp-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 25%, rgba(255,255,255,0.2) 25%, rgba(255,255,255,0.2) 50%, transparent 50%, transparent 75%, rgba(255,255,255,0.2) 75%);
            background-size: 20px 20px;
            animation: xpShine 2s linear infinite;
        }
        
        @keyframes xpShine {
            0% { background-position: -20px 0; }
            100% { background-position: 20px 0; }
        }
        
        .xp-text {
            font-size: 0.9em;
            color: #666;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h4 {
            font-size: 2.5em;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .stat-card p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        /* Badge Collection Styles */
        .badge-collection {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            background-clip: padding-box;
        }
        
        .badge-collection h3 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 1.4em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .badge-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .achievement-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 10px;
            border-radius: 12px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.3);
            transition: all 0.3s ease;
            border: 3px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .achievement-badge:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 12px 30px rgba(255, 215, 0, 0.5);
        }
        
        .achievement-badge.locked {
            background: linear-gradient(135deg, #ccc 0%, #999 100%);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            opacity: 0.6;
        }
        
        .badge-icon {
            font-size: 2em;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .badge-level {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        .badge-title {
            font-size: 0.7em;
            color: #333;
            text-align: center;
            margin-top: 5px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        .navigation {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            margin-bottom: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .nav-menu {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .nav-item {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .nav-item:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .nav-item.active {
            background: #764ba2;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Avatar Selection Modal */
        .avatar-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .avatar-modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .avatar-modal h3 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 1.8em;
        }
        
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .avatar-option {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 3px solid transparent;
            font-size: 4em;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .avatar-option:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .avatar-option.selected {
            border-color: #28a745;
            transform: scale(1.1);
        }
        
        .avatar-option.locked {
            cursor: not-allowed;
            border-color: #666;
        }
        
        .avatar-option.locked:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(255, 152, 0, 0.4);
        }
        
        /* Modal Header */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.8em;
            color: #333;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            background: #f0f0f0;
            color: #666;
        }
        
        /* Tab Navigation */
        .avatar-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 25px;
        }
        
        .tab-button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-button:hover {
            background: #f8f9fa;
            color: #333;
        }
        
        .tab-button.active {
            color: #4CAF50;
            border-bottom-color: #4CAF50;
            background: #f8fcf9;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Avatar Categories */
        .avatar-categories {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .avatar-category {
            margin-bottom: 30px;
        }
        
        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .category-header.locked {
            background: linear-gradient(135deg, #FF9800 0%, #FF5722 100%);
        }
        
        .category-title {
            font-size: 16px;
        }
        
        .category-progress {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 12px;
            padding: 0 10px;
        }
        
        .avatar-option {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
        }
        
        .avatar-option img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .modal-btn.primary {
            background: #28a745;
            color: white;
        }
        
        .modal-btn.primary:hover {
            background: #218838;
        }
        
        .modal-btn.secondary {
            background: #6c757d;
            color: white;
        }
        
        .modal-btn.secondary:hover {
            background: #545b62;
        }
        
        /* Live Kudos Feed */
        .kudos-feed {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .kudos-feed h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .refresh-btn {
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .refresh-btn:hover {
            background: #138496;
        }
        
        .kudos-item {
            background: #f8f9fa;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .kudos-item.new {
            border-left-color: #ffc107;
            background: #fff3cd;
            animation: pulse 2s ease-in-out;
        }
        
        @keyframes pulse {
            0%, 100% { background: #fff3cd; }
            50% { background: #ffeaa7; }
        }
        
        .kudos-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .kudos-points {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .kudos-date {
            color: #666;
            font-size: 0.9em;
        }
        
        .kudos-reason {
            color: #333;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .kudos-description {
            color: #666;
            font-size: 0.9em;
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .level-up-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 50%, #45B7D1 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            z-index: 2000;
            animation: levelUpEpic 4s ease-in-out;
            display: none;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 3px solid #FFD700;
        }
        
        @keyframes levelUpEpic {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.3) rotate(-10deg); }
            15% { opacity: 1; transform: translate(-50%, -50%) scale(1.3) rotate(5deg); }
            30% { transform: translate(-50%, -50%) scale(0.9) rotate(-2deg); }
            45% { transform: translate(-50%, -50%) scale(1.1) rotate(1deg); }
            60% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
            90% { opacity: 1; transform: translate(-50%, -50%) scale(1) rotate(0deg); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8) rotate(0deg); }
        }
        
        .level-up-content {
            position: relative;
        }
        
        .level-up-badge {
            background: #FFD700;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
            border: 3px solid #FFF;
            animation: badgeSpin 4s ease-in-out;
        }
        
        @keyframes badgeSpin {
            0% { transform: rotate(0deg) scale(0.5); }
            25% { transform: rotate(180deg) scale(1.2); }
            50% { transform: rotate(360deg) scale(1); }
            75% { transform: rotate(540deg) scale(1.1); }
            100% { transform: rotate(720deg) scale(1); }
        }
        
        .level-up-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .level-up-notification h2 {
            font-size: 2.5em;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            animation: textBounce 2s ease-in-out infinite;
        }
        
        @keyframes textBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .level-up-message {
            font-size: 1.8em;
            font-weight: bold;
            margin: 15px 0 5px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .level-up-subtitle {
            font-size: 1.3em;
            margin: 5px 0 20px;
            opacity: 0.9;
        }
        
        .level-up-achievement {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            animation: achievementGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes achievementGlow {
            0% { box-shadow: 0 0 10px rgba(255, 255, 255, 0.3); }
            100% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.6); }
        }
        
        .avatar-unlock-notification {
            background: linear-gradient(45deg, #FF6B35, #FF8E53);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            color: white;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
            animation: avatarUnlockPulse 2s infinite;
        }
        
        @keyframes avatarUnlockPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .achievement-icon {
            font-size: 2em;
            margin-right: 10px;
        }
        
        .achievement-text {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        /* Add main app emoji avatar styling for consistency */
        .emoji-avatar-leaderboard {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-family: 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', sans-serif;
            margin-right: 15px;
        }
        
        /* Kudos Colosseum Styles */
        .challenge-btn, .difficulty-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            margin: 10px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            min-width: 200px;
        }
        
        .challenge-btn:hover, .difficulty-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .challenge-btn:active, .difficulty-btn:active {
            transform: translateY(0);
        }
        
        #gameArea {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        #answerInput {
            border: 3px solid #667eea;
            border-radius: 10px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        #answerInput:focus {
            border-color: #764ba2;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }
        
        .correct-feedback {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .incorrect-feedback {
            color: #f44336;
            font-weight: bold;
        }
        
        .hidden {
            display: none;
        }
        
        /* Achievement notification animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="loginSection" class="container">
        <div class="login-container">
            <div class="logo">
                <h1>🎓 Class Kudos</h1>
                <p>Student Portal Enhanced</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="classCode">Class Code</label>
                    <input type="text" id="classCode" placeholder="Enter your class code" required>
                </div>
                
                <div class="form-group">
                    <label for="studentCode">Student Code (4 digits)</label>
                    <input type="text" id="studentCode" placeholder="0000" maxlength="4" required>
                </div>
                
                <button type="submit" id="loginBtn" class="login-btn">Login to Portal</button>
                
                <div id="errorMessage" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboardSection" class="container hidden">
        <!-- Navigation -->
        <div class="navigation">
            <div class="nav-menu">
                <button class="nav-item active" onclick="showSection('dashboard')">Dashboard</button>
                <button class="nav-item" onclick="showSection('myKudos')">My Kudos</button>
                <button class="nav-item" onclick="showSection('leaderboard')">Leaderboard</button>
                <button class="nav-item" onclick="showSection('kudosColosseum')">🏛️ Kudos Colosseum</button>
                <button class="nav-item" onclick="showSection('morphemeMastery')">📚 Morpheme Mastery</button>
                <div id="connection-status" style="color: #4CAF50; font-size: 12px; margin: 0 10px; display: flex; align-items: center;">
                    🟢 Connected
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard" class="content-section active">
            <div class="dashboard">
                <div class="dashboard-columns">
                    <div class="dashboard-left">
                        <div class="student-profile">
                            <div class="avatar-container">
                                <div class="avatar" id="studentAvatar" onclick="openAvatarModal()">
                                    <img id="avatarDisplay" src="https://api.dicebear.com/7.x/adventurer/svg?seed=happy" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                                </div>
                                <div class="level-badge" id="levelBadge">1</div>
                            </div>
                            
                            <div class="student-info">
                                <h2 id="studentName">Loading...</h2>
                                <div class="student-meta">
                                    Class: <strong id="studentClass">-</strong> • 
                                    Student Code: <span class="student-code" id="displayStudentCode">-</span>
                                </div>
                                <button class="edit-avatar-btn" onclick="openAvatarModal()">
                                    🎨 Customize Avatar
                                </button>
                                
                                <div class="xp-progress">
                                    <div class="xp-bar">
                                        <div class="xp-fill" id="xpBar" style="width: 0%"></div>
                                    </div>
                                    <div class="xp-text" id="xpText">XP: 0 / 100 (Level 1)</div>
                                </div>
                            </div>
                        </div>

                        <div class="stats-grid">
                            <div class="stat-card">
                                <h4 id="totalKudos">0</h4>
                                <p>Total Points</p>
                            </div>
                            <div class="stat-card">
                                <h4 id="classRank">#-</h4>
                                <p>Class Rank</p>
                            </div>
                            <div class="stat-card">
                                <h4 id="recentKudos">0</h4>
                                <p>This Week</p>
                            </div>
                            <div class="stat-card">
                                <h4 id="studentLevel">1</h4>
                                <p>Level</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-right">
                        <div class="badge-collection">
                            <h3>🏆 My Achievements</h3>
                            <div class="badge-grid" id="badgeGrid">
                                <!-- Badges will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Kudos Content -->
        <div id="myKudos" class="content-section">
            <div class="kudos-feed">
                <h3>
                    🏆 Recent Achievements 
                    <button class="refresh-btn" onclick="loadStudentKudos()" title="Refresh">
                        ↻
                    </button>
                </h3>
                <div id="kudosList">
                    <p style="text-align: center; color: #666;">Loading your achievements...</p>
                </div>
            </div>
        </div>

        <!-- Leaderboard Content -->
        <div id="leaderboard" class="content-section">
            <div class="dashboard">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h3 style="margin: 0;">🏅 Class Leaderboard</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="loadLeaderboard(0)" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            🔄 Refresh
                        </button>
                        <button onclick="enableDiagnosticMode()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            🔧 Fix Issues
                        </button>
                    </div>
                </div>
                <div id="leaderboardList">
                    <p style="text-align: center; color: #666;">Loading leaderboard...</p>
                </div>
            </div>
        </div>

        <!-- Kudos Colosseum Content -->
        <div id="kudosColosseum" class="content-section">
            <div class="dashboard">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>🏛️ Kudos Colosseum - Math Arena</h3>
                    <div>
                        <button id="audioToggle" onclick="toggleAudio()" style="background: #667eea; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            🔊 Audio On
                        </button>
                        <button onclick="showAchievements()" style="background: #FFD700; color: black; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                            🏆 Achievements
                        </button>
                    </div>
                </div>
                
                <div id="colosseumContent">
                    <div style="text-align: center; padding: 40px;">
                        <h4>⚔️ Choose Your Challenge</h4>
                        <p>Test your math skills and earn XP!</p>
                        
                        <div class="challenge-selection" style="margin: 20px 0;">
                            <button class="challenge-btn" onclick="startChallenge('multiplication')">
                                ✖️ Multiplication Arena
                            </button>
                            <button class="challenge-btn" onclick="startChallenge('division')">
                                ➗ Division Arena
                            </button>
                            <button class="challenge-btn" onclick="startChallenge('mixed')">
                                🎯 Mixed Combat
                            </button>
                        </div>
                        
                        <div id="difficultySelector" class="hidden" style="margin: 20px 0;">
                            <h4 id="difficultyTitle">Choose Difficulty</h4>
                            <div id="difficultyOptions" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                <!-- Dynamic difficulty options will be inserted here -->
                            </div>
                        </div>
                        
                        <div id="gameArea" class="hidden">
                            <div id="gameStats" style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                                <span>Score: <span id="currentScore">0</span></span>
                                <span>Time: <span id="timeLeft">60</span>s</span>
                                <span>Streak: <span id="streak">0</span></span>
                            </div>
                            
                            <div id="problemArea" style="font-size: 2em; margin: 30px 0;">
                                <span id="problem">3 × 7 = ?</span>
                            </div>
                            
                            <div id="answerArea">
                                <input type="number" id="answerInput" placeholder="Your answer..." style="font-size: 1.5em; padding: 10px; text-align: center;">
                                <button onclick="submitAnswer()" style="font-size: 1.2em; padding: 10px 20px; margin-left: 10px;">Submit</button>
                            </div>
                            
                            <div id="feedback" style="margin-top: 20px; font-size: 1.2em;"></div>
                        </div>
                        
                        <div id="gameResults" class="hidden">
                            <h4>🎉 Battle Complete!</h4>
                            <div id="resultsDisplay"></div>
                            <button onclick="resetGame()">Return to Arena</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Morpheme Mastery Section -->
        <div id="morphemeMastery" class="content-section">
            <h2>📚 Morpheme Mastery</h2>
            
            <div id="morphemeContent">
                <div style="text-align: center; padding: 40px;">
                    <h4>🧠 Choose Your Challenge</h4>
                    <p>Master prefixes, suffixes, and root words to build vocabulary!</p>
                    
                    <div class="morpheme-selection" style="margin: 20px 0;">
                        <button class="challenge-btn" onclick="startMorphemeChallenge('prefixes')">
                            🔤 Prefix Challenge
                        </button>
                        <button class="challenge-btn" onclick="startMorphemeChallenge('suffixes')">
                            🔤 Suffix Challenge
                        </button>
                        <button class="challenge-btn" onclick="startMorphemeChallenge('latin')">
                            🏛️ Latin Roots
                        </button>
                        <button class="challenge-btn" onclick="startMorphemeChallenge('greek')">
                            🇬🇷 Greek Roots
                        </button>
                        <button class="challenge-btn" onclick="startMorphemeChallenge('mixed')">
                            🎯 Mixed Challenge
                        </button>
                    </div>
                    
                    <div id="morphemeDifficultySelector" class="hidden" style="margin: 20px 0;">
                        <h4 id="morphemeDifficultyTitle">Choose Difficulty</h4>
                        <div id="morphemeDifficultyOptions" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <!-- Dynamic difficulty options will be inserted here -->
                        </div>
                    </div>
                    
                    <div id="morphemeGameArea" class="hidden">
                        <div id="morphemeGameStats" style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                            <span>Score: <span id="morphemeCurrentScore">0</span></span>
                            <span>Time: <span id="morphemeTimeLeft">60</span>s</span>
                            <span>Streak: <span id="morphemeStreak">0</span></span>
                        </div>
                        
                        <div id="morphemeQuestionArea" style="margin: 30px 0;">
                            <div id="morphemeQuestion" style="font-size: 1.5em; margin-bottom: 20px; text-align: center;"></div>
                            <div id="morphemeChoices" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 600px; margin: 0 auto;">
                                <!-- Multiple choice options will be inserted here -->
                            </div>
                        </div>
                        
                        <div id="morphemeFeedback" style="text-align: center; margin: 20px 0; font-size: 1.2em;"></div>
                    </div>
                    
                    <div id="morphemeGameResults" class="hidden">
                        <h4>🎉 Challenge Complete!</h4>
                        <div id="morphemeResultsDisplay"></div>
                        <button onclick="resetMorphemeGame()">Return to Challenges</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Avatar Selection Modal -->
    <div id="avatarModal" class="avatar-modal">
        <div class="avatar-modal-content">
            <div class="modal-header">
                <h3>🎨 Choose Your Avatar</h3>
                <button class="modal-close" onclick="closeAvatarModal()">×</button>
            </div>
            
            <!-- Tab Navigation -->
            <div class="avatar-tabs">
                <button class="tab-button active" onclick="switchAvatarTab('available')">
                    ✅ Available
                </button>
                <button class="tab-button" onclick="switchAvatarTab('coming-soon')">
                    🔒 Coming Soon
                </button>
            </div>
            
            <!-- Tab Content -->
            <div id="availableTab" class="tab-content active">
                <div class="avatar-categories" id="availableCategories">
                    <!-- Available avatars will be populated here -->
                </div>
            </div>
            
            <div id="comingSoonTab" class="tab-content">
                <div class="avatar-categories" id="comingSoonCategories">
                    <!-- Locked avatars will be populated here -->
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="saveSelectedAvatar()">Save Avatar</button>
                <button class="modal-btn secondary" onclick="closeAvatarModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Level Up Notification -->
    <div id="levelUpNotification" class="level-up-notification">
        <!-- Content will be dynamically generated -->
    </div>

    <!-- Achievements Modal -->
    <div id="achievementsModal" class="avatar-modal" style="display: none;">
        <div class="avatar-modal-content">
            <div class="modal-header">
                <h3>🏆 Colosseum Achievements</h3>
                <button class="modal-close" onclick="closeAchievementsModal()">×</button>
            </div>
            
            <div id="achievementsContent" style="max-height: 400px; overflow-y: auto; padding: 20px;">
                <!-- Achievements will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentStudent = null;
        let currentClass = null;
        let currentStudentCode = null;
        let selectedAvatar = 'happy';
        let currentXP = 0;
        let currentLevel = 1;
        let lastKudosCount = 0;

        // Enhanced error logging for Chromebook diagnostics
        function logError(context, error, additionalData = {}) {
            const errorInfo = {
                context: context,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                online: navigator.onLine,
                connection: navigator.connection ? {
                    effectiveType: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink,
                    rtt: navigator.connection.rtt
                } : 'unknown',
                error: {
                    message: error.message || error,
                    name: error.name,
                    stack: error.stack,
                    toString: error.toString()
                },
                url: window.location.href,
                studentData: {
                    currentStudent: currentStudent,
                    currentClass: currentClass,
                    currentLevel: currentLevel
                },
                ...additionalData
            };
            
            console.error(`[${context}] Enhanced Error Log:`, errorInfo);
            
            // Check if this is a Chromebook
            const isChromebook = /\bCrOS\b/.test(navigator.userAgent);
            if (isChromebook) {
                console.warn('🔍 CHROMEBOOK DETECTED - This error occurred on a Chromebook device');
            }
            
            return errorInfo;
        }

        // Global error handler for unhandled errors
        window.addEventListener('error', function(event) {
            logError('Global Error Handler', event.error, {
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno
            });
        });

        // Global handler for unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            logError('Unhandled Promise Rejection', event.reason);
        });

        // Avatar options using Dicebear seeds for variety
        // Avatar System with Level-Based Unlocks
        const avatarsByLevel = {
            1: {
                category: "Starter Pack",
                avatars: ['happy', 'cheerful', 'smile', 'joy', 'bright']
            },
            3: {
                category: "Hero Squad",
                avatars: ['superhero', 'super-student', 'captain-awesome']
            },
            6: {
                category: "Animal Kingdom",
                avatars: ['panda-master', 'koala-warrior', 'fox-genius']
            },
            9: {
                category: "Space Explorers",
                avatars: ['astronaut', 'space-ranger', 'galaxy-pilot']
            },
            12: {
                category: "Magical Beings",
                avatars: ['fairy-guardian', 'elf-scholar', 'wizard-apprentice']
            },
            15: {
                category: "Cool Vehicles",
                avatars: ['spaceship-pilot', 'racecar-driver', 'airplane-captain']
            },
            18: {
                category: "Ultimate Legends",
                avatars: ['legend-supreme', 'master-champion', 'ultimate-hero']
            }
        };

        // Keep original basic avatars available at all levels + add exciting new ones
        const basicAvatars = [
            // Original positive traits
            'sunny', 'friendly', 'cool', 'awesome', 'super', 'star', 'champion', 'hero', 'winner', 'amazing', 
            'fantastic', 'wonderful', 'brilliant', 'clever', 'smart', 'creative', 'artistic', 'musical', 'sporty', 
            'adventurous', 'brave', 'kind', 'gentle', 'caring', 'helpful',
            
            // Animals
            'cat', 'dog', 'tiger', 'lion', 'wolf', 'eagle', 'dolphin', 'bear', 'elephant', 'giraffe',
            'monkey', 'rabbit', 'turtle', 'owl', 'penguin', 'kangaroo', 'zebra', 'shark', 'whale', 'butterfly',
            
            // Professions (Heroes)
            'doctor', 'firefighter', 'police-officer', 'teacher', 'scientist', 'engineer', 'pilot', 'chef',
            'artist', 'musician', 'athlete', 'dancer', 'photographer', 'detective', 'nurse', 'builder',
            
            // Fantasy & Magical
            'dragon', 'unicorn', 'phoenix', 'pegasus', 'griffin', 'fairy', 'elf', 'wizard', 'knight', 'mage',
            'angel', 'genie', 'centaur', 'mermaid', 'pixie',
            
            // Space & Sci-Fi
            'alien', 'robot', 'cyborg', 'android', 'martian', 'cosmic-being',
            
            // Objects & Vehicles (as character concepts)
            'rocket', 'car', 'plane', 'boat', 'train', 'bicycle', 'skateboard'
        ];

        // Helper function to get current XP (separate from kudos points)
        function getCurrentXP() {
            const studentXPKey = `student_xp_${currentStudent?.id || 'unknown'}`;
            return parseInt(localStorage.getItem(studentXPKey)) || 0;
        }

        // Function to get available avatars for current level
        function getAvailableAvatars(currentLevel) {
            let availableAvatars = [...basicAvatars]; // All basic avatars are always available
            
            // Add level-unlocked premium avatars
            for (const [levelReq, pack] of Object.entries(avatarsByLevel)) {
                if (currentLevel >= parseInt(levelReq)) {
                    availableAvatars = availableAvatars.concat(pack.avatars);
                }
            }
            
            return availableAvatars;
        }

        // Function to get locked avatars for preview
        function getLockedAvatars(currentLevel) {
            let lockedAvatars = [];
            
            for (const [levelReq, pack] of Object.entries(avatarsByLevel)) {
                if (currentLevel < parseInt(levelReq)) {
                    lockedAvatars.push({
                        level: parseInt(levelReq),
                        category: pack.category,
                        avatars: pack.avatars
                    });
                }
            }
            
            return lockedAvatars;
        }

        // Function to generate avatar URL - using adventurer style for students, different from main app's bottts
        function getAvatarUrl(seed) {
            return `https://api.dicebear.com/7.x/adventurer/svg?seed=${encodeURIComponent(seed)}`;
        }

        // XP requirements for each level
        const xpRequirements = [0, 25, 75, 150, 250, 400, 600, 850, 1150, 1500, 1900, 2350, 2850, 3400, 4000, 4650, 5350, 6100, 6900, 7750, 8650];

        // Session persistence functions
        function saveSession(student, classCode, studentCode) {
            const sessionData = {
                student: student,
                classCode: classCode,
                studentCode: studentCode,
                timestamp: Date.now()
            };
            sessionStorage.setItem('studentSession', JSON.stringify(sessionData));
            console.log('Session saved:', sessionData);
        }

        function loadSession() {
            const sessionData = sessionStorage.getItem('studentSession');
            if (sessionData) {
                try {
                    const parsed = JSON.parse(sessionData);
                    // Check if session is less than 24 hours old
                    const isValid = (Date.now() - parsed.timestamp) < (24 * 60 * 60 * 1000);
                    if (isValid) {
                        console.log('Valid session found:', parsed);
                        return parsed;
                    } else {
                        sessionStorage.removeItem('studentSession');
                        console.log('Session expired, removed');
                    }
                } catch (e) {
                    console.error('Error parsing session:', e);
                    sessionStorage.removeItem('studentSession');
                }
            }
            return null;
        }

        function clearSession() {
            sessionStorage.removeItem('studentSession');
            console.log('Session cleared');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Enhanced portal with avatars & XP loaded successfully!');
            setupEventListeners();
            populateAvatarGrid();
            loadSavedAvatar();
            
            // Check for existing session
            const existingSession = loadSession();
            if (existingSession) {
                console.log('Restoring session for:', existingSession.student.name);
                currentStudent = existingSession.student;
                currentClass = existingSession.classCode;
                currentStudentCode = existingSession.studentCode;
                showDashboard();
            }
        });

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Auto-format student code input (numbers only)
            document.getElementById('studentCode').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/\D/g, '').slice(0, 4);
            });

            // Auto-refresh kudos every 30 seconds
            setInterval(async () => {
                if (currentStudent) {
                    await loadStudentKudos(true); // Silent refresh
                }
            }, 30000);
        }

        // XP Management Functions
        function resetStudentXP() {
            if (currentStudent) {
                const studentXPKey = `student_xp_${currentStudent.id}`;
                localStorage.removeItem(studentXPKey);
                console.log('XP reset for student:', currentStudent.name);
                // Reload to recalculate XP
                if (typeof loadStudentKudos === 'function') {
                    loadStudentKudos();
                }
            }
        }
        
        // Make resetStudentXP available globally for testing
        window.resetStudentXP = resetStudentXP;

        // Badge Collection Functions
        function getBadgeData() {
            return {
                1: { icon: "🎉", title: "First Steps!" },
                2: { icon: "🌟", title: "Rising Star!" },
                3: { icon: "⚡", title: "Power Player!" },
                4: { icon: "🔥", title: "On Fire!" },
                5: { icon: "💎", title: "Diamond Achiever!" },
                6: { icon: "🏆", title: "Champion!" },
                7: { icon: "🚀", title: "Rocket Scientist!" },
                8: { icon: "👑", title: "Knowledge Royalty!" },
                9: { icon: "🎯", title: "Master Marksman!" },
                10: { icon: "🌈", title: "Rainbow Warrior!" },
                11: { icon: "⭐", title: "Superstar!" },
                12: { icon: "🔮", title: "Wisdom Oracle!" },
                13: { icon: "🎪", title: "Learning Maestro!" },
                14: { icon: "🌊", title: "Tsunami of Talent!" },
                15: { icon: "🎨", title: "Master Artist!" },
                16: { icon: "🏰", title: "Castle Builder!" },
                17: { icon: "🦄", title: "Legendary Unicorn!" },
                18: { icon: "🌌", title: "Galaxy Guardian!" },
                19: { icon: "🔥", title: "Phoenix Rising!" },
                20: { icon: "👑", title: "Ultimate Legend!" }
            };
        }

        function updateBadgeCollection(currentLevel) {
            const badgeGrid = document.getElementById('badgeGrid');
            const badgeData = getBadgeData();
            const maxDisplayLevel = 20; // Show badges up to level 20
            
            badgeGrid.innerHTML = '';
            
            for (let level = 1; level <= maxDisplayLevel; level++) {
                const badge = badgeData[level] || { icon: "⭐", title: "Level Master!" };
                const isUnlocked = level <= currentLevel;
                
                const badgeElement = document.createElement('div');
                badgeElement.className = `achievement-badge ${!isUnlocked ? 'locked' : ''}`;
                badgeElement.innerHTML = `
                    <div class="badge-icon">${isUnlocked ? badge.icon : '🔒'}</div>
                    <div class="badge-level">${level}</div>
                    <div class="badge-title">${isUnlocked ? badge.title : `Level ${level}`}</div>
                `;
                
                if (!isUnlocked) {
                    badgeElement.title = `Unlock at Level ${level}`;
                } else {
                    badgeElement.title = `${badge.title} - Achieved!`;
                }
                
                badgeGrid.appendChild(badgeElement);
            }
        }

        function populateAvatarGrid() {
            const currentLevel = calculateLevel(getCurrentXP());
            
            populateAvailableTab(currentLevel);
            populateComingSoonTab(currentLevel);
        }
        
        function populateAvailableTab(currentLevel) {
            const container = document.getElementById('availableCategories');
            container.innerHTML = '';
            
            // Basic Avatars (backward compatibility - always available)
            if (basicAvatars.length > 0) {
                const basicCategory = document.createElement('div');
                basicCategory.className = 'avatar-category';
                basicCategory.innerHTML = `
                    <div class="category-header">
                        <div class="category-title">⭐ Classic Collection</div>
                        <div class="category-progress">${basicAvatars.length} avatars • Always Available</div>
                    </div>
                    <div class="category-grid" id="basicGrid"></div>
                `;
                container.appendChild(basicCategory);
                
                const basicGrid = document.getElementById('basicGrid');
                basicAvatars.forEach(avatar => {
                    createAvatarOption(avatar, basicGrid, false);
                });
            }
            
            // Unlocked Premium Categories
            for (const [levelReq, pack] of Object.entries(avatarsByLevel)) {
                if (currentLevel >= parseInt(levelReq)) {
                    const category = document.createElement('div');
                    category.className = 'avatar-category';
                    category.innerHTML = `
                        <div class="category-header">
                            <div class="category-title">⭐ ${pack.category}</div>
                            <div class="category-progress">Level ${levelReq} • ${pack.avatars.length} avatars</div>
                        </div>
                        <div class="category-grid" id="level${levelReq}Grid"></div>
                    `;
                    container.appendChild(category);
                    
                    const categoryGrid = document.getElementById(`level${levelReq}Grid`);
                    pack.avatars.forEach(avatar => {
                        createAvatarOption(avatar, categoryGrid, false);
                    });
                }
            }
        }
        
        function populateComingSoonTab(currentLevel) {
            const container = document.getElementById('comingSoonCategories');
            container.innerHTML = '';
            
            let hasLockedContent = false;
            
            // Locked Premium Categories
            for (const [levelReq, pack] of Object.entries(avatarsByLevel)) {
                if (currentLevel < parseInt(levelReq)) {
                    hasLockedContent = true;
                    const levelsToGo = parseInt(levelReq) - currentLevel;
                    
                    const category = document.createElement('div');
                    category.className = 'avatar-category';
                    category.innerHTML = `
                        <div class="category-header locked">
                            <div class="category-title">🔒 ${pack.category}</div>
                            <div class="category-progress">Level ${levelReq} • ${levelsToGo} level${levelsToGo > 1 ? 's' : ''} to go</div>
                        </div>
                        <div class="category-grid" id="locked${levelReq}Grid"></div>
                    `;
                    container.appendChild(category);
                    
                    const categoryGrid = document.getElementById(`locked${levelReq}Grid`);
                    pack.avatars.forEach(avatar => {
                        createAvatarOption(avatar, categoryGrid, true, parseInt(levelReq));
                    });
                }
            }
            
            if (!hasLockedContent) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 3em; margin-bottom: 15px;">🎉</div>
                        <h3>Congratulations!</h3>
                        <p>You've unlocked all available avatar categories!</p>
                        <p style="font-size: 0.9em; opacity: 0.8;">More categories coming soon...</p>
                    </div>
                `;
            }
        }
        
        function createAvatarOption(avatar, container, isLocked = false, unlockLevel = null) {
            const option = document.createElement('div');
            option.className = 'avatar-option';
            
            if (isLocked) {
                option.classList.add('locked');
                option.style.opacity = '0.4';
                option.style.filter = 'grayscale(100%)';
                option.title = `Unlock at Level ${unlockLevel}`;
            }
            
            const img = document.createElement('img');
            img.src = getAvatarUrl(avatar);
            img.alt = avatar;
            option.appendChild(img);
            
            if (isLocked) {
                const lockOverlay = document.createElement('div');
                lockOverlay.innerHTML = '🔒';
                lockOverlay.style.position = 'absolute';
                lockOverlay.style.top = '50%';
                lockOverlay.style.left = '50%';
                lockOverlay.style.transform = 'translate(-50%, -50%)';
                lockOverlay.style.fontSize = '16px';
                lockOverlay.style.textShadow = '0 0 3px rgba(0,0,0,0.8)';
                lockOverlay.style.zIndex = '2';
                
                option.style.position = 'relative';
                option.appendChild(lockOverlay);
                
                option.onclick = () => {
                    alert(`🔒 This avatar unlocks at Level ${unlockLevel}!\n\nKeep earning points to reach it! You're currently Level ${calculateLevel(getCurrentXP())}.`);
                };
            } else {
                option.onclick = () => selectAvatar(avatar, option);
            }
            
            container.appendChild(option);
        }

        function switchAvatarTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'available') {
                document.getElementById('availableTab').classList.add('active');
            } else if (tabName === 'coming-soon') {
                document.getElementById('comingSoonTab').classList.add('active');
            }
        }

        function selectAvatar(avatar, element) {
            // Remove previous selection
            document.querySelectorAll('.avatar-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Add selection to clicked avatar
            element.classList.add('selected');
            selectedAvatar = avatar;
        }

        function openAvatarModal() {
            document.getElementById('avatarModal').style.display = 'block';
            populateAvatarGrid();
            
            // Reset to available tab
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector('.tab-button').classList.add('active');
            document.getElementById('availableTab').classList.add('active');
            
            // Highlight current avatar after a short delay to ensure DOM is ready
            setTimeout(() => {
                document.querySelectorAll('.avatar-option').forEach(opt => {
                    opt.classList.remove('selected');
                    const img = opt.querySelector('img');
                    if (img && img.src.includes(selectedAvatar)) {
                        opt.classList.add('selected');
                    }
                });
            }, 100);
        }

        function closeAvatarModal() {
            document.getElementById('avatarModal').style.display = 'none';
        }

        function saveSelectedAvatar() {
            document.getElementById('avatarDisplay').src = getAvatarUrl(selectedAvatar);
            localStorage.setItem('studentAvatar', selectedAvatar);
            
            // Save avatar to database
            if (currentStudent && currentStudent.id) {
                saveAvatarToDatabase(selectedAvatar);
            }
            
            closeAvatarModal();
            console.log('Avatar saved:', selectedAvatar);
        }

        async function saveAvatarToDatabase(avatar) {
            try {
                const response = await fetch('https://classkudos.org/.netlify/functions/updateStudentAvatar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        studentId: currentStudent.id,
                        avatar: avatar
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('Avatar saved to database successfully');
                } else {
                    console.error('Failed to save avatar to database:', data.error);
                }
            } catch (error) {
                console.error('Error saving avatar to database:', error);
            }
        }

        function loadSavedAvatar() {
            // First try to load from student data (database)
            if (currentStudent && currentStudent.avatar_data) {
                // Check if it's already a URL or a seed
                if (currentStudent.avatar_data.startsWith('http')) {
                    selectedAvatar = currentStudent.avatar_data.split('seed=')[1] || 'default';
                } else {
                    selectedAvatar = currentStudent.avatar_data;
                }
                document.getElementById('avatarDisplay').src = getAvatarUrl(selectedAvatar);
                localStorage.setItem('studentAvatar', selectedAvatar);
                return;
            }
            
            // Fall back to localStorage
            const saved = localStorage.getItem('studentAvatar');
            if (saved) {
                selectedAvatar = saved;
                document.getElementById('avatarDisplay').src = getAvatarUrl(selectedAvatar);
            }
        }

        function calculateLevel(totalPoints) {
            let level = 1;
            for (let i = 1; i < xpRequirements.length; i++) {
                if (totalPoints >= xpRequirements[i]) {
                    level = i + 1;
                } else {
                    break;
                }
            }
            return level;
        }

        function calculateXPProgress(totalPoints, level) {
            if (level >= xpRequirements.length) {
                return { current: totalPoints, required: totalPoints, percentage: 100 };
            }
            
            const currentLevelXP = xpRequirements[level - 1];
            const nextLevelXP = xpRequirements[level] || totalPoints;
            const progressXP = totalPoints - currentLevelXP;
            const requiredXP = nextLevelXP - currentLevelXP;
            const percentage = Math.min(100, (progressXP / requiredXP) * 100);
            
            return {
                current: progressXP,
                required: requiredXP,
                percentage: percentage
            };
        }

        function updateXPDisplay(totalPoints) {
            console.log('updateXPDisplay called with totalPoints:', totalPoints);
            const newLevel = calculateLevel(totalPoints);
            const progress = calculateXPProgress(totalPoints, newLevel);
            console.log('Calculated level:', newLevel, 'Progress:', progress);
            
            // Check for level up
            if (newLevel > currentLevel && currentLevel > 1) {
                showLevelUpNotification(newLevel);
            }
            
            currentLevel = newLevel;
            currentXP = totalPoints;
            
            // Update displays with debugging
            const studentLevelEl = document.getElementById('studentLevel');
            const levelBadgeEl = document.getElementById('levelBadge');
            const xpBarEl = document.getElementById('xpBar');
            const xpTextEl = document.getElementById('xpText');
            
            console.log('DOM Elements found:', {
                studentLevel: !!studentLevelEl,
                levelBadge: !!levelBadgeEl, 
                xpBar: !!xpBarEl,
                xpText: !!xpTextEl
            });
            
            if (studentLevelEl) studentLevelEl.textContent = newLevel;
            if (levelBadgeEl) levelBadgeEl.textContent = newLevel;
            if (xpBarEl) {
                xpBarEl.style.width = progress.percentage + '%';
                console.log('Updated XP bar width to:', progress.percentage + '%');
            }
            if (xpTextEl) {
                const newText = `XP: ${progress.current} / ${progress.required} (Level ${newLevel})`;
                xpTextEl.textContent = newText;
                console.log('Updated XP text to:', newText);
            }
            
            // Update badge collection
            updateBadgeCollection(newLevel);
        }

        function showLevelUpNotification(level) {
            // Achievement messages and emojis for different levels
            const levelAchievements = {
                1: { icon: "🎉", title: "First Steps!", message: "Welcome to your learning journey!" },
                2: { icon: "🌟", title: "Rising Star!", message: "You're building momentum!" },
                3: { icon: "⚡", title: "Power Player!", message: "Your dedication is showing!" },
                4: { icon: "🔥", title: "On Fire!", message: "You're really getting the hang of this!" },
                5: { icon: "💎", title: "Diamond Achiever!", message: "Your hard work is paying off!" },
                6: { icon: "🏆", title: "Champion!", message: "You're becoming unstoppable!" },
                7: { icon: "🚀", title: "Rocket Scientist!", message: "Your knowledge is skyrocketing!" },
                8: { icon: "👑", title: "Knowledge Royalty!", message: "You rule this classroom!" },
                9: { icon: "🎯", title: "Master Marksman!", message: "Hitting every target perfectly!" },
                10: { icon: "🌈", title: "Rainbow Warrior!", message: "You bring color to learning!" },
                11: { icon: "⭐", title: "Superstar!", message: "Your brilliance shines bright!" },
                12: { icon: "🔮", title: "Wisdom Oracle!", message: "You see the bigger picture!" },
                13: { icon: "🎪", title: "Learning Maestro!", message: "You make it look effortless!" },
                14: { icon: "🌊", title: "Tsunami of Talent!", message: "Your skills are overwhelming!" },
                15: { icon: "🎨", title: "Master Artist!", message: "You've painted success!" },
                16: { icon: "🏰", title: "Castle Builder!", message: "Your knowledge fortress is strong!" },
                17: { icon: "🦄", title: "Legendary Unicorn!", message: "Rare and magical talent!" },
                18: { icon: "🌌", title: "Galaxy Guardian!", message: "Protecting knowledge across space!" },
                19: { icon: "🔥", title: "Phoenix Rising!", message: "Reborn stronger than ever!" },
                20: { icon: "👑", title: "Ultimate Legend!", message: "You've achieved the impossible!" }
            };
            
            const achievement = levelAchievements[level] || { 
                icon: "⭐", 
                title: "Level Master!", 
                message: "Your dedication knows no bounds!" 
            };
            
            // Check if this level unlocks new avatars
            const avatarUnlock = avatarsByLevel[level];
            let avatarUnlockMessage = '';
            
            if (avatarUnlock) {
                avatarUnlockMessage = `
                    <div class="avatar-unlock-notification">
                        🔓 <strong>New Avatars Unlocked!</strong><br>
                        <em>${avatarUnlock.category}</em> - ${avatarUnlock.avatars.length} new avatars available!
                        <br><small>Check your avatar selection to try them out!</small>
                    </div>
                `;
            }
            
            const notification = document.getElementById('levelUpNotification');
            notification.innerHTML = `
                <div class="level-up-content">
                    <div class="level-up-badge">
                        <div class="level-up-number">${level}</div>
                    </div>
                    <h2>LEVEL UP!</h2>
                    <div class="level-up-message">${achievement.title}</div>
                    <div class="level-up-subtitle">${achievement.message}</div>
                    <div class="level-up-achievement">
                        <span class="achievement-icon">${achievement.icon}</span>
                        <span class="achievement-text">Level ${level} Unlocked!</span>
                    </div>
                    ${avatarUnlockMessage}
                </div>
            `;
            
            notification.style.display = 'block';
            
            // Play celebration sound if available
            try {
                const audio = new Audio('../Audio/ding.wav');
                audio.play().catch(() => {}); // Ignore if audio fails
            } catch (e) {}
            
            // Hide after animation completes (longer if avatar unlock)
            setTimeout(() => {
                notification.style.display = 'none';
            }, avatarUnlock ? 6000 : 4000);
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const loginBtn = document.getElementById('loginBtn');
            const errorMessage = document.getElementById('errorMessage');
            
            // Get form data
            const classCode = document.getElementById('classCode').value.trim();
            const studentCode = document.getElementById('studentCode').value.trim();
            
            // Validate inputs
            if (!classCode || !studentCode) {
                showError('Please enter both class code and student code');
                return;
            }
            
            if (studentCode.length !== 4 || !/^\d+$/.test(studentCode)) {
                showError('Student code must be exactly 4 digits');
                return;
            }
            
            // Show loading state
            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';
            errorMessage.style.display = 'none';
            
            try {
                console.log('Attempting login with:', { classCode, studentCode });
                
                const response = await fetch(`https://classkudos.org/.netlify/functions/consistentStudentAuth`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        classCode: classCode,
                        studentCode: studentCode
                    })
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (response.ok && data.success) {
                    // Store student data
                    currentStudent = data.student;
                    currentClass = classCode;
                    currentStudentCode = studentCode;
                    
                    console.log('Login successful:', currentStudent);
                    
                    // Save session for persistence
                    saveSession(currentStudent, classCode, studentCode);
                    
                    // Show dashboard
                    showDashboard();
                } else {
                    console.error('Login failed:', data.message);
                    showError(data.message || 'Login failed. Please check your codes and try again.');
                }
            } catch (error) {
                logError('Student Login', error, {
                    endpoint: '../netlify/functions/consistentStudentAuth',
                    studentCode: document.getElementById('studentCode').value,
                    className: document.getElementById('className').value
                });
                showError('Connection error. Please check your internet and try again.');
            } finally {
                // Reset button state
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login to Portal';
            }
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function showDashboard() {
            // Hide login, show dashboard
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').classList.remove('hidden');
            
            // Update student info
            updateStudentProfile();
            
            // Load dashboard data
            loadDashboardData();
        }

        function updateStudentProfile() {
            document.getElementById('studentName').textContent = currentStudent.name;
            document.getElementById('studentClass').textContent = currentClass;
            document.getElementById('displayStudentCode').textContent = currentStudentCode;
            
            // Load avatar from database if available
            if (currentStudent.avatar_data) {
                // Check if it's already a URL or a seed
                if (currentStudent.avatar_data.startsWith('http')) {
                    selectedAvatar = currentStudent.avatar_data.split('seed=')[1] || 'default';
                } else {
                    selectedAvatar = currentStudent.avatar_data;
                }
                document.getElementById('avatarDisplay').src = getAvatarUrl(selectedAvatar);
                localStorage.setItem('studentAvatar', selectedAvatar);
            } else {
                // Load from localStorage as fallback
                loadSavedAvatar();
            }
        }

        function refreshStudentData() {
            // Update all student data displays with current student data
            if (currentStudent) {
                console.log('refreshStudentData called with currentStudent.points:', currentStudent.points);
                
                // Update kudos display with actual kudos points from database
                document.getElementById('totalKudos').textContent = currentStudent.points || 0;
                
                // Update XP display with separate XP system (NOT kudos points)
                const currentXP = getCurrentXP();
                updateXPDisplay(currentXP);
                
                // DO NOT sync localStorage with database points for XP
                // XP and kudos are now separate systems
                
                // Update avatar if changed
                if (currentStudent.avatar_data && currentStudent.avatar_data !== selectedAvatar) {
                    // Check if it's already a URL or a seed
                    if (currentStudent.avatar_data.startsWith('http')) {
                        selectedAvatar = currentStudent.avatar_data.split('seed=')[1] || 'default';
                    } else {
                        selectedAvatar = currentStudent.avatar_data;
                    }
                    document.getElementById('avatarDisplay').src = getAvatarUrl(selectedAvatar);
                    localStorage.setItem('studentAvatar', selectedAvatar);
                }
                
                // Update session with latest data
                if (currentClass && currentStudentCode) {
                    saveSession(currentStudent, currentClass, currentStudentCode);
                }
                
                console.log('Student data refreshed - Points:', currentStudent.points);
            }
        }

        async function loadDashboardData() {
            console.log('Loading dashboard for student:', currentStudent);
            
            // Update XP display with separate XP system
            const currentXP = getCurrentXP();
            updateXPDisplay(currentXP);
            
            // Initialize badge collection with current level based on XP
            const currentLevel = calculateLevel(currentXP);
            updateBadgeCollection(currentLevel || 1);
            
            // Load student kudos
            await loadStudentKudos();
            
            // Load leaderboard
            await loadLeaderboard();
        }

        async function loadStudentKudos(silent = false) {
            const kudosList = document.getElementById('kudosList');
            
            try {
                console.log('Loading kudos for student ID:', currentStudent.id);
                
                if (!silent) {
                    kudosList.innerHTML = '<p style="text-align: center; color: #666;">📚 Loading your achievements...</p>';
                }
                
                // Shorter timeout for better Chromebook experience
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                // Use relative path first (correct for student portal), then fallback to full URL
                const apiUrl = `/.netlify/functions/getKudos?studentId=${encodeURIComponent(currentStudent.id)}&classCode=${encodeURIComponent(currentClass)}`;
                
                const response = await fetch(apiUrl, {
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    cache: 'no-cache'
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Kudos data:', data);
                
                if (data.success) {
                    const kudos = data.kudos || [];
                    
                    // Update current student data if returned
                    if (data.student) {
                        // Update points from database
                        currentStudent.points = data.student.points;
                        currentStudent.avatar_data = data.student.avatar_data;
                        
                        // Refresh the display with updated data
                        refreshStudentData();
                    }
                    
                    updateKudosStats(kudos);
                    updateKudosFeed(kudos, silent);
                } else {
                    throw new Error(data.message || 'Unknown error loading achievements');
                }
                
            } catch (error) {
                const errorInfo = logError('Load Student Kudos', error, {
                    endpoint: 'getKudos',
                    requestParams: { studentCode: currentStudentCode, className: currentClass },
                    silent: silent
                });
                
                if (!silent) {
                    let errorMessage = '❌ Unable to load achievements';
                    
                    if (error.name === 'AbortError') {
                        errorMessage = '⏱️ Connection timeout - Check your WiFi';
                    } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        errorMessage = '🌐 Network connection issue - Check your WiFi';
                    } else if (error.message.includes('HTTP')) {
                        errorMessage = `🔒 Server error: ${error.message}`;
                    }
                    
                    kudosList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #e74c3c; background: #f8f9fa; border-radius: 8px; margin: 10px;">
                            <div style="font-size: 1.1em; margin-bottom: 15px;">${errorMessage}</div>
                            <div style="margin-bottom: 15px; color: #666; font-size: 0.9em;">
                                If this keeps happening, ask your teacher for help
                            </div>
                            <button onclick="loadStudentKudos()" style="
                                background: #667eea; 
                                color: white; 
                                border: none; 
                                padding: 10px 20px; 
                                border-radius: 6px; 
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: bold;
                            ">
                                🔄 Try Again
                            </button>
                        </div>
                    `;
                }
            }
        }

        function updateKudosStats(kudos) {
            // Display actual kudos points from database (NOT including game XP)
            const totalKudosPoints = currentStudent.points || 0;
            document.getElementById('totalKudos').textContent = totalKudosPoints;
            
            // SEPARATE XP SYSTEM: XP is separate from kudos points
            console.log('Total kudos points from database:', totalKudosPoints);
            console.log('All kudos received:', kudos);
            
            // Get stored XP from localStorage (separate from kudos)
            const studentXPKey = `student_xp_${currentStudent.id}`;
            let currentXP = parseInt(localStorage.getItem(studentXPKey)) || 0;
            console.log('Current stored XP:', currentXP);
            
            // Calculate expected XP from positive kudos (kudos → XP conversion)
            const positiveKudos = kudos.filter(kudo => (kudo.points || 0) > 0);
            const expectedXPFromKudos = positiveKudos.reduce((sum, kudo) => sum + (kudo.points || 0), 0);
            
            console.log('Positive kudos only:', positiveKudos);
            console.log('Expected XP from kudos:', expectedXPFromKudos);
            
            // XP should be at least equal to kudos points (kudos give XP)
            // But XP can be higher due to games (games add extra XP)
            if (expectedXPFromKudos > currentXP) {
                // Student earned new kudos, increase XP to match
                currentXP = expectedXPFromKudos;
                localStorage.setItem(studentXPKey, currentXP.toString());
                console.log('XP increased from new kudos! New XP:', currentXP);
            } else if (currentXP < expectedXPFromKudos) {
                // This shouldn't happen, but if it does, set XP to kudos minimum
                currentXP = expectedXPFromKudos;
                localStorage.setItem(studentXPKey, currentXP.toString());
                console.log('XP corrected to match kudos minimum:', currentXP);
            } else {
                console.log('XP unchanged:', currentXP);
            }
            
            console.log('Final XP for level calculation:', currentXP);
            
            // Update XP and level using the correct XP value
            updateXPDisplay(currentXP);
            
            // Calculate recent kudos (last 7 days)
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            const recentKudos = kudos.filter(kudo => {
                const kudoDate = new Date(kudo.date_awarded || kudo.created_at);
                return kudoDate >= oneWeekAgo;
            });
            
            const recentPoints = recentKudos.reduce((sum, kudo) => sum + (kudo.points || 1), 0);
            document.getElementById('recentKudos').textContent = recentPoints;
        }

        function updateKudosFeed(kudos, silent = false) {
            const kudosList = document.getElementById('kudosList');
            
            if (kudos.length === 0) {
                kudosList.innerHTML = '<p style="text-align: center; color: #666;">No achievements yet. Keep working hard!</p>';
                return;
            }
            
            // Sort kudos by date (most recent first)
            const sortedKudos = kudos.sort((a, b) => {
                const dateA = new Date(a.date_awarded || a.created_at);
                const dateB = new Date(b.date_awarded || b.created_at);
                return dateB - dateA;
            });
            
            const newKudos = !silent && sortedKudos.length > lastKudosCount;
            lastKudosCount = sortedKudos.length;
            
            kudosList.innerHTML = sortedKudos.map((kudo, index) => {
                const date = new Date(kudo.date_awarded || kudo.created_at);
                const isNew = newKudos && index === 0;
                
                return `
                    <div class="kudos-item ${isNew ? 'new' : ''}">
                        <div class="kudos-header">
                            <span class="kudos-points">+${kudo.points || 1} points</span>
                            <span class="kudos-date">${date.toLocaleDateString()}</span>
                        </div>
                        <div class="kudos-reason">${kudo.reason || 'Great work!'}</div>
                        ${kudo.description ? `<div class="kudos-description">${kudo.description}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Chromebook diagnostic and fallback system
        let diagnosticMode = false;
        let leaderboardAttempts = 0;
        
        async function testNetworkConnectivity() {
            const testUrls = [
                'https://www.google.com/favicon.ico',
                'https://classkudos-students.netlify.app/favicon.ico',
                'https://netlify.com/favicon.ico'
            ];
            
            const results = [];
            
            for (const url of testUrls) {
                try {
                    const controller = new AbortController();
                    setTimeout(() => controller.abort(), 2000);
                    
                    const response = await fetch(url, {
                        signal: controller.signal,
                        mode: 'no-cors',
                        cache: 'no-cache'
                    });
                    
                    results.push({ url: url.split('/')[2], status: 'OK' });
                } catch (error) {
                    results.push({ url: url.split('/')[2], status: 'FAILED' });
                }
            }
            
            return results;
        }
        
        function enableDiagnosticMode() {
            diagnosticMode = true;
            console.log('🔧 DIAGNOSTIC MODE ENABLED - Detailed logging activated');
            
            // Show diagnostic info
            const leaderboardList = document.getElementById('leaderboardList');
            leaderboardList.innerHTML = `
                <div style="text-align: center; padding: 20px; background: #e3f2fd; border-radius: 8px; margin: 10px;">
                    <h3 style="color: #1976d2; margin-bottom: 15px;">🔧 Diagnostic Mode</h3>
                    <div style="color: #333; margin-bottom: 10px; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto;">
                        <strong>Browser:</strong> ${navigator.userAgent.includes('Chrome') ? 'Chrome' : 'Other'}<br>
                        <strong>Device:</strong> ${navigator.userAgent.includes('CrOS') ? 'Chromebook' : 'Other'}<br>
                        <strong>Connection:</strong> ${navigator.onLine ? 'Online' : 'Offline'}<br>
                        <strong>Class:</strong> ${currentClass}<br>
                        <strong>Student ID:</strong> ${currentStudent?.id || 'Not set'}<br>
                        <strong>Failed Attempts:</strong> ${leaderboardAttempts}
                    </div>
                    
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin: 15px 0;">
                        <button onclick="testNetworkAndShowResults()" style="background: #2196f3; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">
                            🌐 Test Network
                        </button>
                        <button onclick="testAllMethods()" style="background: #1976d2; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">
                            🧪 Test All Methods
                        </button>
                        <button onclick="forceClearCache()" style="background: #f57c00; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">
                            🗑️ Clear Cache
                        </button>
                        <button onclick="loadLeaderboard(0); diagnosticMode=false;" style="background: #388e3c; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">
                            📊 Normal Load
                        </button>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 10px; border-radius: 4px; font-size: 0.85em; color: #856404; margin-top: 15px;">
                        � <strong>Teachers:</strong> Use these tools to help troubleshoot student connection issues.<br>
                        Students can try "Clear Cache" if the leaderboard won't load.
                    </div>
                </div>
            `;
        }
        
        async function testNetworkAndShowResults() {
            const leaderboardList = document.getElementById('leaderboardList');
            
            leaderboardList.innerHTML = `
                <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 10px;">
                    <h3>🌐 Testing Network Connectivity...</h3>
                    <div style="margin: 20px 0;">Please wait while we test your connection...</div>
                </div>
            `;
            
            const results = await testNetworkConnectivity();
            
            const allPassed = results.every(r => r.status === 'OK');
            
            leaderboardList.innerHTML = `
                <div style="text-align: center; padding: 20px; background: ${allPassed ? '#d4edda' : '#f8d7da'}; border-radius: 8px; margin: 10px;">
                    <h3 style="color: ${allPassed ? '#155724' : '#721c24'};">
                        ${allPassed ? '✅ Network Test Results' : '⚠️ Network Test Results'}
                    </h3>
                    
                    <div style="margin: 15px 0; text-align: left; max-width: 300px; margin-left: auto; margin-right: auto;">
                        ${results.map(r => `
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span>${r.url}:</span>
                                <span style="color: ${r.status === 'OK' ? '#28a745' : '#dc3545'}; font-weight: bold;">
                                    ${r.status}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="color: #666; margin: 15px 0; font-size: 0.9em;">
                        ${allPassed 
                            ? 'Your network connection looks good! The issue might be with our specific API.' 
                            : 'Some network connections failed. This might be causing the leaderboard issue.'
                        }
                    </div>
                    
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                        <button onclick="testAllMethods()" style="background: #1976d2; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer;">
                            🧪 Test API Methods
                        </button>
                        <button onclick="loadLeaderboard(0); diagnosticMode=false;" style="background: #28a745; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer;">
                            📊 Try Leaderboard Again
                        </button>
                    </div>
                </div>
            `;
        }
        
        async function testAllMethods() {
            const leaderboardList = document.getElementById('leaderboardList');
            
            const testMethods = [
                {
                    name: 'Relative Path (Recommended)',
                    url: `/.netlify/functions/getLeaderboard?classCode=${encodeURIComponent(currentClass)}&t=${Date.now()}`
                },
                {
                    name: 'Alternative Domain',
                    url: `https://classkudos.org/.netlify/functions/getLeaderboard?classCode=${encodeURIComponent(currentClass)}&t=${Date.now()}`
                },
                {
                    name: 'Cross-Origin (May Fail CORS)',
                    url: `https://classkudos-students.netlify.app/.netlify/functions/getLeaderboard?classCode=${encodeURIComponent(currentClass)}&t=${Date.now()}`
                }
            ];
            
            leaderboardList.innerHTML = '<div style="text-align: center; padding: 20px;">🧪 Testing all methods...</div>';
            
            for (let i = 0; i < testMethods.length; i++) {
                const method = testMethods[i];
                
                try {
                    console.log(`Testing method ${i + 1}: ${method.name}`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000);
                    
                    const response = await fetch(method.url, {
                        signal: controller.signal,
                        headers: method.headers || {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        cache: 'no-cache'
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            console.log(`✅ SUCCESS with method: ${method.name}`);
                            updateLeaderboard(data.leaderboard || []);
                            return;
                        }
                    }
                    
                } catch (error) {
                    console.log(`❌ FAILED method ${method.name}:`, error.message);
                }
            }
            
            // If all methods fail, show comprehensive error
            leaderboardList.innerHTML = `
                <div style="text-align: center; padding: 20px; background: #ffebee; border-radius: 8px; margin: 10px;">
                    <h3 style="color: #c62828;">❌ All Methods Failed</h3>
                    <p style="color: #666; margin: 15px 0;">This suggests a network or device-specific issue.</p>
                    <button onclick="forceClearCache()" style="background: #f57c00; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px;">
                        🗑️ Force Clear Cache
                    </button>
                    <button onclick="enableDiagnosticMode()" style="background: #1976d2; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px;">
                        🔧 Run Diagnostics Again
                    </button>
                </div>
            `;
        }
        
        function forceClearCache() {
            // Clear all possible caches
            localStorage.clear();
            sessionStorage.clear();
            
            // Clear service worker cache if available
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(registration => registration.unregister());
                });
            }
            
            // Clear browser cache using cache API
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                });
            }
            
            // Add cache-busting timestamp
            const cacheBuster = Date.now();
            window.location.href = window.location.href.split('?')[0] + '?cb=' + cacheBuster;
        }

        async function loadLeaderboard(retryCount = 0) {
            const leaderboardList = document.getElementById('leaderboardList');
            leaderboardAttempts++;
            
            try {
                console.log(`Loading leaderboard for class: ${currentClass}, Attempt: ${retryCount + 1}, Total attempts: ${leaderboardAttempts}`);
                
                // Show loading state immediately with attempt counter
                leaderboardList.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 20px;">
                        📊 Loading leaderboard... 
                        <span style="font-size: 0.9em;">(Attempt ${retryCount + 1})</span>
                        <br><br>
                        ${leaderboardAttempts > 3 ? `
                            <button onclick="enableDiagnosticMode()" style="background: #1976d2; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                🔧 Run Diagnostics
                            </button>
                        ` : ''}
                    </div>
                `;
                
                // Progressive timeout - even shorter for multiple retries
                const timeoutDuration = retryCount === 0 ? 4000 : (retryCount === 1 ? 2500 : 2000);
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeoutDuration);
                
                // Multiple URL strategies with cache busting - prioritize relative path
                const cacheBuster = Date.now();
                const apiUrls = [
                    `/.netlify/functions/getLeaderboard?classCode=${encodeURIComponent(currentClass)}&cb=${cacheBuster}`,
                    `https://classkudos.org/.netlify/functions/getLeaderboard?classCode=${encodeURIComponent(currentClass)}&cb=${cacheBuster}`,
                    `https://classkudos-students.netlify.app/.netlify/functions/getLeaderboard?classCode=${encodeURIComponent(currentClass)}&cb=${cacheBuster}`
                ];
                
                const apiUrl = apiUrls[retryCount] || apiUrls[0];
                if (diagnosticMode) console.log('🔗 Calling leaderboard API:', apiUrl);
                
                const fetchOptions = {
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    },
                    cache: 'no-cache',
                    credentials: 'omit' // Don't send cookies - can help with CORS
                };
                
                const response = await fetch(apiUrl, fetchOptions);
                
                clearTimeout(timeoutId);
                if (diagnosticMode) console.log('📡 Leaderboard response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                if (diagnosticMode) console.log('📊 Leaderboard data received:', data);
                
                if (data.success) {
                    if (diagnosticMode) console.log('✅ Leaderboard entries:', data.leaderboard.length);
                    data.leaderboard.forEach((student, index) => {
                        if (diagnosticMode) console.log(`Entry ${index}: name="${student.name}", points=${student.total_points}`);
                    });
                    updateLeaderboard(data.leaderboard || []);
                    leaderboardAttempts = 0; // Reset counter on success
                } else {
                    throw new Error(data.message || 'Unknown error loading leaderboard');
                }
                
            } catch (error) {
                console.error(`Leaderboard loading error (attempt ${retryCount + 1}):`, error);
                
                // Auto-retry with different strategies
                if (retryCount < 2 && (error.name === 'AbortError' || error.message.includes('Failed to fetch'))) {
                    console.log('Auto-retrying with different strategy...');
                    setTimeout(() => loadLeaderboard(retryCount + 1), 1000);
                    return;
                }
                
                const errorInfo = logError('Load Leaderboard', error, {
                    endpoint: 'getLeaderboard',
                    requestParams: { studentCode: currentStudentCode, className: currentClass },
                    retryCount: retryCount,
                    totalAttempts: leaderboardAttempts
                });
                
                // Enhanced error display with more options
                let errorMessage = '❌ Unable to load leaderboard';
                
                if (error.name === 'AbortError') {
                    errorMessage = '⏱️ Connection timeout - Try again in a moment';
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMessage = '🌐 Network connection issue - Check your WiFi';
                } else if (error.message.includes('HTTP')) {
                    errorMessage = `🔒 Server error: ${error.message}`;
                } else {
                    errorMessage = '🔧 Technical issue - Multiple solutions below';
                }
                
                leaderboardList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #e74c3c; background: #f8f9fa; border-radius: 8px; margin: 10px;">
                        <div style="font-size: 1.2em; margin-bottom: 15px;">${errorMessage}</div>
                        <div style="margin-bottom: 20px; color: #666; font-size: 0.9em;">
                            ${retryCount > 0 ? 'Multiple attempts failed. ' : ''}Try the options below:
                        </div>
                        
                        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                            <button onclick="loadLeaderboard(0)" style="
                                background: #667eea; color: white; border: none; padding: 10px 16px; 
                                border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;
                            ">🔄 Try Again</button>
                            
                            <button onclick="forceClearCache()" style="
                                background: #f57c00; color: white; border: none; padding: 10px 16px; 
                                border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;
                            ">🗑️ Clear Cache</button>
                            
                            <button onclick="enableDiagnosticMode()" style="
                                background: #1976d2; color: white; border: none; padding: 10px 16px; 
                                border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;
                            ">🔧 Diagnostics</button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 4px; font-size: 0.85em; color: #856404;">
                            💡 <strong>Teacher:</strong> If this keeps happening, try having the student:<br>
                            1. Close and reopen Chrome completely<br>
                            2. Sign out and back into their Chromebook<br>
                            3. Check if other websites work properly
                        </div>
                    </div>
                `;
            }
        }

        function updateLeaderboard(leaderboard) {
            const leaderboardList = document.getElementById('leaderboardList');
            
            if (leaderboard.length === 0) {
                leaderboardList.innerHTML = '<p style="text-align: center; color: #666;">Leaderboard loading...</p>';
                return;
            }
            
            leaderboardList.innerHTML = leaderboard.map((student, index) => {
                const isCurrentStudent = student.id === currentStudent.id;
                const rank = index + 1;
                const level = calculateLevel(student.total_points);
                const avatar = student.avatar_data || 'default';
                
                // Update current student's rank
                if (isCurrentStudent) {
                    document.getElementById('classRank').textContent = `#${rank}`;
                }
                
                return `
                    <div style="display: flex; align-items: center; padding: 15px; margin-bottom: 10px; 
                                background: ${isCurrentStudent ? '#e3f2fd' : '#f8f9fa'}; 
                                border-radius: 8px; ${isCurrentStudent ? 'border: 2px solid #2196f3;' : ''}">
                        <div style="font-size: 1.5em; font-weight: bold; color: #667eea; margin-right: 15px; min-width: 40px;">
                            #${rank}
                        </div>
                        <div class="avatar" style="margin-right: 15px; width: 50px; height: 50px;">
                            <img src="${getAvatarUrl(avatar)}" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        </div>
                        <div style="flex-grow: 1;">
                            <div style="font-weight: 500; color: #333;">
                                ${student.name} ${isCurrentStudent ? '(You)' : ''}
                            </div>
                            <div style="color: #666; font-size: 0.9em;">
                                Level ${level} • ${student.total_points} points
                            </div>
                        </div>
                        <div style="background: #28a745; color: white; padding: 8px 12px; border-radius: 15px; font-weight: bold;">
                            ${student.total_points}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showSection(section) {
            console.log('Showing section:', section);
            
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Hide all content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(section).classList.add('active');
            
            // Load data for specific sections
            if (section === 'dashboard') {
                // Refresh dashboard with latest XP data
                refreshStudentData();
            } else if (section === 'myKudos') {
                loadStudentKudos();
            } else if (section === 'leaderboard') {
                loadLeaderboard();
            } else if (section === 'kudosColosseum') {
                initializeColosseum();
            } else if (section === 'morphemeMastery') {
                initializeMorphemeMastery();
            }
        }

        function initializeMorphemeMastery() {
            // Reset to selection screen if coming from another section
            document.getElementById('morphemeGameResults').classList.add('hidden');
            document.getElementById('morphemeGameArea').classList.add('hidden');
            document.getElementById('morphemeDifficultySelector').classList.add('hidden');
            document.querySelector('.morpheme-selection').classList.remove('hidden');
            
            // Reset game state
            currentMorphemeGame = {
                type: null,
                difficulty: null,
                score: 0,
                streak: 0,
                timeLeft: 90,
                totalProblems: 0,
                correctAnswers: 0,
                problems: [],
                currentProblem: null,
                gameTimer: null
            };
        }

        // ===============================
        // KUDOS COLOSSEUM GAME LOGIC
        // ===============================
        
        let currentGame = {
            type: null,           // 'multiplication', 'division', 'mixed'
            difficulty: null,     // 'easy', 'medium', 'hard'
            score: 0,
            streak: 0,
            timeLeft: 60,
            currentProblem: null,
            totalProblems: 0,
            correctAnswers: 0,
            gameTimer: null,
            problems: []
        };

        // Audio feedback system
        let audioEnabled = true;
        const correctAudio = new Audio('../Audio/Positive.wav');
        const incorrectAudio = new Audio('../Audio/Negative.wav');
        
        // Set audio volumes
        correctAudio.volume = 0.6;
        incorrectAudio.volume = 0.6;

        // Colosseum Achievements System
        const colosseumAchievements = {
            'first_victory': {
                title: '⚔️ First Victory',
                description: 'Complete your first Colosseum challenge',
                xpReward: 5,
                icon: '🏛️'
            },
            'perfect_warrior': {
                title: '👑 Perfect Warrior',
                description: 'Achieve 100% accuracy in a challenge',
                xpReward: 10,
                icon: '✨'
            },
            'speed_demon': {
                title: '⚡ Lightning Calculator',
                description: 'Complete a challenge with 45+ seconds remaining',
                xpReward: 8,
                icon: '🚀'
            },
            'streak_master': {
                title: '🔥 Streak Master',
                description: 'Get 10 answers correct in a row',
                xpReward: 12,
                icon: '🎯'
            },
            'math_gladiator': {
                title: '🏆 Math Gladiator',
                description: 'Complete 10 Colosseum challenges',
                xpReward: 20,
                icon: '👑'
            },
            'multiplication_champion': {
                title: '✖️ Multiplication Champion',
                description: 'Score 90%+ accuracy in 5 multiplication challenges',
                xpReward: 15,
                icon: '🥇'
            },
            'division_master': {
                title: '➗ Division Master',
                description: 'Score 90%+ accuracy in 5 division challenges',
                xpReward: 15,
                icon: '🥇'
            },
            'colosseum_legend': {
                title: '🌟 Colosseum Legend',
                description: 'Earn 1000 total XP from the Colosseum',
                xpReward: 25,
                icon: '👑'
            }
        };

        // Morpheme Mastery Data
        const morphemeData = {
            prefixes: [
                { morpheme: 'un-', meaning: 'not, opposite of', example: 'unhappy' },
                { morpheme: 're-', meaning: 'again, back', example: 'rewrite' },
                { morpheme: 'pre-', meaning: 'before', example: 'preview' },
                { morpheme: 'dis-', meaning: 'not, opposite of', example: 'disagree' },
                { morpheme: 'mis-', meaning: 'wrong, bad', example: 'mistake' },
                { morpheme: 'over-', meaning: 'too much, above', example: 'overflow' },
                { morpheme: 'under-', meaning: 'below, not enough', example: 'undercooked' },
                { morpheme: 'sub-', meaning: 'under, below', example: 'submarine' },
                { morpheme: 'super-', meaning: 'above, beyond', example: 'superhero' },
                { morpheme: 'anti-', meaning: 'against', example: 'antibiotic' },
                { morpheme: 'auto-', meaning: 'self', example: 'automatic' },
                { morpheme: 'co-', meaning: 'with, together', example: 'cooperate' },
                { morpheme: 'ex-', meaning: 'out of, former', example: 'exit' },
                { morpheme: 'inter-', meaning: 'between', example: 'international' },
                { morpheme: 'non-', meaning: 'not', example: 'nonfiction' },
                { morpheme: 'semi-', meaning: 'half, partly', example: 'semicircle' },
                { morpheme: 'bi-', meaning: 'two', example: 'bicycle' },
                { morpheme: 'tri-', meaning: 'three', example: 'triangle' },
                { morpheme: 'multi-', meaning: 'many', example: 'multiple' },
                { morpheme: 'uni-', meaning: 'one', example: 'unicycle' }
            ],
            suffixes: [
                { morpheme: '-ed', meaning: 'past tense', example: 'walked' },
                { morpheme: '-ing', meaning: 'present participle', example: 'walking' },
                { morpheme: '-er', meaning: 'one who, more', example: 'teacher' },
                { morpheme: '-est', meaning: 'most', example: 'tallest' },
                { morpheme: '-ly', meaning: 'in a way', example: 'quickly' },
                { morpheme: '-tion', meaning: 'act of, state of', example: 'action' },
                { morpheme: '-sion', meaning: 'act of, state of', example: 'decision' },
                { morpheme: '-ness', meaning: 'state of being', example: 'kindness' },
                { morpheme: '-ment', meaning: 'result of action', example: 'movement' },
                { morpheme: '-ful', meaning: 'full of', example: 'helpful' },
                { morpheme: '-less', meaning: 'without', example: 'hopeless' },
                { morpheme: '-able', meaning: 'capable of', example: 'readable' },
                { morpheme: '-ible', meaning: 'capable of', example: 'visible' },
                { morpheme: '-ous', meaning: 'full of', example: 'dangerous' },
                { morpheme: '-al', meaning: 'relating to', example: 'musical' },
                { morpheme: '-ic', meaning: 'relating to', example: 'historic' },
                { morpheme: '-ive', meaning: 'having the quality of', example: 'active' },
                { morpheme: '-y', meaning: 'having the quality of', example: 'rainy' },
                { morpheme: '-ward', meaning: 'in the direction of', example: 'forward' },
                { morpheme: '-ship', meaning: 'state of being', example: 'friendship' }
            ],
            latin: [
                { morpheme: 'port', meaning: 'carry', example: 'transport' },
                { morpheme: 'dict', meaning: 'say, speak', example: 'dictionary' },
                { morpheme: 'spect', meaning: 'look, see', example: 'inspect' },
                { morpheme: 'ject', meaning: 'throw', example: 'project' },
                { morpheme: 'tract', meaning: 'pull, drag', example: 'attract' },
                { morpheme: 'struct', meaning: 'build', example: 'construct' },
                { morpheme: 'rupt', meaning: 'break', example: 'erupt' },
                { morpheme: 'scrib/script', meaning: 'write', example: 'describe' },
                { morpheme: 'vid/vis', meaning: 'see', example: 'video' },
                { morpheme: 'aud', meaning: 'hear', example: 'audio' },
                { morpheme: 'cap/cept', meaning: 'take, seize', example: 'capture' },
                { morpheme: 'mit/miss', meaning: 'send', example: 'transmit' },
                { morpheme: 'ped/pod', meaning: 'foot', example: 'pedal' },
                { morpheme: 'man', meaning: 'hand', example: 'manual' },
                { morpheme: 'duc/duct', meaning: 'lead', example: 'conduct' },
                { morpheme: 'fac/fact', meaning: 'make, do', example: 'factory' },
                { morpheme: 'loc', meaning: 'place', example: 'location' },
                { morpheme: 'mob/mov', meaning: 'move', example: 'mobile' },
                { morpheme: 'terr', meaning: 'earth, land', example: 'territory' },
                { morpheme: 'temp', meaning: 'time', example: 'temporary' }
            ],
            greek: [
                { morpheme: 'bio', meaning: 'life', example: 'biology' },
                { morpheme: 'geo', meaning: 'earth', example: 'geography' },
                { morpheme: 'photo', meaning: 'light', example: 'photograph' },
                { morpheme: 'graph', meaning: 'write, draw', example: 'autograph' },
                { morpheme: 'tele', meaning: 'far, distant', example: 'telephone' },
                { morpheme: 'auto', meaning: 'self', example: 'autobiography' },
                { morpheme: 'micro', meaning: 'small', example: 'microscope' },
                { morpheme: 'macro', meaning: 'large', example: 'macroscope' },
                { morpheme: 'phil', meaning: 'love', example: 'philosophy' },
                { morpheme: 'phon', meaning: 'sound', example: 'microphone' },
                { morpheme: 'scope', meaning: 'see, look', example: 'telescope' },
                { morpheme: 'meter', meaning: 'measure', example: 'thermometer' },
                { morpheme: 'therm', meaning: 'heat', example: 'thermal' },
                { morpheme: 'chron', meaning: 'time', example: 'chronological' },
                { morpheme: 'demo', meaning: 'people', example: 'democracy' },
                { morpheme: 'psych', meaning: 'mind, soul', example: 'psychology' },
                { morpheme: 'log', meaning: 'study, word', example: 'dialogue' },
                { morpheme: 'path', meaning: 'feeling, disease', example: 'sympathy' },
                { morpheme: 'ology', meaning: 'study of', example: 'biology' },
                { morpheme: 'phobia', meaning: 'fear of', example: 'claustrophobia' }
            ]
        };

        let currentMorphemeGame = {
            type: null,
            difficulty: null,
            score: 0,
            streak: 0,
            timeLeft: 60,
            totalProblems: 0,
            correctAnswers: 0,
            problems: [],
            currentProblem: null,
            gameTimer: null
        };

        function playAudio(isCorrect) {
            if (!audioEnabled) return;
            
            try {
                if (isCorrect) {
                    correctAudio.currentTime = 0;
                    correctAudio.play().catch(e => console.log('Audio play failed:', e));
                } else {
                    incorrectAudio.currentTime = 0;
                    incorrectAudio.play().catch(e => console.log('Audio play failed:', e));
                }
            } catch (error) {
                console.log('Audio error:', error);
            }
        }

        function toggleAudio() {
            audioEnabled = !audioEnabled;
            localStorage.setItem('colosseumAudioEnabled', audioEnabled.toString());
            
            const button = document.getElementById('audioToggle');
            if (button) {
                button.textContent = audioEnabled ? '🔊 Audio On' : '🔇 Audio Off';
                button.style.opacity = audioEnabled ? '1' : '0.6';
            }
        }

        // Load audio preference
        function loadAudioPreference() {
            const saved = localStorage.getItem('colosseumAudioEnabled');
            if (saved !== null) {
                audioEnabled = saved === 'true';
            }
        }

        function initializeColosseum() {
            console.log('Initializing Kudos Colosseum');
            loadAudioPreference();
            updateAudioButton();
            resetGame();
        }

        function updateAudioButton() {
            const button = document.getElementById('audioToggle');
            if (button) {
                button.textContent = audioEnabled ? '🔊 Audio On' : '🔇 Audio Off';
                button.style.opacity = audioEnabled ? '1' : '0.6';
            }
        }

        function showAchievements() {
            const modal = document.getElementById('achievementsModal');
            const content = document.getElementById('achievementsContent');
            
            const unlockedAchievements = JSON.parse(localStorage.getItem('colosseumAchievements') || '[]');
            
            let html = '';
            
            Object.entries(colosseumAchievements).forEach(([id, achievement]) => {
                const isUnlocked = unlockedAchievements.includes(id);
                const progressInfo = getAchievementProgress(id);
                
                html += `
                    <div style="background: ${isUnlocked ? 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)' : '#f0f0f0'}; 
                                color: ${isUnlocked ? 'black' : '#666'}; 
                                padding: 15px; 
                                border-radius: 10px; 
                                margin-bottom: 15px;
                                border: ${isUnlocked ? '3px solid gold' : '2px solid #ddd'};">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 2em; ${isUnlocked ? '' : 'filter: grayscale(100%); opacity: 0.5;'}">${achievement.icon}</div>
                            <div style="flex: 1;">
                                <h4 style="margin: 0; ${isUnlocked ? 'color: black;' : 'color: #666;'}">${achievement.title}</h4>
                                <p style="margin: 5px 0; ${isUnlocked ? 'color: #333;' : 'color: #888;'}">${achievement.description}</p>
                                ${progressInfo ? `<p style="margin: 5px 0; font-size: 0.9em; ${isUnlocked ? 'color: #555;' : 'color: #aaa;'}">${progressInfo}</p>` : ''}
                                <p style="margin: 5px 0; font-weight: bold; ${isUnlocked ? 'color: #8B4513;' : 'color: #999;'}">Reward: ${achievement.xpReward} XP</p>
                            </div>
                            <div style="font-size: 1.5em;">
                                ${isUnlocked ? '✅' : '🔒'}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Add overall progress stats
            const totalChallenges = parseInt(localStorage.getItem('colosseum_total_challenges') || '0');
            const totalXP = parseInt(localStorage.getItem('colosseum_total_xp') || '0');
            const multiplicationWins = parseInt(localStorage.getItem('colosseum_multiplication_90plus') || '0');
            const divisionWins = parseInt(localStorage.getItem('colosseum_division_90plus') || '0');
            
            html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                    <h4>🏛️ Your Colosseum Legacy</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
                        <div><strong>Total Battles:</strong><br>${totalChallenges}</div>
                        <div><strong>Total XP Earned:</strong><br>${totalXP}</div>
                        <div><strong>× Mastery Wins:</strong><br>${multiplicationWins}</div>
                        <div><strong>÷ Mastery Wins:</strong><br>${divisionWins}</div>
                    </div>
                </div>
            ` + html;
            
            content.innerHTML = html;
            modal.style.display = 'block';
        }

        function getAchievementProgress(achievementId) {
            switch(achievementId) {
                case 'math_gladiator':
                    const challenges = parseInt(localStorage.getItem('colosseum_total_challenges') || '0');
                    return `Progress: ${challenges}/10 challenges completed`;
                case 'multiplication_champion':
                    const multWins = parseInt(localStorage.getItem('colosseum_multiplication_90plus') || '0');
                    return `Progress: ${multWins}/5 high-accuracy multiplication rounds`;
                case 'division_master':
                    const divWins = parseInt(localStorage.getItem('colosseum_division_90plus') || '0');
                    return `Progress: ${divWins}/5 high-accuracy division rounds`;
                case 'colosseum_legend':
                    const totalXP = parseInt(localStorage.getItem('colosseum_total_xp') || '0');
                    return `Progress: ${totalXP}/1000 XP earned from Colosseum`;
                default:
                    return null;
            }
        }

        function closeAchievementsModal() {
            document.getElementById('achievementsModal').style.display = 'none';
        }

        function startChallenge(type) {
            currentGame.type = type;
            document.querySelector('.challenge-selection').classList.add('hidden');
            
            // Set up difficulty options based on challenge type
            const difficultyContainer = document.getElementById('difficultyOptions');
            const difficultyTitle = document.getElementById('difficultyTitle');
            
            let options = [];
            
            if (type === 'multiplication') {
                difficultyTitle.textContent = 'Choose Multiplication Difficulty';
                options = [
                    { id: 'easy', text: 'Easy (1-5)', points: '2 XP' },
                    { id: 'medium', text: 'Medium (1-10)', points: '4 XP' },
                    { id: 'hard', text: 'Hard (1-12)', points: '10 XP' },
                    { id: 'multiplication15', text: 'Advanced (1-15)', points: '6 XP' },
                    { id: 'multiplication20', text: 'Expert (1-20)', points: '8 XP' },
                    { id: 'multidigit', text: 'Multi-digit Extreme', points: '15 XP' }
                ];
            } else if (type === 'division') {
                difficultyTitle.textContent = 'Choose Division Difficulty';
                options = [
                    { id: 'easy', text: 'Easy (1-5)', points: '2 XP' },
                    { id: 'medium', text: 'Medium (1-10)', points: '4 XP' },
                    { id: 'hard', text: 'Hard (1-12)', points: '10 XP' },
                    { id: 'longdivision', text: 'Long Division', points: '12 XP' }
                ];
            } else { // mixed
                difficultyTitle.textContent = 'Choose Mixed Challenge Difficulty';
                options = [
                    { id: 'easy', text: 'Easy (1-5)', points: '2 XP' },
                    { id: 'medium', text: 'Medium (1-10)', points: '4 XP' },
                    { id: 'hard', text: 'Hard (1-12)', points: '10 XP' }
                ];
            }
            
            // Generate HTML for difficulty buttons
            difficultyContainer.innerHTML = options.map(option => 
                `<button class="difficulty-btn" onclick="startGame('${option.id}')">
                    ${option.text}<br><small style="color: #888;">${option.points}</small>
                </button>`
            ).join('');
            
            document.getElementById('difficultySelector').classList.remove('hidden');
        }

        function startGame(difficulty) {
            currentGame.difficulty = difficulty;
            currentGame.score = 0;
            currentGame.streak = 0;
            currentGame.timeLeft = 60;
            currentGame.totalProblems = 0;
            currentGame.correctAnswers = 0;
            
            // Hide difficulty selector and show game area
            document.getElementById('difficultySelector').classList.add('hidden');
            document.getElementById('gameArea').classList.remove('hidden');
            
            // Set up difficulty ranges and problem types
            let maxNumber, problemConfig;
            switch(difficulty) {
                case 'easy': 
                    maxNumber = 5; 
                    problemConfig = { type: 'basic', max: 5 };
                    break;
                case 'medium': 
                    maxNumber = 10; 
                    problemConfig = { type: 'basic', max: 10 };
                    break;
                case 'hard': 
                    maxNumber = 12; 
                    problemConfig = { type: 'basic', max: 12 };
                    break;
                case 'multiplication15':
                    maxNumber = 15;
                    problemConfig = { type: 'multiplication', max: 15 };
                    break;
                case 'multiplication20':
                    maxNumber = 20;
                    problemConfig = { type: 'multiplication', max: 20 };
                    break;
                case 'multidigit':
                    maxNumber = 99;
                    problemConfig = { type: 'multidigit', max: 99 };
                    break;
                case 'longdivision':
                    maxNumber = 12;
                    problemConfig = { type: 'longdivision', max: 12 };
                    break;
                default: 
                    maxNumber = 10;
                    problemConfig = { type: 'basic', max: 10 };
            }
            
            // Generate problems for the session
            generateProblems(problemConfig);
            
            // Start the game
            nextProblem();
            startTimer();
            
            // Focus on answer input
            document.getElementById('answerInput').focus();
        }

        function generateProblems(problemConfig) {
            currentGame.problems = [];
            
            // Generate 20 problems for the session
            for(let i = 0; i < 20; i++) {
                let problem = createProblem(problemConfig);
                currentGame.problems.push(problem);
            }
        }

        function createProblem(config) {
            let num1, num2, operation, answer, displayText;
            
            switch(config.type) {
                case 'basic':
                    num1 = Math.floor(Math.random() * config.max) + 1;
                    num2 = Math.floor(Math.random() * config.max) + 1;
                    
                    if (currentGame.type === 'multiplication') {
                        operation = '×';
                        answer = num1 * num2;
                    } else if (currentGame.type === 'division') {
                        // For division, make sure we get whole number answers
                        answer = num1;
                        num1 = num1 * num2;
                        operation = '÷';
                    } else { // mixed
                        if (Math.random() < 0.5) {
                            operation = '×';
                            answer = num1 * num2;
                        } else {
                            // Division with whole number answer
                            answer = num1;
                            num1 = num1 * num2;
                            operation = '÷';
                        }
                    }
                    displayText = `${num1} ${operation} ${num2} = ?`;
                    break;
                    
                case 'multiplication':
                    num1 = Math.floor(Math.random() * config.max) + 1;
                    num2 = Math.floor(Math.random() * config.max) + 1;
                    operation = '×';
                    answer = num1 * num2;
                    displayText = `${num1} × ${num2} = ?`;
                    break;
                    
                case 'multidigit':
                    // Generate 2-digit numbers for extreme multiplication
                    num1 = Math.floor(Math.random() * 90) + 10; // 10-99
                    num2 = Math.floor(Math.random() * 90) + 10; // 10-99
                    operation = '×';
                    answer = num1 * num2;
                    displayText = `${num1} × ${num2} = ?`;
                    break;
                    
                case 'longdivision':
                    // Create long division problems with 2-digit dividends and 1-digit divisors
                    num2 = Math.floor(Math.random() * 9) + 2; // divisor 2-10
                    let quotient = Math.floor(Math.random() * config.max) + 1; // 1-12
                    num1 = num2 * quotient; // dividend (ensures whole number answer)
                    operation = '÷';
                    answer = quotient;
                    displayText = `${num1} ÷ ${num2} = ?`;
                    break;
                    
                default:
                    num1 = Math.floor(Math.random() * config.max) + 1;
                    num2 = Math.floor(Math.random() * config.max) + 1;
                    operation = '×';
                    answer = num1 * num2;
                    displayText = `${num1} × ${num2} = ?`;
            }
            
            return {
                num1: num1,
                num2: num2,
                operation: operation,
                answer: answer,
                displayText: displayText
            };
        }

        function nextProblem() {
            if (currentGame.totalProblems >= currentGame.problems.length || currentGame.timeLeft <= 0) {
                endGame();
                return;
            }
            
            currentGame.currentProblem = currentGame.problems[currentGame.totalProblems];
            
            // Display the problem using the preformatted displayText or fallback
            const problemText = currentGame.currentProblem.displayText || 
                `${currentGame.currentProblem.num1} ${currentGame.currentProblem.operation} ${currentGame.currentProblem.num2} = ?`;
            document.getElementById('problem').textContent = problemText;
            
            // Clear previous answer and feedback
            document.getElementById('answerInput').value = '';
            document.getElementById('feedback').innerHTML = '';
            
            // Focus on input
            document.getElementById('answerInput').focus();
        }

        function submitAnswer() {
            const userAnswer = parseInt(document.getElementById('answerInput').value);
            const correctAnswer = currentGame.currentProblem.answer;
            
            currentGame.totalProblems++;
            
            if (userAnswer === correctAnswer) {
                // Correct answer!
                playAudio(true); // Play success sound
                
                currentGame.correctAnswers++;
                currentGame.streak++;
                
                // Difficulty-based base points
                let points;
                switch(currentGame.difficulty) {
                    case 'easy': points = 2; break;
                    case 'medium': points = 4; break;
                    case 'hard': points = 10; break;
                    case 'multiplication15': points = 6; break;
                    case 'multiplication20': points = 8; break;
                    case 'multidigit': points = 15; break;
                    case 'longdivision': points = 12; break;
                    default: points = 4;
                }
                
                // Small bonus points for streak (much smaller than before)
                if (currentGame.streak >= 5) points += 1;
                if (currentGame.streak >= 10) points += 2;
                
                currentGame.score += points;
                
                document.getElementById('feedback').innerHTML = `
                    <span class="correct-feedback">✅ Correct! +${points} XP</span>
                `;
                
                // Visual celebration for streaks
                if (currentGame.streak >= 5) {
                    document.getElementById('feedback').innerHTML += `<br><span style="color: gold;">🔥 ${currentGame.streak} streak bonus!</span>`;
                }
                
                // Check for streak achievement
                if (currentGame.streak >= 10) {
                    checkAchievement('streak_master');
                }
                
            } else {
                // Wrong answer
                playAudio(false); // Play failure sound
                
                currentGame.streak = 0;
                document.getElementById('feedback').innerHTML = `
                    <span class="incorrect-feedback">❌ Incorrect. The answer was ${correctAnswer}</span>
                `;
            }
            
            // Update display
            updateGameStats();
            
            // Move to next problem after a short delay
            setTimeout(() => {
                nextProblem();
            }, 1500);
        }

        function updateGameStats() {
            document.getElementById('currentScore').textContent = currentGame.score;
            document.getElementById('timeLeft').textContent = currentGame.timeLeft;
            document.getElementById('streak').textContent = currentGame.streak;
        }

        function startTimer() {
            currentGame.gameTimer = setInterval(() => {
                currentGame.timeLeft--;
                updateGameStats();
                
                if (currentGame.timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function endGame() {
            // Stop timer
            if (currentGame.gameTimer) {
                clearInterval(currentGame.gameTimer);
                currentGame.gameTimer = null;
            }
            
            // Calculate final stats
            const accuracy = currentGame.totalProblems > 0 ? 
                Math.round((currentGame.correctAnswers / currentGame.totalProblems) * 100) : 0;
            
            // Bonus XP for performance (reduced)
            let bonusXP = 0;
            if (accuracy >= 90) bonusXP += 3;
            else if (accuracy >= 80) bonusXP += 2;
            else if (accuracy >= 70) bonusXP += 1;
            
            // Perfect round bonus (reduced)
            if (accuracy === 100) bonusXP += 2;
            
            const finalXP = currentGame.score + bonusXP;
            
            // Check for achievements
            let achievementXP = 0;
            const newAchievements = [];
            
            // First victory achievement
            if (!hasAchievement('first_victory')) {
                newAchievements.push('first_victory');
                achievementXP += colosseumAchievements['first_victory'].xpReward;
            }
            
            // Perfect warrior achievement
            if (accuracy === 100 && !hasAchievement('perfect_warrior')) {
                newAchievements.push('perfect_warrior');
                achievementXP += colosseumAchievements['perfect_warrior'].xpReward;
            }
            
            // Speed demon achievement (45+ seconds remaining)
            if (currentGame.timeLeft >= 45 && !hasAchievement('speed_demon')) {
                newAchievements.push('speed_demon');
                achievementXP += colosseumAchievements['speed_demon'].xpReward;
            }
            
            // Check operation-specific achievements
            checkOperationAchievements(accuracy);
            
            // Update achievement counters
            updateAchievementProgress();
            
            // Total XP including achievements
            const totalXP = finalXP + achievementXP;
            
            // Hide game area and show results
            document.getElementById('gameArea').classList.add('hidden');
            document.getElementById('gameResults').classList.remove('hidden');
            
            // Build achievements display
            let achievementsHTML = '';
            if (newAchievements.length > 0) {
                achievementsHTML = `
                    <div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: black; padding: 15px; border-radius: 10px; margin: 15px 0;">
                        <h4>🏆 New Achievements Unlocked!</h4>
                        ${newAchievements.map(id => {
                            const achievement = colosseumAchievements[id];
                            return `<p><strong>${achievement.icon} ${achievement.title}</strong><br><small>${achievement.description}</small><br><span style="color: #8B4513;">+${achievement.xpReward} XP Bonus!</span></p>`;
                        }).join('')}
                    </div>
                `;
                
                // Save new achievements
                newAchievements.forEach(id => unlockAchievement(id));
            }
            
            // Display results
            document.getElementById('resultsDisplay').innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h4>🏛️ Battle Results</h4>
                    <p><strong>Problems Solved:</strong> ${currentGame.correctAnswers}/${currentGame.totalProblems}</p>
                    <p><strong>Accuracy:</strong> ${accuracy}%</p>
                    <p><strong>Time Remaining:</strong> ${currentGame.timeLeft} seconds</p>
                    <p><strong>Best Streak:</strong> ${Math.max(...Array(currentGame.totalProblems).fill(0).map((_, i) => 
                        i < currentGame.correctAnswers ? currentGame.streak : 0))} in a row</p>
                    <p><strong>Base XP:</strong> ${currentGame.score}</p>
                    <p><strong>Performance Bonus:</strong> +${bonusXP} XP</p>
                    ${achievementXP > 0 ? `<p><strong>Achievement Bonus:</strong> +${achievementXP} XP</p>` : ''}
                    <h3 style="color: gold;">Total XP Earned: ${totalXP} ⭐</h3>
                </div>
                
                ${achievementsHTML}
                
                <div style="margin: 20px 0;">
                    ${accuracy >= 90 ? '🏆 Outstanding performance!' : 
                      accuracy >= 80 ? '🥇 Great job!' : 
                      accuracy >= 70 ? '🥈 Good effort!' : 
                      '🥉 Keep practicing!'}
                </div>
            `;
            
            // Award XP to student
            awardColosseumXP(totalXP);
        }

        // ===============================
        // ACHIEVEMENT SYSTEM
        // ===============================
        
        function hasAchievement(achievementId) {
            const achievements = JSON.parse(localStorage.getItem('colosseumAchievements') || '[]');
            return achievements.includes(achievementId);
        }
        
        function unlockAchievement(achievementId) {
            const achievements = JSON.parse(localStorage.getItem('colosseumAchievements') || '[]');
            if (!achievements.includes(achievementId)) {
                achievements.push(achievementId);
                localStorage.setItem('colosseumAchievements', JSON.stringify(achievements));
                
                // Show achievement notification
                showAchievementNotification(achievementId);
            }
        }
        
        function checkAchievement(achievementId) {
            if (!hasAchievement(achievementId)) {
                unlockAchievement(achievementId);
                return true;
            }
            return false;
        }
        
        function showAchievementNotification(achievementId) {
            const achievement = colosseumAchievements[achievementId];
            if (!achievement) return;
            
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
                color: black;
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 10000;
                min-width: 300px;
                animation: slideIn 0.5s ease-out;
                font-weight: bold;
            `;
            
            notification.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 2em; margin-bottom: 10px;">${achievement.icon}</div>
                    <div style="font-size: 1.2em; margin-bottom: 5px;">Achievement Unlocked!</div>
                    <div style="font-size: 1.1em; margin-bottom: 5px;">${achievement.title}</div>
                    <div style="font-size: 0.9em; opacity: 0.8;">${achievement.description}</div>
                    <div style="color: #8B4513; margin-top: 10px;">+${achievement.xpReward} XP Bonus!</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 4 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.5s ease-out';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 4000);
        }
        
        function checkOperationAchievements(accuracy) {
            if (accuracy >= 90) {
                const gameType = currentGame.type;
                const counterKey = `colosseum_${gameType}_90plus`;
                let count = parseInt(localStorage.getItem(counterKey) || '0') + 1;
                localStorage.setItem(counterKey, count.toString());
                
                // Check for operation-specific achievements
                if (gameType === 'multiplication' && count >= 5 && !hasAchievement('multiplication_champion')) {
                    unlockAchievement('multiplication_champion');
                } else if (gameType === 'division' && count >= 5 && !hasAchievement('division_master')) {
                    unlockAchievement('division_master');
                }
            }
        }
        
        function updateAchievementProgress() {
            // Update total challenges counter
            const totalChallenges = parseInt(localStorage.getItem('colosseum_total_challenges') || '0') + 1;
            localStorage.setItem('colosseum_total_challenges', totalChallenges.toString());
            
            // Check for challenge-based achievements
            if (totalChallenges >= 10 && !hasAchievement('math_gladiator')) {
                unlockAchievement('math_gladiator');
            }
            
            // Update total XP earned from Colosseum
            const totalColosseumXP = parseInt(localStorage.getItem('colosseum_total_xp') || '0') + currentGame.score;
            localStorage.setItem('colosseum_total_xp', totalColosseumXP.toString());
            
            // Check for XP-based achievements
            if (totalColosseumXP >= 1000 && !hasAchievement('colosseum_legend')) {
                unlockAchievement('colosseum_legend');
            }
        }

        async function awardColosseumXP(xpAmount) {
            try {
                // Add XP to separate XP system (NOT kudos points)
                const studentXPKey = `student_xp_${currentStudent.id}`;
                const currentXP = parseInt(localStorage.getItem(studentXPKey)) || 0;
                const newTotalXP = currentXP + xpAmount;
                localStorage.setItem(studentXPKey, newTotalXP.toString());
                
                console.log(`Awarding ${xpAmount} Colosseum XP. Previous XP: ${currentXP}, New XP total: ${newTotalXP}`);
                
                // DO NOT update database kudos points - games should only affect XP
                // The database points should remain unchanged (only teacher kudos affect those)
                
                console.log(`Kudos Colosseum: Awarded ${xpAmount} XP to ${currentStudent.name}. Total XP: ${newTotalXP}`);
                
                // Update XP display immediately with the new XP total (not kudos total)
                updateXPDisplay(newTotalXP);
                
                // Force immediate visual update of XP elements
                setTimeout(() => {
                    console.log('Force updating XP display after short delay...');
                    updateXPDisplay(newTotalXP);
                }, 100);
                
                // Check for level up
                const newLevel = calculateLevel(newTotalXP);
                const oldLevel = calculateLevel(newTotalXP - xpAmount);
                
                if (newLevel > oldLevel) {
                    showLevelUpNotification(newLevel);
                }
                
            } catch (error) {
                console.error('Error awarding Colosseum XP:', error);
            }
        }

        function resetGame() {
            // Stop any running timer
            if (currentGame.gameTimer) {
                clearInterval(currentGame.gameTimer);
                currentGame.gameTimer = null;
            }
            
            // Reset game state
            currentGame = {
                type: null,
                difficulty: null,
                score: 0,
                streak: 0,
                timeLeft: 60,
                currentProblem: null,
                totalProblems: 0,
                correctAnswers: 0,
                gameTimer: null,
                problems: []
            };
            
            // Show initial selection screen
            document.querySelector('.challenge-selection').classList.remove('hidden');
            document.getElementById('difficultySelector').classList.add('hidden');
            document.getElementById('gameArea').classList.add('hidden');
            document.getElementById('gameResults').classList.add('hidden');
        }

        // Add Enter key support for answer submission
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listener for Enter key in answer input
            document.addEventListener('keydown', function(event) {
                if (event.target.id === 'answerInput' && event.key === 'Enter') {
                    event.preventDefault();
                    submitAnswer();
                }
            });
        });

        function logout() {
            // Clear current session
            currentStudent = null;
            currentClass = null;
            currentStudentCode = null;
            currentLevel = 1;
            currentXP = 0;
            lastKudosCount = 0;
            
            // Clear session storage
            clearSession();
            
            // Reset form
            document.getElementById('loginForm').reset();
            
            // Show login, hide dashboard
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('dashboardSection').classList.add('hidden');
            
            // Clear any error messages
            document.getElementById('errorMessage').style.display = 'none';
            
            // Reset to dashboard tab
            showSection('dashboard');
            
            console.log('Logged out successfully');
        }

        // Debug function for development
        window.debugStudentPortal = function() {
            console.log('Current Student:', currentStudent);
            console.log('Current Class:', currentClass);
            console.log('Current Student Code:', currentStudentCode);
            console.log('Current Level:', currentLevel);
            console.log('Current XP:', currentXP);
            console.log('Selected Avatar:', selectedAvatar);
        };

        // Connection monitoring for Chromebook diagnostics
        function monitorConnection() {
            const statusElement = document.getElementById('connection-status');
            
            function updateConnectionStatus() {
                const isOnline = navigator.onLine;
                const connectionType = navigator.connection ? navigator.connection.effectiveType : 'unknown';
                const downlink = navigator.connection ? navigator.connection.downlink : 'unknown';
                
                if (statusElement) {
                    statusElement.innerHTML = `
                        <span style="color: ${isOnline ? '#4CAF50' : '#f44336'}">
                            ${isOnline ? '🟢' : '🔴'} ${isOnline ? 'Online' : 'Offline'}
                        </span>
                        ${connectionType !== 'unknown' ? ` | Speed: ${connectionType}` : ''}
                        ${downlink !== 'unknown' ? ` | Bandwidth: ${downlink}Mbps` : ''}
                    `;
                }
                
                console.log('Connection Status:', {
                    online: isOnline,
                    type: connectionType,
                    downlink: downlink,
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    timestamp: new Date().toISOString()
                });
            }
            
            // Update status immediately
            updateConnectionStatus();
            
            // Monitor connection changes
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
            
            // Monitor connection type changes (if supported)
            if (navigator.connection) {
                navigator.connection.addEventListener('change', updateConnectionStatus);
            }
            
            // Periodic status check
            setInterval(updateConnectionStatus, 30000); // Every 30 seconds
        }

        // Performance monitoring for slow connections
        function measureNetworkPerformance() {
            const startTime = performance.now();
            
            // Test with a small image request
            const img = new Image();
            img.onload = function() {
                const loadTime = performance.now() - startTime;
                console.log('Network performance test:', {
                    loadTime: `${loadTime.toFixed(2)}ms`,
                    status: loadTime < 1000 ? 'Good' : loadTime < 3000 ? 'Fair' : 'Poor',
                    timestamp: new Date().toISOString()
                });
            };
            img.onerror = function() {
                console.log('Network performance test failed:', {
                    error: 'Image load failed',
                    timestamp: new Date().toISOString()
                });
            };
            img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; // 1x1 transparent gif
        }

        // Initialize monitoring when page loads
        document.addEventListener('DOMContentLoaded', function() {
            monitorConnection();
            measureNetworkPerformance();
            
            // Test network performance every 5 minutes
            setInterval(measureNetworkPerformance, 300000);
        });

        // ===============================
        // MORPHEME MASTERY GAME FUNCTIONS
        // ===============================

        function startMorphemeChallenge(type) {
            currentMorphemeGame.type = type;
            document.querySelector('.morpheme-selection').classList.add('hidden');
            
            // Set up difficulty options based on challenge type
            const difficultyContainer = document.getElementById('morphemeDifficultyOptions');
            const difficultyTitle = document.getElementById('morphemeDifficultyTitle');
            
            let options = [];
            let titleText = '';
            
            switch(type) {
                case 'prefixes':
                    titleText = 'Choose Prefix Difficulty';
                    options = [
                        { id: 'easy', text: 'Basic Prefixes (10 questions)', points: '3 XP' },
                        { id: 'medium', text: 'Advanced Prefixes (15 questions)', points: '4 XP' },
                        { id: 'hard', text: 'All Prefixes (20 questions)', points: '5 XP' }
                    ];
                    break;
                case 'suffixes':
                    titleText = 'Choose Suffix Difficulty';
                    options = [
                        { id: 'easy', text: 'Basic Suffixes (10 questions)', points: '3 XP' },
                        { id: 'medium', text: 'Advanced Suffixes (15 questions)', points: '4 XP' },
                        { id: 'hard', text: 'All Suffixes (20 questions)', points: '5 XP' }
                    ];
                    break;
                case 'latin':
                    titleText = 'Choose Latin Roots Difficulty';
                    options = [
                        { id: 'easy', text: 'Basic Latin Roots (10 questions)', points: '4 XP' },
                        { id: 'medium', text: 'Advanced Latin Roots (15 questions)', points: '6 XP' },
                        { id: 'hard', text: 'All Latin Roots (20 questions)', points: '8 XP' }
                    ];
                    break;
                case 'greek':
                    titleText = 'Choose Greek Roots Difficulty';
                    options = [
                        { id: 'easy', text: 'Basic Greek Roots (10 questions)', points: '4 XP' },
                        { id: 'medium', text: 'Advanced Greek Roots (15 questions)', points: '6 XP' },
                        { id: 'hard', text: 'All Greek Roots (20 questions)', points: '8 XP' }
                    ];
                    break;
                case 'mixed':
                    titleText = 'Choose Mixed Challenge Difficulty';
                    options = [
                        { id: 'easy', text: 'Mixed Easy (15 questions)', points: '5 XP' },
                        { id: 'medium', text: 'Mixed Advanced (20 questions)', points: '7 XP' },
                        { id: 'hard', text: 'Mixed Expert (25 questions)', points: '10 XP' }
                    ];
                    break;
            }
            
            difficultyTitle.textContent = titleText;
            
            // Generate HTML for difficulty buttons
            difficultyContainer.innerHTML = options.map(option => 
                `<button class="difficulty-btn" onclick="startMorphemeGame('${option.id}')">
                    ${option.text}<br><small style="color: #888;">${option.points}</small>
                </button>`
            ).join('');
            
            document.getElementById('morphemeDifficultySelector').classList.remove('hidden');
        }

        function startMorphemeGame(difficulty) {
            currentMorphemeGame.difficulty = difficulty;
            currentMorphemeGame.score = 0;
            currentMorphemeGame.streak = 0;
            currentMorphemeGame.timeLeft = 90; // 90 seconds for reading comprehension
            currentMorphemeGame.totalProblems = 0;
            currentMorphemeGame.correctAnswers = 0;
            
            // Hide difficulty selector and show game area
            document.getElementById('morphemeDifficultySelector').classList.add('hidden');
            document.getElementById('morphemeGameArea').classList.remove('hidden');
            
            // Generate problems based on type and difficulty
            generateMorphemeProblems();
            
            // Start the game
            nextMorphemeProblem();
            startMorphemeTimer();
        }

        function generateMorphemeProblems() {
            currentMorphemeGame.problems = [];
            
            let sourceData = [];
            let numProblems = 15;
            
            // Determine source data and number of problems
            switch(currentMorphemeGame.difficulty) {
                case 'easy':
                    numProblems = 10;
                    break;
                case 'medium':
                    numProblems = 15;
                    break;
                case 'hard':
                    numProblems = 20;
                    break;
            }
            
            // Get source data based on challenge type
            if (currentMorphemeGame.type === 'mixed') {
                numProblems = currentMorphemeGame.difficulty === 'easy' ? 15 : 
                             currentMorphemeGame.difficulty === 'medium' ? 20 : 25;
                sourceData = [
                    ...morphemeData.prefixes.slice(0, 10),
                    ...morphemeData.suffixes.slice(0, 10),
                    ...morphemeData.latin.slice(0, 10),
                    ...morphemeData.greek.slice(0, 10)
                ];
            } else {
                sourceData = morphemeData[currentMorphemeGame.type];
                if (currentMorphemeGame.difficulty === 'easy') {
                    sourceData = sourceData.slice(0, Math.min(10, sourceData.length));
                } else if (currentMorphemeGame.difficulty === 'medium') {
                    sourceData = sourceData.slice(0, Math.min(15, sourceData.length));
                }
            }
            
            // Generate problems
            for (let i = 0; i < numProblems; i++) {
                const problem = createMorphemeProblem(sourceData);
                currentMorphemeGame.problems.push(problem);
            }
        }

        function createMorphemeProblem(sourceData) {
            // Choose a random morpheme for the correct answer
            const correctMorpheme = sourceData[Math.floor(Math.random() * sourceData.length)];
            
            // Randomly choose question type
            const questionTypes = ['meaning-to-morpheme', 'morpheme-to-meaning'];
            const questionType = questionTypes[Math.floor(Math.random() * questionTypes.length)];
            
            let question, correctAnswer, options;
            
            if (questionType === 'meaning-to-morpheme') {
                question = `Which morpheme means "${correctMorpheme.meaning}"?`;
                correctAnswer = correctMorpheme.morpheme;
                
                // Create 3 wrong options
                const wrongOptions = [];
                while (wrongOptions.length < 3) {
                    const randomMorpheme = sourceData[Math.floor(Math.random() * sourceData.length)];
                    if (randomMorpheme.morpheme !== correctMorpheme.morpheme && 
                        !wrongOptions.includes(randomMorpheme.morpheme)) {
                        wrongOptions.push(randomMorpheme.morpheme);
                    }
                }
                options = [correctAnswer, ...wrongOptions];
            } else {
                question = `What does the morpheme "${correctMorpheme.morpheme}" mean?`;
                correctAnswer = correctMorpheme.meaning;
                
                // Create 3 wrong options
                const wrongOptions = [];
                while (wrongOptions.length < 3) {
                    const randomMorpheme = sourceData[Math.floor(Math.random() * sourceData.length)];
                    if (randomMorpheme.meaning !== correctMorpheme.meaning && 
                        !wrongOptions.includes(randomMorpheme.meaning)) {
                        wrongOptions.push(randomMorpheme.meaning);
                    }
                }
                options = [correctAnswer, ...wrongOptions];
            }
            
            // Shuffle options
            options.sort(() => Math.random() - 0.5);
            
            return {
                question: question,
                correctAnswer: correctAnswer,
                options: options,
                example: correctMorpheme.example,
                morpheme: correctMorpheme.morpheme
            };
        }

        function nextMorphemeProblem() {
            if (currentMorphemeGame.totalProblems >= currentMorphemeGame.problems.length || 
                currentMorphemeGame.timeLeft <= 0) {
                endMorphemeGame();
                return;
            }
            
            currentMorphemeGame.currentProblem = currentMorphemeGame.problems[currentMorphemeGame.totalProblems];
            
            // Display the question
            document.getElementById('morphemeQuestion').innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 10px;">
                        ${currentMorphemeGame.currentProblem.question}
                    </div>
                    <div style="font-size: 0.9em; color: #666;">
                        Example word: <strong>${currentMorphemeGame.currentProblem.example}</strong>
                    </div>
                </div>
            `;
            
            // Display multiple choice options
            const choicesHTML = currentMorphemeGame.currentProblem.options.map((option, index) => 
                `<button class="choice-btn" onclick="selectMorphemeAnswer('${option}')" 
                         style="padding: 15px; border: 2px solid #ddd; border-radius: 8px; 
                                background: white; cursor: pointer; font-size: 1.1em;">
                    ${option}
                </button>`
            ).join('');
            
            document.getElementById('morphemeChoices').innerHTML = choicesHTML;
            
            // Clear previous feedback
            document.getElementById('morphemeFeedback').innerHTML = '';
            
            // Update game stats
            updateMorphemeGameStats();
        }

        function selectMorphemeAnswer(selectedAnswer) {
            const correctAnswer = currentMorphemeGame.currentProblem.correctAnswer;
            currentMorphemeGame.totalProblems++;
            
            if (selectedAnswer === correctAnswer) {
                // Correct answer!
                currentMorphemeGame.correctAnswers++;
                currentMorphemeGame.streak++;
                
                // Difficulty-based points
                let points;
                switch(currentMorphemeGame.difficulty) {
                    case 'easy': points = currentMorphemeGame.type === 'prefixes' || currentMorphemeGame.type === 'suffixes' ? 3 : 4; break;
                    case 'medium': points = currentMorphemeGame.type === 'prefixes' || currentMorphemeGame.type === 'suffixes' ? 4 : 6; break;
                    case 'hard': points = currentMorphemeGame.type === 'prefixes' || currentMorphemeGame.type === 'suffixes' ? 5 : 8; break;
                    default: points = 5;
                }
                
                if (currentMorphemeGame.type === 'mixed') {
                    points = currentMorphemeGame.difficulty === 'easy' ? 5 : 
                             currentMorphemeGame.difficulty === 'medium' ? 7 : 10;
                }
                
                // Streak bonus
                if (currentMorphemeGame.streak >= 5) points += 1;
                if (currentMorphemeGame.streak >= 10) points += 2;
                
                currentMorphemeGame.score += points;
                
                document.getElementById('morphemeFeedback').innerHTML = `
                    <span style="color: green; font-weight: bold;">✅ Correct! +${points} XP</span>
                    ${currentMorphemeGame.streak >= 5 ? `<br><span style="color: gold;">🔥 ${currentMorphemeGame.streak} streak bonus!</span>` : ''}
                `;
                
            } else {
                // Wrong answer
                currentMorphemeGame.streak = 0;
                document.getElementById('morphemeFeedback').innerHTML = `
                    <span style="color: red; font-weight: bold;">❌ Incorrect</span>
                    <br><span style="color: #666;">Correct answer: <strong>${correctAnswer}</strong></span>
                `;
            }
            
            // Disable all choice buttons
            const choiceBtns = document.querySelectorAll('.choice-btn');
            choiceBtns.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent.trim() === correctAnswer) {
                    btn.style.background = '#d4edda';
                    btn.style.borderColor = '#28a745';
                } else if (btn.textContent.trim() === selectedAnswer && selectedAnswer !== correctAnswer) {
                    btn.style.background = '#f8d7da';
                    btn.style.borderColor = '#dc3545';
                }
            });
            
            // Continue to next problem after delay
            setTimeout(() => {
                nextMorphemeProblem();
            }, 2500);
        }

        function updateMorphemeGameStats() {
            document.getElementById('morphemeCurrentScore').textContent = currentMorphemeGame.score;
            document.getElementById('morphemeTimeLeft').textContent = currentMorphemeGame.timeLeft;
            document.getElementById('morphemeStreak').textContent = currentMorphemeGame.streak;
        }

        function startMorphemeTimer() {
            currentMorphemeGame.gameTimer = setInterval(() => {
                currentMorphemeGame.timeLeft--;
                updateMorphemeGameStats();
                
                if (currentMorphemeGame.timeLeft <= 0) {
                    endMorphemeGame();
                }
            }, 1000);
        }

        function endMorphemeGame() {
            // Stop timer
            if (currentMorphemeGame.gameTimer) {
                clearInterval(currentMorphemeGame.gameTimer);
                currentMorphemeGame.gameTimer = null;
            }
            
            // Calculate final stats
            const accuracy = currentMorphemeGame.totalProblems > 0 ? 
                Math.round((currentMorphemeGame.correctAnswers / currentMorphemeGame.totalProblems) * 100) : 0;
            
            // Bonus XP for performance
            let bonusXP = 0;
            if (accuracy >= 90) bonusXP += 3;
            else if (accuracy >= 80) bonusXP += 2;
            else if (accuracy >= 70) bonusXP += 1;
            
            const finalXP = currentMorphemeGame.score + bonusXP;
            
            // Hide game area and show results
            document.getElementById('morphemeGameArea').classList.add('hidden');
            document.getElementById('morphemeGameResults').classList.remove('hidden');
            
            // Display results
            document.getElementById('morphemeResultsDisplay').innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h4>📚 Challenge Results</h4>
                    <p><strong>Questions Answered:</strong> ${currentMorphemeGame.correctAnswers}/${currentMorphemeGame.totalProblems}</p>
                    <p><strong>Accuracy:</strong> ${accuracy}%</p>
                    <p><strong>Time Remaining:</strong> ${currentMorphemeGame.timeLeft} seconds</p>
                    <p><strong>Best Streak:</strong> ${currentMorphemeGame.streak}</p>
                    <p><strong>Base XP:</strong> ${currentMorphemeGame.score}</p>
                    <p><strong>Performance Bonus:</strong> +${bonusXP} XP</p>
                    <h3 style="color: gold;">Total XP Earned: ${finalXP} ⭐</h3>
                </div>
                
                <div style="margin: 20px 0;">
                    ${accuracy >= 90 ? '🏆 Outstanding vocabulary mastery!' : 
                      accuracy >= 80 ? '🥇 Great morpheme knowledge!' : 
                      accuracy >= 70 ? '🥈 Good understanding!' : 
                      '🥉 Keep studying those word parts!'}
                </div>
            `;
            
            // Award XP to student
            awardMorphemeXP(finalXP);
        }

        async function awardMorphemeXP(xpAmount) {
            try {
                // Add XP to separate XP system (NOT kudos points)
                const studentXPKey = `student_xp_${currentStudent.id}`;
                const currentXP = parseInt(localStorage.getItem(studentXPKey)) || 0;
                const newTotalXP = currentXP + xpAmount;
                localStorage.setItem(studentXPKey, newTotalXP.toString());
                
                console.log(`Awarding ${xpAmount} Morpheme XP. Previous XP: ${currentXP}, New XP total: ${newTotalXP}`);
                
                // DO NOT update database kudos points - games should only affect XP
                // The database points should remain unchanged (only teacher kudos affect those)
                
                console.log(`Morpheme Mastery: Awarded ${xpAmount} XP to ${currentStudent.name}. Total XP: ${newTotalXP}`);
                
                // Update XP display immediately with the new XP total (not kudos total)
                updateXPDisplay(newTotalXP);
                
                // Check for level up
                const newLevel = calculateLevel(newTotalXP);
                const oldLevel = calculateLevel(newTotalXP - xpAmount);
                
                if (newLevel > oldLevel) {
                    showLevelUpNotification(oldLevel, newLevel);
                }
                
            } catch (error) {
                console.error('Error awarding Morpheme XP:', error);
            }
        }

        function resetMorphemeGame() {
            // Reset game state
            currentMorphemeGame = {
                type: null,
                difficulty: null,
                score: 0,
                streak: 0,
                timeLeft: 90,
                totalProblems: 0,
                correctAnswers: 0,
                problems: [],
                currentProblem: null,
                gameTimer: null
            };
            
            // Show selection screen
            document.getElementById('morphemeGameResults').classList.add('hidden');
            document.querySelector('.morpheme-selection').classList.remove('hidden');
        }

    </script>
</body>
</html>
